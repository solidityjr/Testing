"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8791],{9600:function(e,t,s){var r,i,n,o,a,c,h,l,u,d,f,p,m,g,b,_,y,w,S,v,E,x,A,P,k,C,O,j,I,N,M,R,T,$,U,q,F,L,B,D,H,J,z,G,K,V,W,Y,X,Q,Z,ee,et,es,er,ei,en,eo,ea,ec,eh,el;let eu;s.d(t,{$j:function(){return s$},bq:function(){return eD}});let ed=new Uint8Array(0),ef=new TextEncoder,ep=new TextDecoder;function em(...e){let t=[];for(let s=0;s<e.length;s++)t.push(ef.encode(e[s]));return 0===t.length?ed:1===t.length?t[0]:function(...e){let t=0;for(let s=0;s<e.length;s++)t+=e[s].length;let s=new Uint8Array(t),r=0;for(let t=0;t<e.length;t++)s.set(e[t],r),r+=e[t].length;return s}(...t)}function eg(e){return e&&0!==e.length?ep.decode(e):""}let eb="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";class e_{buf;seq;inc;inited;constructor(){this.buf=new Uint8Array(22),this.inited=!1}init(){this.inited=!0,this.setPre(),this.initSeqAndInc(),this.fillSeq()}initSeqAndInc(){this.seq=Math.floor(0xcfd41b9100000*Math.random()),this.inc=Math.floor(300*Math.random()+33)}setPre(){let e=new Uint8Array(12);globalThis?.crypto?.getRandomValues?globalThis.crypto.getRandomValues(e):function(e){for(let t=0;t<e.length;t++)e[t]=Math.floor(255*Math.random())}(e);for(let t=0;t<12;t++){let s=e[t]%36;this.buf[t]=eb.charCodeAt(s)}}fillSeq(){let e=this.seq;for(let t=21;t>=12;t--)this.buf[t]=eb.charCodeAt(e%36),e=Math.floor(e/36)}next(){return this.inited||this.init(),this.seq+=this.inc,this.seq>0xcfd41b9100000&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),String.fromCharCode.apply(String,this.buf)}reset(){this.init()}}let ey=new e_;(R=r||(r={})).Disconnect="disconnect",R.Reconnect="reconnect",R.Update="update",R.LDM="ldm",R.Error="error",(T=i||(i={})).Reconnecting="reconnecting",T.PingTimer="pingTimer",T.StaleConnection="staleConnection",T.ClientInitiatedReconnect="client initiated reconnect",($=n||(n={})).ApiError="BAD API",$.BadAuthentication="BAD_AUTHENTICATION",$.BadCreds="BAD_CREDS",$.BadHeader="BAD_HEADER",$.BadJson="BAD_JSON",$.BadPayload="BAD_PAYLOAD",$.BadSubject="BAD_SUBJECT",$.Cancelled="CANCELLED",$.ConnectionClosed="CONNECTION_CLOSED",$.ConnectionDraining="CONNECTION_DRAINING",$.ConnectionRefused="CONNECTION_REFUSED",$.ConnectionTimeout="CONNECTION_TIMEOUT",$.Disconnect="DISCONNECT",$.InvalidOption="INVALID_OPTION",$.InvalidPayload="INVALID_PAYLOAD",$.MaxPayloadExceeded="MAX_PAYLOAD_EXCEEDED",$.NoResponders="503",$.NotFunction="NOT_FUNC",$.RequestError="REQUEST_ERROR",$.ServerOptionNotAvailable="SERVER_OPT_NA",$.SubClosed="SUB_CLOSED",$.SubDraining="SUB_DRAINING",$.Timeout="TIMEOUT",$.Tls="TLS",$.Unknown="UNKNOWN_ERROR",$.WssRequired="WSS_REQUIRED",$.JetStreamInvalidAck="JESTREAM_INVALID_ACK",$.JetStream404NoMessages="404",$.JetStream408RequestTimeout="408",$.JetStream409MaxAckPendingExceeded="409",$.JetStream409="409",$.JetStreamNotEnabled="503",$.JetStreamIdleHeartBeat="IDLE_HEARTBEAT",$.AuthorizationViolation="AUTHORIZATION_VIOLATION",$.AuthenticationExpired="AUTHENTICATION_EXPIRED",$.ProtocolError="NATS_PROTOCOL_ERR",$.PermissionsViolation="PERMISSIONS_VIOLATION",$.AuthenticationTimeout="AUTHENTICATION_TIMEOUT",$.AccountExpired="ACCOUNT_EXPIRED";class ew{messages;constructor(){this.messages=new Map,this.messages.set(n.InvalidPayload,"Invalid payload type - payloads can be 'binary', 'string', or 'json'"),this.messages.set(n.BadJson,"Bad JSON"),this.messages.set(n.WssRequired,"TLS is required, therefore a secure websocket connection is also required")}static getMessage(e){return eS.getMessage(e)}getMessage(e){return this.messages.get(e)||e}}let eS=new ew;class ev extends Error{name;message;code;permissionContext;chainedError;api_error;constructor(e,t,s){super(e),this.name="NatsError",this.message=e,this.code=t,this.chainedError=s}static errorForCode(e,t){return new ev(ew.getMessage(e),e,t)}isAuthError(){return this.code===n.AuthenticationExpired||this.code===n.AuthorizationViolation||this.code===n.AccountExpired}isAuthTimeout(){return this.code===n.AuthenticationTimeout}isPermissionError(){return this.code===n.PermissionsViolation}isProtocolError(){return this.code===n.ProtocolError}isJetStreamError(){return void 0!==this.api_error}jsError(){return this.api_error?this.api_error:null}}(U=o||(o={}))[U.Exact=0]="Exact",U[U.CanonicalMIME=1]="CanonicalMIME",U[U.IgnoreCase=2]="IgnoreCase",(q=a||(a={})).Timer="timer",q.Count="count",q.JitterTimer="jitterTimer",q.SentinelMsg="sentinelMsg",(F=c||(c={})).STATS="io.nats.micro.v1.stats_response",F.INFO="io.nats.micro.v1.info_response",F.PING="io.nats.micro.v1.ping_response";let eE="Nats-Service-Error",ex="Nats-Service-Error-Code";class eA extends Error{code;constructor(e,t){super(t),this.code=e}static isServiceError(e){return null!==eA.toServiceError(e)}static toServiceError(e){let t=e?.headers?.get(ex)||"";if(""!==t){let s=parseInt(t)||400,r=e?.headers?.get(eE)||"";return new eA(s,r.length?r:t)}return null}}function eP(e=""){if("string"!=typeof(e=e||"_INBOX"))throw Error("prefix must be a string");return e.split(".").forEach(t=>{if("*"===t||">"===t)throw Error(`inbox prefixes cannot have wildcards '${e}'`)}),`${e}.${ey.next()}`}let ek="127.0.0.1";function eC(e,...t){for(let s=0;s<t.length;s++){let r=t[s];Object.keys(r).forEach(function(t){e[t]=r[t]})}return e}function eO(e){return ep.decode(e).replace(/\n/g,"␊").replace(/\r/g,"␍")}function ej(e,t=!0){let s,r;let i=t?ev.errorForCode(n.Timeout):null;return Object.assign(new Promise((t,o)=>{s={cancel:()=>{r&&clearTimeout(r)}},r=setTimeout(()=>{null===i?o(ev.errorForCode(n.Timeout)):o(i)},e)}),s)}function eI(e=0){let t;return Object.assign(new Promise(s=>{let r=setTimeout(()=>{s()},e);t={cancel:()=>{r&&clearTimeout(r)}}}),t)}function eN(){let e={};return Object.assign(new Promise((t,s)=>{e={resolve:t,reject:s}}),e)}function eM(e){for(let t=e.length-1;t>0;t--){let s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}function eR(e=[0,250,250,500,500,3e3,5e3]){Array.isArray(e)||(e=[0,250,250,500,500,3e3,5e3]);let t=e.length-1;return{backoff:s=>{var r;return 0===(r=s>t?e[t]:e[s])?0:Math.floor(r/2+Math.random()*r)}}}function eT(e){return 1e6*e}function e$(e){return Math.floor(e/1e6)}function eU(e){let t=!0,s=Array(e.length);for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);if(58===i||i<33||i>126)throw new ev(`'${e[r]}' is not a valid character for a header key`,n.BadHeader);t&&97<=i&&i<=122?i-=32:!t&&65<=i&&i<=90&&(i+=32),s[r]=i,t=45==i}return String.fromCharCode(...s)}function eq(e=0,t=""){if(0===e&&""!==t||e>0&&""===t)throw Error("setting status requires both code and description");return new eL(e,t)}(L=h||(h={})).PING="PING",L.STATS="STATS",L.INFO="INFO";let eF="NATS/1.0";class eL{_code;headers;_description;constructor(e=0,t=""){this._code=e,this._description=t,this.headers=new Map}[Symbol.iterator](){return this.headers.entries()}size(){return this.headers.size}equals(e){if(e&&this.headers.size===e.headers.size&&this._code===e._code){for(let[t,s]of this.headers){let r=e.values(t);if(s.length!==r.length)return!1;let i=[...s].sort(),n=[...r].sort();for(let e=0;e<i.length;e++)if(i[e]!==n[e])return!1}return!0}return!1}static decode(e){let t=new eL,s=ep.decode(e).split("\r\n"),r=s[0];if(r!==eF){let e=r.replace(eF,"").trim();if(e.length>0){t._code=parseInt(e,10),isNaN(t._code)&&(t._code=0);let s=t._code.toString();e=e.replace(s,""),t._description=e.trim()}}return s.length>=1&&s.slice(1).map(e=>{if(e){let s=e.indexOf(":");if(s>-1){let r=e.slice(0,s),i=e.slice(s+1).trim();t.append(r,i)}}}),t}toString(){if(0===this.headers.size&&0===this._code)return"";let e=eF;for(let[t,s]of(this._code>0&&""!==this._description&&(e+=` ${this._code} ${this._description}`),this.headers))for(let r=0;r<s.length;r++)e=`${e}\r
${t}: ${s[r]}`;return`${e}\r
\r
`}encode(){return ef.encode(this.toString())}static validHeaderValue(e){if(/[\r\n]/.test(e))throw new ev("invalid header value - \\r and \\n are not allowed.",n.BadHeader);return e.trim()}keys(){let e=[];for(let t of this.headers.keys())e.push(t);return e}findKeys(e,t=o.Exact){let s=this.keys();switch(t){case o.Exact:return s.filter(t=>t===e);case o.CanonicalMIME:return e=eU(e),s.filter(t=>t===e);default:{let t=e.toLowerCase();return s.filter(e=>t===e.toLowerCase())}}}get(e,t=o.Exact){let s=this.findKeys(e,t);if(s.length){let e=this.headers.get(s[0]);if(e)return Array.isArray(e)?e[0]:e}return""}last(e,t=o.Exact){let s=this.findKeys(e,t);if(s.length){let e=this.headers.get(s[0]);if(e)return Array.isArray(e)?e[e.length-1]:e}return""}has(e,t=o.Exact){return this.findKeys(e,t).length>0}set(e,t,s=o.Exact){this.delete(e,s),this.append(e,t,s)}append(e,t,s=o.Exact){let r=eU(e);s===o.CanonicalMIME&&(e=r);let i=this.findKeys(e,s);e=i.length>0?i[0]:e;let n=eL.validHeaderValue(t),a=this.headers.get(e);a||(a=[],this.headers.set(e,a)),a.push(n)}values(e,t=o.Exact){let s=[];return this.findKeys(e,t).forEach(e=>{let t=this.headers.get(e);t&&s.push(...t)}),s}delete(e,t=o.Exact){this.findKeys(e,t).forEach(e=>{this.headers.delete(e)})}get hasError(){return this._code>=300}get status(){return`${this._code} ${this._description}`.trim()}toRecord(){let e={};return this.keys().forEach(t=>{e[t]=this.values(t)}),e}get code(){return this._code}get description(){return this._description}static fromRecord(e){let t=new eL;for(let s in e)t.headers.set(s,e[s]);return t}}function eB(){return{encode:e=>ef.encode(e),decode:e=>ep.decode(e)}}function eD(e){return{encode(e){try{return void 0===e&&(e=null),ef.encode(JSON.stringify(e))}catch(e){throw ev.errorForCode(n.BadJson,e)}},decode(t){try{return JSON.parse(ep.decode(t),e)}catch(e){throw ev.errorForCode(n.BadJson,e)}}}}function eH(e){return e&&0===e.data.length&&e.headers?.code===503?ev.errorForCode(n.NoResponders):null}class eJ{_headers;_msg;_rdata;_reply;_subject;publisher;static jc;constructor(e,t,s){this._msg=e,this._rdata=t,this.publisher=s}get subject(){return this._subject||(this._subject=ep.decode(this._msg.subject)),this._subject}get reply(){return this._reply||(this._reply=ep.decode(this._msg.reply)),this._reply}get sid(){return this._msg.sid}get headers(){if(this._msg.hdr>-1&&!this._headers){let e=this._rdata.subarray(0,this._msg.hdr);this._headers=eL.decode(e)}return this._headers}get data(){return this._rdata?this._msg.hdr>-1?this._rdata.subarray(this._msg.hdr):this._rdata:new Uint8Array(0)}respond(e=ed,t){return!!this.reply&&(this.publisher.publish(this.reply,e,t),!0)}size(){return this._msg.subject.length+(this._msg.reply?.length||0)+(-1===this._msg.size?0:this._msg.size)}json(e){return eD(e).decode(this.data)}string(){return ep.decode(this.data)}requestInfo(){let e=this.headers?.get("Nats-Request-Info");return e?JSON.parse(e,function(e,t){return("start"===e||"stop"===e)&&""!==t?new Date(Date.parse(t)):t}):null}}function ez(e){return eK("durable",e)}function eG(e){return eK("stream",e)}function eK(e,t=""){if(""===t)throw Error(`${e} name required`);return[".","*",">","/","\\"," ","	","\n","\r"].forEach(s=>{if(-1!==t.indexOf(s)){switch(s){case"\n":s="\\n";break;case"\r":s="\\r";break;case"	":s="\\t"}throw Error(`invalid ${e} name - ${e} name cannot contain '${s}'`)}}),""}function eV(e,t=""){if(""===t)throw Error(`${e} name required`);let s=function(e=""){if(""===e)throw Error("name required");let t=/^[-\w]+$/g;if(null===e.match(t)){for(let s of e.split(""))if(null===s.match(t))return`cannot contain '${s}'`}return""}(t);if(s.length)throw Error(`invalid ${e} name - ${e} name ${s}`)}function eW(e){if(e.data.length>0)return!1;let t=e.headers;return!!t&&t.code>=100&&t.code<200}function eY(e){return eW(e)&&e.headers?.description==="Idle Heartbeat"}function eX(e){if(0!==e.data.length)return null;let t=e.headers;return t?eQ(t.code,t.description):null}function eQ(e,t=""){if(e<300)return null;switch(t=t.toLowerCase(),e){case 404:return new ev(t,n.JetStream404NoMessages);case 408:return new ev(t,n.JetStream408RequestTimeout);case 409:{let e=t.startsWith(l.IdleHeartbeatMissed)?n.JetStreamIdleHeartBeat:n.JetStream409;return new ev(t,e)}case 503:return ev.errorForCode(n.JetStreamNotEnabled,Error(t));default:return""===t&&(t=n.Unknown),new ev(t,`${e}`)}}(B=l||(l={})).MaxBatchExceeded="exceeded maxrequestbatch of",B.MaxExpiresExceeded="exceeded maxrequestexpires of",B.MaxBytesExceeded="exceeded maxrequestmaxbytes of",B.MaxMessageSizeExceeded="message size exceeds maxbytes",B.PushConsumer="consumer is push based",B.MaxWaitingExceeded="exceeded maxwaiting",B.IdleHeartbeatMissed="idle heartbeats missed",B.ConsumerDeleted="consumer deleted";class eZ{inflight;processed;received;noIterator;iterClosed;done;signal;yields;filtered;pendingFiltered;ingestionFilterFn;protocolFilterFn;dispatchedFn;ctx;_data;err;time;yielding;constructor(){this.inflight=0,this.filtered=0,this.pendingFiltered=0,this.processed=0,this.received=0,this.noIterator=!1,this.done=!1,this.signal=eN(),this.yields=[],this.iterClosed=eN(),this.time=0,this.yielding=!1}[Symbol.asyncIterator](){return this.iterate()}push(e){if(this.done)return;if("function"==typeof e){this.yields.push(e),this.signal.resolve();return}let{ingest:t,protocol:s}=this.ingestionFilterFn?this.ingestionFilterFn(e,this.ctx||this):{ingest:!0,protocol:!1};t&&(s&&(this.filtered++,this.pendingFiltered++),this.yields.push(e),this.signal.resolve())}async *iterate(){if(this.noIterator)throw new ev("unsupported iterator",n.ApiError);if(this.yielding)throw new ev("already yielding",n.ApiError);this.yielding=!0;try{for(;;){if(0===this.yields.length&&await this.signal,this.err)throw this.err;let e=this.yields;this.inflight=e.length,this.yields=[];for(let t=0;t<e.length;t++){if("function"==typeof e[t]){let s=e[t];try{s()}catch(e){throw e}if(this.err)throw this.err;continue}if(!this.protocolFilterFn||this.protocolFilterFn(e[t])){this.processed++;let s=Date.now();yield e[t],this.time=Date.now()-s,this.dispatchedFn&&e[t]&&this.dispatchedFn(e[t])}else this.pendingFiltered--;this.inflight--}if(this.done)break;0===this.yields.length&&(e.length=0,this.yields=e,this.signal=eN())}}finally{this.stop()}}stop(e){this.done||(this.err=e,this.done=!0,this.signal.resolve(),this.iterClosed.resolve(e))}getProcessed(){return this.noIterator?this.received:this.processed}getPending(){return this.yields.length+this.inflight-this.pendingFiltered}getReceived(){return this.received-this.filtered}}class e0{interval;maxOut;cancelAfter;timer;autoCancelTimer;last;missed;count;callback;constructor(e,t,s={maxOut:2}){this.interval=e,this.maxOut=s?.maxOut||2,this.cancelAfter=s?.cancelAfter||0,this.last=Date.now(),this.missed=0,this.count=0,this.callback=t,this._schedule()}cancel(){this.autoCancelTimer&&clearTimeout(this.autoCancelTimer),this.timer&&clearInterval(this.timer),this.timer=0,this.autoCancelTimer=0,this.missed=0}work(){this.last=Date.now(),this.missed=0}_change(e,t=0,s=2){this.interval=e,this.maxOut=s,this.cancelAfter=t,this.restart()}restart(){this.cancel(),this._schedule()}_schedule(){this.cancelAfter>0&&(this.autoCancelTimer=setTimeout(()=>{this.cancel()},this.cancelAfter)),this.timer=setInterval(()=>{if(this.count++,Date.now()-this.last>this.interval&&this.missed++,this.missed>=this.maxOut)try{!0===this.callback(this.missed)&&this.cancel()}catch(e){console.log(e)}},this.interval)}}(D=u||(u={})).Limits="limits",D.Interest="interest",D.Workqueue="workqueue",(H=d||(d={})).Old="old",H.New="new",(J=f||(f={})).File="file",J.Memory="memory",(z=p||(p={})).All="all",z.Last="last",z.New="new",z.StartSequence="by_start_sequence",z.StartTime="by_start_time",z.LastPerSubject="last_per_subject",(G=m||(m={})).None="none",G.All="all",G.Explicit="explicit",G.NotSet="",(K=g||(g={})).Instant="instant",K.Original="original",(V=b||(b={})).None="none",V.S2="s2",(W=_||(_={})).CreateOrUpdate="",W.Update="update",W.Create="create",(Y=y||(y={})).API="api_audit",Y.StreamAction="stream_action",Y.ConsumerAction="consumer_action",Y.SnapshotCreate="snapshot_create",Y.SnapshotComplete="snapshot_complete",Y.RestoreCreate="restore_create",Y.RestoreComplete="restore_complete",Y.MaxDeliver="max_deliver",Y.Terminated="terminated",Y.Ack="consumer_ack",Y.StreamLeaderElected="stream_leader_elected",Y.StreamQuorumLost="stream_quorum_lost",Y.ConsumerLeaderElected="consumer_leader_elected",Y.ConsumerQuorumLost="consumer_quorum_lost",(X=w||(w={})).StreamSourceHdr="Nats-Stream-Source",X.LastConsumerSeqHdr="Nats-Last-Consumer",X.LastStreamSeqHdr="Nats-Last-Stream",X.ConsumerStalledHdr="Nats-Consumer-Stalled",X.MessageSizeHdr="Nats-Msg-Size",X.RollupHdr="Nats-Rollup",X.RollupValueSubject="sub",X.RollupValueAll="all",X.PendingMessagesHdr="Nats-Pending-Messages",X.PendingBytesHdr="Nats-Pending-Bytes",(Q=S||(S={})).LastValue="",Q.AllHistory="history",Q.UpdatesOnly="updates",(Z=v||(v={})).Stream="Nats-Stream",Z.Sequence="Nats-Sequence",Z.TimeStamp="Nats-Time-Stamp",Z.Subject="Nats-Subject",(ee=E||(E={})).Stream="Nats-Stream",ee.Subject="Nats-Subject",ee.Sequence="Nats-Sequence",ee.LastSequence="Nats-Last-Sequence",ee.Size="Nats-Msg-Size";class e1{config;ordered;mack;stream;callbackFn;max;qname;isBind;filters;constructor(e){this.stream="",this.mack=!1,this.ordered=!1,this.config=function(e,t={}){return Object.assign({name:"",deliver_policy:p.All,ack_policy:m.Explicit,ack_wait:eT(3e4),replay_policy:g.Instant},t)}(0,e||{})}getOpts(){let e={};if(e.config=Object.assign({},this.config),e.config.filter_subject&&(this.filterSubject(e.config.filter_subject),e.config.filter_subject=void 0),e.config.filter_subjects&&(e.config.filter_subjects?.forEach(e=>{this.filterSubject(e)}),e.config.filter_subjects=void 0),e.mack=this.mack,e.stream=this.stream,e.callbackFn=this.callbackFn,e.max=this.max,e.queue=this.qname,e.ordered=this.ordered,e.config.ack_policy=e.ordered?m.None:e.config.ack_policy,e.isBind=e.isBind||!1,this.filters)switch(this.filters.length){case 0:break;case 1:e.config.filter_subject=this.filters[0];break;default:e.config.filter_subjects=this.filters}return e}description(e){return this.config.description=e,this}deliverTo(e){return this.config.deliver_subject=e,this}durable(e){return ez(e),this.config.durable_name=e,this}startSequence(e){if(e<=0)throw Error("sequence must be greater than 0");return this.config.deliver_policy=p.StartSequence,this.config.opt_start_seq=e,this}startTime(e){return this.config.deliver_policy=p.StartTime,this.config.opt_start_time=e.toISOString(),this}deliverAll(){return this.config.deliver_policy=p.All,this}deliverLastPerSubject(){return this.config.deliver_policy=p.LastPerSubject,this}deliverLast(){return this.config.deliver_policy=p.Last,this}deliverNew(){return this.config.deliver_policy=p.New,this}startAtTimeDelta(e){return this.startTime(new Date(Date.now()-e)),this}headersOnly(){return this.config.headers_only=!0,this}ackNone(){return this.config.ack_policy=m.None,this}ackAll(){return this.config.ack_policy=m.All,this}ackExplicit(){return this.config.ack_policy=m.Explicit,this}ackWait(e){return this.config.ack_wait=eT(e),this}maxDeliver(e){return this.config.max_deliver=e,this}filterSubject(e){return this.filters=this.filters||[],this.filters.push(e),this}replayInstantly(){return this.config.replay_policy=g.Instant,this}replayOriginal(){return this.config.replay_policy=g.Original,this}sample(e){if((e=Math.trunc(e))<0||e>100)throw Error("value must be between 0-100");return this.config.sample_freq=`${e}%`,this}limit(e){return this.config.rate_limit_bps=e,this}maxWaiting(e){return this.config.max_waiting=e,this}maxAckPending(e){return this.config.max_ack_pending=e,this}idleHeartbeat(e){return this.config.idle_heartbeat=eT(e),this}flowControl(){return this.config.flow_control=!0,this}deliverGroup(e){return this.queue(e),this}manualAck(){return this.mack=!0,this}maxMessages(e){return this.max=e,this}callback(e){return this.callbackFn=e,this}queue(e){return this.qname=e,this.config.deliver_group=e,this}orderedConsumer(){return this.ordered=!0,this}bind(e,t){return this.stream=e,this.config.durable_name=t,this.isBind=!0,this}bindStream(e){return this.stream=e,this}inactiveEphemeralThreshold(e){return this.config.inactive_threshold=eT(e),this}maxPullBatch(e){return this.config.max_batch=e,this}maxPullRequestExpires(e){return this.config.max_expires=eT(e),this}memory(){return this.config.mem_storage=!0,this}numReplicas(e){return this.config.num_replicas=e,this}consumerName(e){return this.config.name=e,this}}function e2(e){return new e1(e)}function e3(e){return"function"==typeof e.getOpts}class e4{static encode(e){return"string"==typeof e?btoa(e):btoa(String.fromCharCode(...Array.from(e)))}static decode(e,t=!1){let s=atob(e);return t?Uint8Array.from(s,e=>e.charCodeAt(0)):s}}class e5{static encode(e){return e5.toB64URLEncoding(e4.encode(e))}static decode(e,t=!1){return e5.decode(e5.fromB64URLEncoding(e),t)}static toB64URLEncoding(e){return e.replace(/\+/g,"-").replace(/\//g,"_")}static fromB64URLEncoding(e){return e.replace(/_/g,"/").replace(/-/g,"+")}}class e6{buffers;byteLength;constructor(){this.buffers=[],this.byteLength=0}static concat(...e){let t=0;for(let s=0;s<e.length;s++)t+=e[s].length;let s=new Uint8Array(t),r=0;for(let t=0;t<e.length;t++)s.set(e[t],r),r+=e[t].length;return s}static fromAscii(e){return e||(e=""),ef.encode(e)}static toAscii(e){return ep.decode(e)}reset(){this.buffers.length=0,this.byteLength=0}pack(){if(this.buffers.length>1){let e=new Uint8Array(this.byteLength),t=0;for(let s=0;s<this.buffers.length;s++)e.set(this.buffers[s],t),t+=this.buffers[s].length;this.buffers.length=0,this.buffers.push(e)}}shift(){if(this.buffers.length){let e=this.buffers.shift();if(e)return this.byteLength-=e.length,e}return new Uint8Array(0)}drain(e){if(this.buffers.length){this.pack();let t=this.buffers.pop();if(t){let s=this.byteLength;(void 0===e||e>s)&&(e=s);let r=t.subarray(0,e);return s>e&&this.buffers.push(t.subarray(e)),this.byteLength=s-e,r}}return new Uint8Array(0)}fill(e,...t){e&&(this.buffers.push(e),this.byteLength+=e.length);for(let e=0;e<t.length;e++)t[e]&&t[e].length&&(this.buffers.push(t[e]),this.byteLength+=t[e].length)}peek(){return this.buffers.length?(this.pack(),this.buffers[0]):new Uint8Array(0)}size(){return this.byteLength}length(){return this.buffers.length}}function e8(e){let t=e.length,s=e.indexOf("=");-1===s&&(s=t);let r=s===t?0:4-s%4;return[s,r]}let e7=[],e9=[],te="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";for(let e=0,t=te.length;e<t;++e)e7[e]=te[e],e9[te.charCodeAt(e)]=e;let{byteLength:tt,toUint8Array:ts,fromUint8Array:tr}=function(e,t,s=!1){function r(e,t){return Math.floor((e+t)*3/4-t)}return{byteLength:e=>r.apply(null,e8(e)),toUint8Array(e){let s,i;let[n,o]=e8(e),a=new Uint8Array(r(n,o)),c=o?n-4:n,h=0;for(i=0;i<c;i+=4)s=t[e.charCodeAt(i)]<<18|t[e.charCodeAt(i+1)]<<12|t[e.charCodeAt(i+2)]<<6|t[e.charCodeAt(i+3)],a[h++]=s>>16&255,a[h++]=s>>8&255,a[h++]=255&s;return 2===o?(s=t[e.charCodeAt(i)]<<2|t[e.charCodeAt(i+1)]>>4,a[h++]=255&s):1===o&&(s=t[e.charCodeAt(i)]<<10|t[e.charCodeAt(i+1)]<<4|t[e.charCodeAt(i+2)]>>2,a[h++]=s>>8&255,a[h++]=255&s),a},fromUint8Array(t){let r,i;let n=t.length,o=n%3,a=n-o,c=Array(Math.ceil(a/16383)+(o?1:0)),h=0;for(let s=0;s<a;s+=16383)r=s+16383,c[h++]=function(t,s,r){let i=Array((r-s)/3);for(let o=s,a=0;o<r;o+=3){var n;i[a++]=e[(n=(t[o]<<16)+(t[o+1]<<8)+t[o+2])>>18&63]+e[n>>12&63]+e[n>>6&63]+e[63&n]}return i.join("")}(t,s,r>a?a:r);return 1===o?(i=t[a],c[h]=e[i>>2]+e[i<<4&63],s||(c[h]+="==")):2!==o||(i=t[a]<<8|255&t[a+1],c[h]=e[i>>10]+e[i>>4&63]+e[i<<2&63],s||(c[h]+="=")),c.join("")}}}(e7,e9,!0),ti=new TextDecoder,tn=new TextEncoder;class to{hashSize=32;_buf;_bufIdx;_count;_K;_H;_finalized;constructor(){this._buf=new Uint8Array(64),this._K=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),this.init()}init(){return this._H=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),this._bufIdx=0,this._count=new Uint32Array(2),this._buf.fill(0),this._finalized=!1,this}update(e,t){if(null===e)throw TypeError("msg must be a string or Uint8Array.");"string"==typeof e&&(e=function(e,t="utf8"){if(/^utf-?8$/i.test(t))return tn.encode(e);if(/^base64$/i.test(t))return ts(e);if(/^hex(?:adecimal)?$/i.test(t))return function(e){let t=e.length;if(t%2||!/^[0-9a-fA-F]+$/.test(e))throw TypeError("Invalid hex string.");e=e.toLowerCase();let s=new Uint8Array(Math.floor(t/2)),r=t/2;for(let t=0;t<r;++t)s[t]=parseInt(e.substr(2*t,2),16);return s}(e);throw TypeError("Unsupported string encoding.")}(e,t));for(let t=0,s=e.length;t<s;t++)this._buf[this._bufIdx++]=e[t],64===this._bufIdx&&(this._transform(),this._bufIdx=0);let s=this._count;return(s[0]+=e.length<<3)<e.length<<3&&s[1]++,s[1]+=e.length>>>29,this}digest(e){if(this._finalized)throw Error("digest has already been called.");this._finalized=!0;let t=this._buf,s=this._bufIdx;for(t[s++]=128;56!==s;)64===s&&(this._transform(),s=0),t[s++]=0;let r=this._count;t[56]=r[1]>>>24&255,t[57]=r[1]>>>16&255,t[58]=r[1]>>>8&255,t[59]=r[1]>>>0&255,t[60]=r[0]>>>24&255,t[61]=r[0]>>>16&255,t[62]=r[0]>>>8&255,t[63]=r[0]>>>0&255,this._transform();let i=new Uint8Array(32);for(let e=0;e<8;e++)i[(e<<2)+0]=this._H[e]>>>24&255,i[(e<<2)+1]=this._H[e]>>>16&255,i[(e<<2)+2]=this._H[e]>>>8&255,i[(e<<2)+3]=this._H[e]>>>0&255;return this.init(),e?function(e,t="utf8"){if(/^utf-?8$/i.test(t))return ti.decode(e);if(/^base64$/i.test(t))return tr(e);if(/^hex(?:adecimal)?$/i.test(t))return e.reduce((e,t)=>`${e}${t<16?"0":""}${t.toString(16)}`,"");throw TypeError("Unsupported string encoding.")}(i,e):i}_transform(){let e;let t=this._H,s=t[0],r=t[1],i=t[2],n=t[3],o=t[4],a=t[5],c=t[6],h=t[7],l=new Uint32Array(16);for(e=0;e<16;e++)l[e]=this._buf[(e<<2)+3]|this._buf[(e<<2)+2]<<8|this._buf[(e<<2)+1]<<16|this._buf[e<<2]<<24;for(e=0;e<64;e++){let t;if(e<16)t=l[e];else{let s=l[e+1&15],r=l[e+14&15];t=l[15&e]=(s>>>7^s>>>18^s>>>3^s<<25^s<<14)+(r>>>17^r>>>19^r>>>10^r<<15^r<<13)+l[15&e]+l[e+9&15]|0}t=t+h+(o>>>6^o>>>11^o>>>25^o<<26^o<<21^o<<7)+(c^o&(a^c))+this._K[e]|0,h=c,c=a,a=o,o=n+t,n=i,i=r,s=t+((r=s)&i^n&(r^i))+(r>>>2^r>>>13^r>>>22^r<<30^r<<19^r<<10)|0}t[0]=t[0]+s|0,t[1]=t[1]+r|0,t[2]=t[2]+i|0,t[3]=t[3]+n|0,t[4]=t[4]+o|0,t[5]=t[5]+a|0,t[6]=t[6]+c|0,t[7]=t[7]+h|0}}class ta{token;received;ctx;requestSubject;mux;constructor(e,t,s=!0){this.mux=e,this.requestSubject=t,this.received=0,this.token=ey.next(),s&&(this.ctx=Error())}}class tc extends ta{callback;done;timer;max;opts;constructor(e,t,s={maxWait:1e3}){if(super(e,t),this.opts=s,"function"!=typeof this.opts.callback)throw Error("callback is required");this.callback=this.opts.callback,this.max="number"==typeof s.maxMessages&&s.maxMessages>0?s.maxMessages:-1,this.done=eN(),this.done.then(()=>{this.callback(null,null)}),this.timer=setTimeout(()=>{this.cancel()},s.maxWait)}cancel(e){e&&this.callback(e,null),clearTimeout(this.timer),this.mux.cancel(this),this.done.resolve()}resolver(e,t){e?(this.ctx&&(e.stack+=`

${this.ctx.stack}`),this.cancel(e)):(this.callback(null,t),this.opts.strategy===a.Count&&(this.max--,0===this.max&&this.cancel()),this.opts.strategy===a.JitterTimer&&(clearTimeout(this.timer),this.timer=setTimeout(()=>{this.cancel()},this.opts.jitter||300)),this.opts.strategy===a.SentinelMsg&&t&&0===t.data.length&&this.cancel())}}class th extends ta{deferred;timer;constructor(e,t,s={timeout:1e3},r=!0){super(e,t,r),this.deferred=eN(),this.timer=ej(s.timeout,r)}resolver(e,t){this.timer&&this.timer.cancel(),e?(this.ctx&&(e.stack+=`

${this.ctx.stack}`),this.deferred.reject(e)):this.deferred.resolve(t),this.cancel()}cancel(e){this.timer&&this.timer.cancel(),this.mux.cancel(this),this.deferred.reject(e||ev.errorForCode(n.Cancelled))}}class tl{nc;opts;prefix;timeout;jc;constructor(e,t){var s;this.nc=e,this.opts=((s=(s=t)||{}).domain&&(s.apiPrefix=`$JS.${s.domain}.API`,delete s.domain),eC({apiPrefix:"$JS.API",timeout:5e3},s)),this._parseOpts(),this.prefix=this.opts.apiPrefix,this.timeout=this.opts.timeout,this.jc=eD()}getOptions(){return Object.assign({},this.opts)}_parseOpts(){let e=this.opts.apiPrefix;if(!e||0===e.length)throw Error("invalid empty prefix");"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),this.opts.apiPrefix=e}async _request(e,t=null,s){(s=s||{}).timeout=this.timeout;let r=ed;t&&(r=this.jc.encode(t));let{retries:i}=s;i=-1===(i=i||1)?Number.MAX_SAFE_INTEGER:i;let o=eR();for(let t=0;t<i;t++)try{let t=await this.nc.request(e,r,s);return this.parseJsResponse(t)}catch(e){if(("503"===e.code||e.code===n.Timeout)&&t+1<i)await eI(o.backoff(t));else throw e}}async findStream(e){let t=await this._request(`${this.prefix}.STREAM.NAMES`,{subject:e});if(!t.streams||1!==t.streams.length)throw Error("no stream matches subject");return t.streams[0]}getConnection(){return this.nc}parseJsResponse(e){let t=this.jc.decode(e.data);if(t.error){let e=eQ(t.error.code,t.error.description);if(null!==e)throw e.api_error=t.error,e}return t}}class tu{err;offset;pageInfo;subject;jsm;filter;payload;constructor(e,t,s,r){if(!e)throw Error("subject is required");this.subject=e,this.jsm=s,this.offset=0,this.pageInfo={},this.filter=t,this.payload=r||{}}async next(){if(this.err||this.pageInfo&&this.offset>=this.pageInfo.total)return[];let e={offset:this.offset};this.payload&&Object.assign(e,this.payload);try{let t=await this.jsm._request(this.subject,e,{timeout:this.jsm.timeout});this.pageInfo=t;let s=this.countResponse(t);if(0===s)return[];return this.offset+=s,this.filter(t)}catch(e){throw this.err=e,e}}countResponse(e){switch(e?.type){case"io.nats.jetstream.api.v1.stream_names_response":case"io.nats.jetstream.api.v1.stream_list_response":return e.streams?.length||0;case"io.nats.jetstream.api.v1.consumer_list_response":return e.consumers?.length||0;default:return console.error(`jslister.ts: unknown API response for paged output: ${e?.type}`),e.streams?.length||0}return 0}async *[Symbol.asyncIterator](){let e=await this.next();for(;e.length>0;){for(let t of e)yield t;e=await this.next()}}}function td(e=""){let t=e.match(/(\d+).(\d+).(\d+)/);if(t)return{major:parseInt(t[1]),minor:parseInt(t[2]),micro:parseInt(t[3])};throw Error(`'${e}' is not a semver value`)}function tf(e,t){return e.major<t.major?-1:e.major>t.major?1:e.minor<t.minor?-1:e.minor>t.minor?1:e.micro<t.micro?-1:e.micro>t.micro?1:0}(et=x||(x={})).JS_KV="js_kv",et.JS_OBJECTSTORE="js_objectstore",et.JS_PULL_MAX_BYTES="js_pull_max_bytes",et.JS_NEW_CONSUMER_CREATE_API="js_new_consumer_create",et.JS_ALLOW_DIRECT="js_allow_direct",et.JS_MULTIPLE_CONSUMER_FILTER="js_multiple_consumer_filter",et.JS_SIMPLIFICATION="js_simplification",et.JS_STREAM_CONSUMER_METADATA="js_stream_consumer_metadata",et.JS_CONSUMER_FILTER_SUBJECTS="js_consumer_filter_subjects",et.JS_STREAM_FIRST_SEQ="js_stream_first_seq",et.JS_STREAM_SUBJECT_TRANSFORM="js_stream_subject_transform",et.JS_STREAM_SOURCE_SUBJECT_TRANSFORM="js_stream_source_subject_transform",et.JS_STREAM_COMPRESSION="js_stream_compression",et.JS_DEFAULT_CONSUMER_LIMITS="js_default_consumer_limits",et.JS_BATCH_DIRECT_GET="js_batch_direct_get";class tp{server;features;disabled;constructor(e){this.features=new Map,this.disabled=[],this.update(e)}resetDisabled(){this.disabled.length=0,this.update(this.server)}disable(e){this.disabled.push(e),this.update(this.server)}isDisabled(e){return -1!==this.disabled.indexOf(e)}update(e){"string"==typeof e&&(e=td(e)),this.server=e,this.set(x.JS_KV,"2.6.2"),this.set(x.JS_OBJECTSTORE,"2.6.3"),this.set(x.JS_PULL_MAX_BYTES,"2.8.3"),this.set(x.JS_NEW_CONSUMER_CREATE_API,"2.9.0"),this.set(x.JS_ALLOW_DIRECT,"2.9.0"),this.set(x.JS_MULTIPLE_CONSUMER_FILTER,"2.10.0"),this.set(x.JS_SIMPLIFICATION,"2.9.4"),this.set(x.JS_STREAM_CONSUMER_METADATA,"2.10.0"),this.set(x.JS_CONSUMER_FILTER_SUBJECTS,"2.10.0"),this.set(x.JS_STREAM_FIRST_SEQ,"2.10.0"),this.set(x.JS_STREAM_SUBJECT_TRANSFORM,"2.10.0"),this.set(x.JS_STREAM_SOURCE_SUBJECT_TRANSFORM,"2.10.0"),this.set(x.JS_STREAM_COMPRESSION,"2.10.0"),this.set(x.JS_DEFAULT_CONSUMER_LIMITS,"2.10.0"),this.set(x.JS_BATCH_DIRECT_GET,"2.11.0"),this.disabled.forEach(e=>{this.features.delete(e)})}set(e,t){this.features.set(e,{min:t,ok:tf(this.server,td(t))>=0})}get(e){return this.features.get(e)||{min:"unknown",ok:!1}}supports(e){return this.get(e)?.ok||!1}require(e){return"string"==typeof e&&(e=td(e)),tf(this.server,e)>=0}}class tm extends tl{constructor(e,t){super(e,t)}async add(e,t,s=_.Create){let r;if(eG(e),t.deliver_group&&t.flow_control)throw Error("jetstream flow control is not supported with queue groups");if(t.deliver_group&&t.idle_heartbeat)throw Error("jetstream idle heartbeat is not supported with queue groups");let i={};i.config=t,i.stream_name=e,i.action=s,i.config.durable_name&&ez(i.config.durable_name);let n=this.nc,{min:o,ok:a}=n.features.get(x.JS_NEW_CONSUMER_CREATE_API),c=""===t.name?void 0:t.name;if(c&&!a)throw Error(`consumer 'name' requires server ${o}`);if(c)try{eK("name",c)}catch(s){let e=s.message,t=e.indexOf("cannot contain");if(-1!==t)throw Error(`consumer 'name' ${e.substring(t)}`);throw s}let h="";if(Array.isArray(t.filter_subjects)){let{min:e,ok:t}=n.features.get(x.JS_MULTIPLE_CONSUMER_FILTER);if(!t)throw Error(`consumer 'filter_subjects' requires server ${e}`);a=!1}if(t.metadata){let{min:e,ok:t}=n.features.get(x.JS_STREAM_CONSUMER_METADATA);if(!t)throw Error(`consumer 'metadata' requires server ${e}`)}if(a&&(h=t.name??t.durable_name??""),""!==h){let s=t.filter_subject??void 0;">"===s&&(s=void 0),r=void 0!==s?`${this.prefix}.CONSUMER.CREATE.${e}.${h}.${s}`:`${this.prefix}.CONSUMER.CREATE.${e}.${h}`}else r=t.durable_name?`${this.prefix}.CONSUMER.DURABLE.CREATE.${e}.${t.durable_name}`:`${this.prefix}.CONSUMER.CREATE.${e}`;return await this._request(r,i)}async update(e,t,s){let r=await this.info(e,t);return this.add(e,Object.assign(r.config,s),_.Update)}async info(e,t){return eG(e),ez(t),await this._request(`${this.prefix}.CONSUMER.INFO.${e}.${t}`)}async delete(e,t){return eG(e),ez(t),(await this._request(`${this.prefix}.CONSUMER.DELETE.${e}.${t}`)).success}list(e){return eG(e),new tu(`${this.prefix}.CONSUMER.LIST.${e}`,e=>e.consumers,this)}pause(e,t,s){let r=`${this.prefix}.CONSUMER.PAUSE.${e}.${t}`,i={pause_until:s.toISOString()};return this._request(r,i)}resume(e,t){return this.pause(e,t,new Date(0))}}function tg(e,t,s=!1){if(!0===s&&!e||e&&"function"!=typeof e)throw ev.errorForCode(n.ApiError,Error(`${t} is not a function`))}class tb extends eZ{sub;adapter;subIterDone;constructor(e,t,s){super(),tg(s.adapter,"adapter",!0),this.adapter=s.adapter,s.callback&&tg(s.callback,"callback"),this.noIterator="function"==typeof s.callback,s.ingestionFilterFn&&(tg(s.ingestionFilterFn,"ingestionFilterFn"),this.ingestionFilterFn=s.ingestionFilterFn),s.protocolFilterFn&&(tg(s.protocolFilterFn,"protocolFilterFn"),this.protocolFilterFn=s.protocolFilterFn),s.dispatchedFn&&(tg(s.dispatchedFn,"dispatchedFn"),this.dispatchedFn=s.dispatchedFn),s.cleanupFn&&tg(s.cleanupFn,"cleanupFn");let r=(e,t)=>{this.callback(e,t)};if(s.callback){let e=s.callback;r=(t,s)=>{let[r,i]=this.adapter(t,s);if(r){e(r,null);return}let{ingest:n}=this.ingestionFilterFn?this.ingestionFilterFn(i,this):{ingest:!0};n&&(!this.protocolFilterFn||this.protocolFilterFn(i))&&(e(r,i),this.dispatchedFn&&i&&this.dispatchedFn(i))}}let{max:i,queue:n,timeout:o}=s,a={queue:n,timeout:o,callback:r};i&&i>0&&(a.max=i),this.sub=e.subscribe(t,a),s.cleanupFn&&(this.sub.cleanupFn=s.cleanupFn),this.noIterator||this.iterClosed.then(()=>{this.unsubscribe()}),this.subIterDone=eN(),Promise.all([this.sub.closed,this.iterClosed]).then(()=>{this.subIterDone.resolve()}).catch(()=>{this.subIterDone.resolve()}),(async e=>{await e.closed,this.stop()})(this.sub).then().catch()}unsubscribe(e){this.sub.unsubscribe(e)}drain(){return this.sub.drain()}isDraining(){return this.sub.isDraining()}isClosed(){return this.sub.isClosed()}callback(e,t){this.sub.cancelTimeout();let[s,r]=this.adapter(e,t);s&&this.stop(s),r&&this.push(r)}getSubject(){return this.sub.getSubject()}getReceived(){return this.sub.getReceived()}getProcessed(){return this.sub.getProcessed()}getPending(){return this.sub.getPending()}getID(){return this.sub.getID()}getMax(){return this.sub.getMax()}get closed(){return this.sub.closed}}function t_(){return void 0!==eu&&void 0!==eu.defaultPort?eu.defaultPort:4222}function ty(){return void 0!==eu&&eu.urlParseFn?eu.urlParseFn:void 0}function tw(){return void 0!==eu&&eu.dnsResolveFn?eu.dnsResolveFn:void 0}let tS=e6.fromAscii("\r\n"),tv=new Uint8Array(tS)[0],tE=new Uint8Array(tS)[1];function tx(e){return void 0!==function(e){for(let t=0;t<e.length;t++)switch(e[t]){case".":return tA(e);case":":return function(e){let t=new Uint8Array(16),s=-1;if(e.length>=2&&":"===e[0]&&":"===e[1]&&(s=0,0===(e=e.substring(2)).length))return t;let r=0;for(;r<16;){let{n:i,c:n,ok:o}=function(e){let t=0,s=0;for(s=0;s<e.length;s++){if(48<=e.charCodeAt(s)&&57>=e.charCodeAt(s))t*=16,t+=e.charCodeAt(s)-48;else if(97<=e.charCodeAt(s)&&102>=e.charCodeAt(s))t*=16,t+=e.charCodeAt(s)-97+10;else if(65<=e.charCodeAt(s)&&70>=e.charCodeAt(s))t*=16,t+=e.charCodeAt(s)-65+10;else break;if(t>=16777215)return{n:0,c:s,ok:!1}}return 0===s?{n:0,c:s,ok:!1}:{n:t,c:s,ok:!0}}(e);if(!o||i>65535)return;if(n<e.length&&"."===e[n]){if(s<0&&12!=r||r+4>16)return;let i=tA(e);if(void 0===i)return;t[r]=i[12],t[r+1]=i[13],t[r+2]=i[14],t[r+3]=i[15],e="",r+=4;break}if(t[r]=i>>8,t[r+1]=i,r+=2,0===(e=e.substring(n)).length)break;if(":"!==e[0]||1==e.length)return;if(":"===(e=e.substring(1))[0]){if(s>=0)return;if(s=r,0===(e=e.substring(1)).length)break}}if(0===e.length){if(r<16){if(s<0)return;let e=16-r;for(let i=r-1;i>=s;i--)t[i+e]=t[i];for(let r=s+e-1;r>=s;r--)t[r]=0}else if(s>=0)return;return t}}(e)}}(e)}function tA(e){let t=new Uint8Array(4);for(let s=0;s<4;s++){if(0===e.length)return;if(s>0){if("."!==e[0])return;e=e.substring(1)}let{n:r,c:i,ok:n}=function(e){let t=0,s=0;for(t=0;t<e.length&&48<=e.charCodeAt(t)&&57>=e.charCodeAt(t);t++)if((s=10*s+(e.charCodeAt(t)-48))>=16777215)return{n:16777215,c:t,ok:!1};return 0===t?{n:0,c:0,ok:!1}:{n:s,c:t,ok:!0}}(e);if(!n||r>255)return;e=e.substring(i),t[s]=r}return function(e,t,s,r){let i=new Uint8Array(16);return[0,0,0,0,0,0,0,0,0,0,255,255].forEach((e,t)=>{i[t]=e}),i[12]=e,i[13]=t,i[14]=s,i[15]=r,i}(t[0],t[1],t[2],t[3])}function tP(e){return!(-1===e.indexOf("[")&&-1===e.indexOf("::")&&(-1!==e.indexOf(".")||e.split(":").length<=2))}class tk{src;listen;hostname;port;didConnect;reconnects;lastConnect;gossiped;tlsName;resolves;constructor(e,t=!1){this.src=e,this.tlsName="";let s=function(e){(e=e.trim()).match(/^(.*:\/\/)(.*)/m)&&(e=e.replace(/^(.*:\/\/)(.*)/gm,"$2")),tP(e=function(e){let t="::FFFF:",s=e.toUpperCase().indexOf(t);if(-1!==s&&-1!==e.indexOf(".")){let r=e.substring(s+t.length);return(r=r.replace("[","")).replace("]","")}return e}(e))&&-1===e.indexOf("[")&&(e=`[${e}]`);let t=tP(e)?e.match(/(]:)(\d+)/):e.match(/(:)(\d+)/),s=t&&3===t.length&&t[1]&&t[2]?parseInt(t[2]):4222,r=new URL(`${80===s?"https":"http"}://${e}`);r.port=`${s}`;let i=r.hostname;return"["===i.charAt(0)&&(i=i.substring(1,i.length-1)),{listen:r.host,hostname:i,port:s}}(e);this.listen=s.listen,this.hostname=s.hostname,this.port=s.port,this.didConnect=!1,this.reconnects=0,this.lastConnect=0,this.gossiped=t}toString(){return this.listen}async resolve(e){if(!e.fn||!1===e.resolve)return[this];let t=[];if(tx(this.hostname))return[this];{let s=await e.fn(this.hostname);for(let r of(e.debug&&console.log(`resolve ${this.hostname} = ${s.join(",")}`),s)){let e=80===this.port?"https":"http",s=new URL(`${e}://${tP(r)?"["+r+"]":r}`);s.port=`${this.port}`;let i=new tk(s.host,!1);i.tlsName=this.hostname,t.push(i)}}return e.randomize&&eM(t),this.resolves=t,t}}class tC{firstSelect;servers;currentServer;tlsName;randomize;constructor(e=[],t={}){this.firstSelect=!0,this.servers=[],this.tlsName="",this.randomize=t.randomize||!1;let s=ty();e&&(e.forEach(e=>{e=s?s(e):e,this.servers.push(new tk(e))}),this.randomize&&(this.servers=eM(this.servers))),0===this.servers.length&&this.addServer(`${ek}:${t_()}`,!1),this.currentServer=this.servers[0]}clear(){this.servers.length=0}updateTLSName(){let e=this.getCurrentServer();tx(e.hostname)||(this.tlsName=e.hostname,this.servers.forEach(e=>{e.gossiped&&(e.tlsName=this.tlsName)}))}getCurrentServer(){return this.currentServer}addServer(e,t=!1){let s=ty(),r=new tk(e=s?s(e):e,t);tx(r.hostname)&&(r.tlsName=this.tlsName),this.servers.push(r)}selectServer(){if(this.firstSelect)return this.firstSelect=!1,this.currentServer;let e=this.servers.shift();return e&&(this.servers.push(e),this.currentServer=e),e}removeCurrentServer(){this.removeServer(this.currentServer)}removeServer(e){if(e){let t=this.servers.indexOf(e);this.servers.splice(t,1)}}length(){return this.servers.length}next(){return this.servers.length?this.servers[0]:void 0}getServers(){return this.servers}update(e,t){let s=[],r=[],i=ty(),n=new Map;e.connect_urls&&e.connect_urls.length>0&&e.connect_urls.forEach(e=>{let s=new tk(e=i?i(e,t):e,!0);n.set(e,s)});let o=[];return this.servers.forEach((e,t)=>{let s=e.listen;e.gossiped&&this.currentServer.listen!==s&&void 0===n.get(s)&&o.push(t),n.delete(s)}),o.reverse(),o.forEach(e=>{let t=this.servers.splice(e,1);r=r.concat(t[0].listen)}),n.forEach((e,t)=>{this.servers.push(e),s.push(t)}),{added:s,deleted:r}}}class tO{baseInbox;reqs;constructor(){this.reqs=new Map}size(){return this.reqs.size}init(e){return this.baseInbox=`${eP(e)}.`,this.baseInbox}add(e){isNaN(e.received)||(e.received=0),this.reqs.set(e.token,e)}get(e){return this.reqs.get(e)}cancel(e){this.reqs.delete(e.token)}getToken(e){let t=e.subject||"";return 0===t.indexOf(this.baseInbox)?t.substring(this.baseInbox.length):null}all(){return Array.from(this.reqs.values())}handleError(e,t){if(t&&t.permissionContext){if(e)return this.all().forEach(e=>{e.resolver(t,{})}),!0;let s=t.permissionContext;if("publish"===s.operation){let e=this.all().find(e=>e.requestSubject===s.subject);if(e)return e.resolver(t,{}),!0}}return!1}dispatcher(){return(e,t)=>{let s=this.getToken(t);if(s){let r=this.get(s);r&&(null===e&&t.headers&&(e=eH(t)),r.resolver(e,t))}}}close(){let e=ev.errorForCode(n.Timeout);this.reqs.forEach(t=>{t.resolver(e,{})})}}class tj{ph;interval;maxOut;timer;pendings;constructor(e,t,s){this.ph=e,this.interval=t,this.maxOut=s,this.pendings=[]}start(){this.cancel(),this._schedule()}cancel(e){this.timer&&(clearTimeout(this.timer),this.timer=void 0),this._reset(),e&&this.ph.disconnect()}_schedule(){this.timer=setTimeout(()=>{if(this.ph.dispatchStatus({type:i.PingTimer,data:`${this.pendings.length+1}`}),this.pendings.length===this.maxOut){this.cancel(!0);return}let e=eN();this.ph.flush(e).then(()=>{this._reset()}).catch(()=>{this.cancel()}),this.pendings.push(e),this._schedule()},this.interval)}_reset(){this.pendings=this.pendings.filter(e=>(e.resolve(),!1))}}class tI extends Error{constructor(e){super(e),this.name="AssertionError"}}let tN=4294967296-2;function tM(e,t,s=0){let r=t.byteLength-s;return e.byteLength>r&&(e=e.subarray(0,r)),t.set(e,s),e.byteLength}class tR{_buf;_off;constructor(e){if(this._off=0,null==e){this._buf=new Uint8Array(0);return}this._buf=new Uint8Array(e)}bytes(e={copy:!0}){return!1===e.copy?this._buf.subarray(this._off):this._buf.slice(this._off)}empty(){return this._buf.byteLength<=this._off}get length(){return this._buf.byteLength-this._off}get capacity(){return this._buf.buffer.byteLength}truncate(e){if(0===e){this.reset();return}if(e<0||e>this.length)throw Error("bytes.Buffer: truncation out of range");this._reslice(this._off+e)}reset(){this._reslice(0),this._off=0}_tryGrowByReslice(e){let t=this._buf.byteLength;return e<=this.capacity-t?(this._reslice(t+e),t):-1}_reslice(e){!function(e,t="Assertion failed."){if(!e)throw new tI(t)}(e<=this._buf.buffer.byteLength),this._buf=new Uint8Array(this._buf.buffer,0,e)}readByte(){let e=new Uint8Array(1);return this.read(e)?e[0]:null}read(e){if(this.empty())return(this.reset(),0===e.byteLength)?0:null;let t=tM(this._buf.subarray(this._off),e);return this._off+=t,t}writeByte(e){return this.write(Uint8Array.of(e))}writeString(e){return this.write(ef.encode(e))}write(e){let t=this._grow(e.byteLength);return tM(e,this._buf,t)}_grow(e){let t=this.length;0===t&&0!==this._off&&this.reset();let s=this._tryGrowByReslice(e);if(s>=0)return s;let r=this.capacity;if(e<=Math.floor(r/2)-t)tM(this._buf.subarray(this._off),this._buf);else if(r+e>tN)throw Error("The buffer cannot be grown beyond the maximum size.");else{let t=new Uint8Array(Math.min(2*r+e,tN));tM(this._buf.subarray(this._off),t),this._buf=t}return this._off=0,this._reslice(Math.min(t+e,tN)),t}grow(e){if(e<0)throw Error("Buffer._grow: negative count");let t=this._grow(e);this._reslice(t)}readFrom(e){let t=0,s=new Uint8Array(32768);for(;;){let r=this.capacity-this.length<32768,i=r?s:new Uint8Array(this._buf.buffer,this.length),n=e.read(i);if(null===n)return t;r?this.write(i.subarray(0,n)):this._reslice(this.length+n),t+=n}}}function tT(){let e={};return e.sid=-1,e.hdr=-1,e.size=-1,e}(es=A||(A={}))[es.OK=0]="OK",es[es.ERR=1]="ERR",es[es.MSG=2]="MSG",es[es.INFO=3]="INFO",es[es.PING=4]="PING",es[es.PONG=5]="PONG";class t${dispatcher;state;as;drop;hdr;ma;argBuf;msgBuf;constructor(e){this.dispatcher=e,this.state=P.OP_START,this.as=0,this.drop=0,this.hdr=0}parse(e){let t;for(t=0;t<e.length;t++){let s=e[t];switch(this.state){case P.OP_START:switch(s){case k.M:case k.m:this.state=P.OP_M,this.hdr=-1,this.ma=tT();break;case k.H:case k.h:this.state=P.OP_H,this.hdr=0,this.ma=tT();break;case k.P:case k.p:this.state=P.OP_P;break;case k.PLUS:this.state=P.OP_PLUS;break;case k.MINUS:this.state=P.OP_MINUS;break;case k.I:case k.i:this.state=P.OP_I;break;default:throw this.fail(e.subarray(t))}break;case P.OP_H:switch(s){case k.M:case k.m:this.state=P.OP_M;break;default:throw this.fail(e.subarray(t))}break;case P.OP_M:switch(s){case k.S:case k.s:this.state=P.OP_MS;break;default:throw this.fail(e.subarray(t))}break;case P.OP_MS:switch(s){case k.G:case k.g:this.state=P.OP_MSG;break;default:throw this.fail(e.subarray(t))}break;case P.OP_MSG:switch(s){case k.SPACE:case k.TAB:this.state=P.OP_MSG_SPC;break;default:throw this.fail(e.subarray(t))}break;case P.OP_MSG_SPC:switch(s){case k.SPACE:case k.TAB:continue;default:this.state=P.MSG_ARG,this.as=t}break;case P.MSG_ARG:switch(s){case k.CR:this.drop=1;break;case k.NL:{let s=this.argBuf?this.argBuf.bytes():e.subarray(this.as,t-this.drop);this.processMsgArgs(s),this.drop=0,this.as=t+1,this.state=P.MSG_PAYLOAD,t=this.as+this.ma.size-1;break}default:this.argBuf&&this.argBuf.writeByte(s)}break;case P.MSG_PAYLOAD:if(this.msgBuf){if(this.msgBuf.length>=this.ma.size){let e=this.msgBuf.bytes({copy:!1});this.dispatcher.push({kind:A.MSG,msg:this.ma,data:e}),this.argBuf=void 0,this.msgBuf=void 0,this.state=P.MSG_END}else{let r=this.ma.size-this.msgBuf.length,i=e.length-t;i<r&&(r=i),r>0?(this.msgBuf.write(e.subarray(t,t+r)),t=t+r-1):this.msgBuf.writeByte(s)}}else t-this.as>=this.ma.size&&(this.dispatcher.push({kind:A.MSG,msg:this.ma,data:e.subarray(this.as,t)}),this.argBuf=void 0,this.msgBuf=void 0,this.state=P.MSG_END);break;case P.MSG_END:if(s!==k.NL)continue;this.drop=0,this.as=t+1,this.state=P.OP_START;break;case P.OP_PLUS:switch(s){case k.O:case k.o:this.state=P.OP_PLUS_O;break;default:throw this.fail(e.subarray(t))}break;case P.OP_PLUS_O:switch(s){case k.K:case k.k:this.state=P.OP_PLUS_OK;break;default:throw this.fail(e.subarray(t))}break;case P.OP_PLUS_OK:s===k.NL&&(this.dispatcher.push({kind:A.OK}),this.drop=0,this.state=P.OP_START);break;case P.OP_MINUS:switch(s){case k.E:case k.e:this.state=P.OP_MINUS_E;break;default:throw this.fail(e.subarray(t))}break;case P.OP_MINUS_E:switch(s){case k.R:case k.r:this.state=P.OP_MINUS_ER;break;default:throw this.fail(e.subarray(t))}break;case P.OP_MINUS_ER:switch(s){case k.R:case k.r:this.state=P.OP_MINUS_ERR;break;default:throw this.fail(e.subarray(t))}break;case P.OP_MINUS_ERR:switch(s){case k.SPACE:case k.TAB:this.state=P.OP_MINUS_ERR_SPC;break;default:throw this.fail(e.subarray(t))}break;case P.OP_MINUS_ERR_SPC:switch(s){case k.SPACE:case k.TAB:continue;default:this.state=P.MINUS_ERR_ARG,this.as=t}break;case P.MINUS_ERR_ARG:switch(s){case k.CR:this.drop=1;break;case k.NL:{let s;this.argBuf?(s=this.argBuf.bytes(),this.argBuf=void 0):s=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:A.ERR,data:s}),this.drop=0,this.as=t+1,this.state=P.OP_START;break}default:this.argBuf&&this.argBuf.write(Uint8Array.of(s))}break;case P.OP_P:switch(s){case k.I:case k.i:this.state=P.OP_PI;break;case k.O:case k.o:this.state=P.OP_PO;break;default:throw this.fail(e.subarray(t))}break;case P.OP_PO:switch(s){case k.N:case k.n:this.state=P.OP_PON;break;default:throw this.fail(e.subarray(t))}break;case P.OP_PON:switch(s){case k.G:case k.g:this.state=P.OP_PONG;break;default:throw this.fail(e.subarray(t))}break;case P.OP_PONG:s===k.NL&&(this.dispatcher.push({kind:A.PONG}),this.drop=0,this.state=P.OP_START);break;case P.OP_PI:switch(s){case k.N:case k.n:this.state=P.OP_PIN;break;default:throw this.fail(e.subarray(t))}break;case P.OP_PIN:switch(s){case k.G:case k.g:this.state=P.OP_PING;break;default:throw this.fail(e.subarray(t))}break;case P.OP_PING:s===k.NL&&(this.dispatcher.push({kind:A.PING}),this.drop=0,this.state=P.OP_START);break;case P.OP_I:switch(s){case k.N:case k.n:this.state=P.OP_IN;break;default:throw this.fail(e.subarray(t))}break;case P.OP_IN:switch(s){case k.F:case k.f:this.state=P.OP_INF;break;default:throw this.fail(e.subarray(t))}break;case P.OP_INF:switch(s){case k.O:case k.o:this.state=P.OP_INFO;break;default:throw this.fail(e.subarray(t))}break;case P.OP_INFO:switch(s){case k.SPACE:case k.TAB:this.state=P.OP_INFO_SPC;break;default:throw this.fail(e.subarray(t))}break;case P.OP_INFO_SPC:switch(s){case k.SPACE:case k.TAB:continue;default:this.state=P.INFO_ARG,this.as=t}break;case P.INFO_ARG:switch(s){case k.CR:this.drop=1;break;case k.NL:{let s;this.argBuf?(s=this.argBuf.bytes(),this.argBuf=void 0):s=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:A.INFO,data:s}),this.drop=0,this.as=t+1,this.state=P.OP_START;break}default:this.argBuf&&this.argBuf.writeByte(s)}break;default:throw this.fail(e.subarray(t))}}this.state!==P.MSG_ARG&&this.state!==P.MINUS_ERR_ARG&&this.state!==P.INFO_ARG||this.argBuf||(this.argBuf=new tR(e.subarray(this.as,t-this.drop))),this.state!==P.MSG_PAYLOAD||this.msgBuf||(this.argBuf||this.cloneMsgArg(),this.msgBuf=new tR(e.subarray(this.as)))}cloneMsgArg(){let e=this.ma.subject.length,t=new Uint8Array(e+(this.ma.reply?this.ma.reply.length:0));t.set(this.ma.subject),this.ma.reply&&t.set(this.ma.reply,e),this.argBuf=new tR(t),this.ma.subject=t.subarray(0,e),this.ma.reply&&(this.ma.reply=t.subarray(e))}processMsgArgs(e){if(this.hdr>=0)return this.processHeaderMsgArgs(e);let t=[],s=-1;for(let r=0;r<e.length;r++)switch(e[r]){case k.SPACE:case k.TAB:case k.CR:case k.NL:s>=0&&(t.push(e.subarray(s,r)),s=-1);break;default:s<0&&(s=r)}switch(s>=0&&t.push(e.subarray(s)),t.length){case 3:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.size=this.protoParseInt(t[2]);break;case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.size=this.protoParseInt(t[3]);break;default:throw this.fail(e,"processMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processMsgArgs Bad or Missing Sid Error");if(this.ma.size<0)throw this.fail(e,"processMsgArgs Bad or Missing Size Error")}fail(e,t=""){return t=t?`${t} [${this.state}]`:`parse error [${this.state}]`,Error(`${t}: ${ep.decode(e)}`)}processHeaderMsgArgs(e){let t=[],s=-1;for(let r=0;r<e.length;r++)switch(e[r]){case k.SPACE:case k.TAB:case k.CR:case k.NL:s>=0&&(t.push(e.subarray(s,r)),s=-1);break;default:s<0&&(s=r)}switch(s>=0&&t.push(e.subarray(s)),t.length){case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.hdr=this.protoParseInt(t[2]),this.ma.size=this.protoParseInt(t[3]);break;case 5:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.hdr=this.protoParseInt(t[3]),this.ma.size=this.protoParseInt(t[4]);break;default:throw this.fail(e,"processHeaderMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Sid Error");if(this.ma.hdr<0||this.ma.hdr>this.ma.size)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Header Size Error");if(this.ma.size<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Size Error")}protoParseInt(e){if(0===e.length)return -1;let t=0;for(let s=0;s<e.length;s++){if(e[s]<48||e[s]>57)return -1;t=10*t+(e[s]-48)}return t}}(er=P||(P={}))[er.OP_START=0]="OP_START",er[er.OP_PLUS=1]="OP_PLUS",er[er.OP_PLUS_O=2]="OP_PLUS_O",er[er.OP_PLUS_OK=3]="OP_PLUS_OK",er[er.OP_MINUS=4]="OP_MINUS",er[er.OP_MINUS_E=5]="OP_MINUS_E",er[er.OP_MINUS_ER=6]="OP_MINUS_ER",er[er.OP_MINUS_ERR=7]="OP_MINUS_ERR",er[er.OP_MINUS_ERR_SPC=8]="OP_MINUS_ERR_SPC",er[er.MINUS_ERR_ARG=9]="MINUS_ERR_ARG",er[er.OP_M=10]="OP_M",er[er.OP_MS=11]="OP_MS",er[er.OP_MSG=12]="OP_MSG",er[er.OP_MSG_SPC=13]="OP_MSG_SPC",er[er.MSG_ARG=14]="MSG_ARG",er[er.MSG_PAYLOAD=15]="MSG_PAYLOAD",er[er.MSG_END=16]="MSG_END",er[er.OP_H=17]="OP_H",er[er.OP_P=18]="OP_P",er[er.OP_PI=19]="OP_PI",er[er.OP_PIN=20]="OP_PIN",er[er.OP_PING=21]="OP_PING",er[er.OP_PO=22]="OP_PO",er[er.OP_PON=23]="OP_PON",er[er.OP_PONG=24]="OP_PONG",er[er.OP_I=25]="OP_I",er[er.OP_IN=26]="OP_IN",er[er.OP_INF=27]="OP_INF",er[er.OP_INFO=28]="OP_INFO",er[er.OP_INFO_SPC=29]="OP_INFO_SPC",er[er.INFO_ARG=30]="INFO_ARG",(ei=k||(k={}))[ei.CR="\r".charCodeAt(0)]="CR",ei[ei.E="E".charCodeAt(0)]="E",ei[ei.e="e".charCodeAt(0)]="e",ei[ei.F="F".charCodeAt(0)]="F",ei[ei.f="f".charCodeAt(0)]="f",ei[ei.G="G".charCodeAt(0)]="G",ei[ei.g="g".charCodeAt(0)]="g",ei[ei.H="H".charCodeAt(0)]="H",ei[ei.h="h".charCodeAt(0)]="h",ei[ei.I="I".charCodeAt(0)]="I",ei[ei.i="i".charCodeAt(0)]="i",ei[ei.K="K".charCodeAt(0)]="K",ei[ei.k="k".charCodeAt(0)]="k",ei[ei.M="M".charCodeAt(0)]="M",ei[ei.m="m".charCodeAt(0)]="m",ei[ei.MINUS="-".charCodeAt(0)]="MINUS",ei[ei.N="N".charCodeAt(0)]="N",ei[ei.n="n".charCodeAt(0)]="n",ei[ei.NL="\n".charCodeAt(0)]="NL",ei[ei.O="O".charCodeAt(0)]="O",ei[ei.o="o".charCodeAt(0)]="o",ei[ei.P="P".charCodeAt(0)]="P",ei[ei.p="p".charCodeAt(0)]="p",ei[ei.PLUS="+".charCodeAt(0)]="PLUS",ei[ei.R="R".charCodeAt(0)]="R",ei[ei.r="r".charCodeAt(0)]="r",ei[ei.S="S".charCodeAt(0)]="S",ei[ei.s="s".charCodeAt(0)]="s",ei[ei.SPACE=" ".charCodeAt(0)]="SPACE",ei[ei.TAB="	".charCodeAt(0)]="TAB",function(e){var t,s=function(e,t){this.hi=0|e,this.lo=0|t},r=function(e){var t,s=new Float64Array(16);if(e)for(t=0;t<e.length;t++)s[t]=e[t];return s},i=function(){throw Error("no PRNG")},n=new Uint8Array(16),o=new Uint8Array(32);o[0]=9;var a=r(),c=r([1]),h=r([56129,1]),l=r([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),u=r([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),d=r([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),f=r([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),p=r([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function m(e,t){return e<<t|e>>>32-t}function g(e,t){var s=255&e[t+3];return(s=(s=s<<8|255&e[t+2])<<8|255&e[t+1])<<8|255&e[t+0]}function b(e,t){return new s(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],e[t+4]<<24|e[t+5]<<16|e[t+6]<<8|e[t+7])}function _(e,t,s){var r;for(r=0;r<4;r++)e[t+r]=255&s,s>>>=8}function y(e,t,s){e[t]=s.hi>>24&255,e[t+1]=s.hi>>16&255,e[t+2]=s.hi>>8&255,e[t+3]=255&s.hi,e[t+4]=s.lo>>24&255,e[t+5]=s.lo>>16&255,e[t+6]=s.lo>>8&255,e[t+7]=255&s.lo}function w(e,t,s,r,i){var n,o=0;for(n=0;n<i;n++)o|=e[t+n]^s[r+n];return(1&o-1>>>8)-1}function S(e,t,s,r){return w(e,t,s,r,16)}function v(e,t,s,r){return w(e,t,s,r,32)}function E(e,t,s,r,i){var n,o,a,c=new Uint32Array(16),h=new Uint32Array(16),l=new Uint32Array(16),u=new Uint32Array(4);for(n=0;n<4;n++)h[5*n]=g(r,4*n),h[1+n]=g(s,4*n),h[6+n]=g(t,4*n),h[11+n]=g(s,16+4*n);for(n=0;n<16;n++)l[n]=h[n];for(n=0;n<20;n++){for(o=0;o<4;o++){for(a=0;a<4;a++)u[a]=h[(5*o+4*a)%16];for(u[1]^=m(u[0]+u[3]|0,7),u[2]^=m(u[1]+u[0]|0,9),u[3]^=m(u[2]+u[1]|0,13),u[0]^=m(u[3]+u[2]|0,18),a=0;a<4;a++)c[4*o+(o+a)%4]=u[a]}for(a=0;a<16;a++)h[a]=c[a]}if(i){for(n=0;n<16;n++)h[n]=h[n]+l[n]|0;for(n=0;n<4;n++)h[5*n]=h[5*n]-g(r,4*n)|0,h[6+n]=h[6+n]-g(t,4*n)|0;for(n=0;n<4;n++)_(e,4*n,h[5*n]),_(e,16+4*n,h[6+n])}else for(n=0;n<16;n++)_(e,4*n,h[n]+l[n]|0)}function x(e,t,s,r){return E(e,t,s,r,!0),0}var A=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function P(e,t,s,r,i,n,o){var a,c,h=new Uint8Array(16),l=new Uint8Array(64);if(!i)return 0;for(c=0;c<16;c++)h[c]=0;for(c=0;c<8;c++)h[c]=n[c];for(;i>=64;){for(E(l,h,o,A,!1),c=0;c<64;c++)e[t+c]=(s?s[r+c]:0)^l[c];for(c=8,a=1;c<16;c++)a=a+(255&h[c])|0,h[c]=255&a,a>>>=8;i-=64,t+=64,s&&(r+=64)}if(i>0)for(E(l,h,o,A,!1),c=0;c<i;c++)e[t+c]=(s?s[r+c]:0)^l[c];return 0}function k(e,t,s,r,i){return P(e,t,null,0,s,r,i)}function C(e,t,s,r,i){var n=new Uint8Array(32);return x(n,r,i,A),k(e,t,s,r.subarray(16),n)}function O(e,t,s,r,i,n,o){var a=new Uint8Array(32);return x(a,n,o,A),P(e,t,s,r,i,n.subarray(16),a)}function j(e,t){var s,r=0;for(s=0;s<17;s++)r=r+(e[s]+t[s]|0)|0,e[s]=255&r,r>>>=8}var I=new Uint32Array([5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,252]);function N(e,t,s,r,i,n){var o,a,c,h,l=new Uint32Array(17),u=new Uint32Array(17),d=new Uint32Array(17),f=new Uint32Array(17),p=new Uint32Array(17);for(c=0;c<17;c++)u[c]=d[c]=0;for(c=0;c<16;c++)u[c]=n[c];for(u[3]&=15,u[4]&=252,u[7]&=15,u[8]&=252,u[11]&=15,u[12]&=252,u[15]&=15;i>0;){for(c=0;c<17;c++)f[c]=0;for(c=0;c<16&&c<i;++c)f[c]=s[r+c];for(f[c]=1,r+=c,i-=c,j(d,f),a=0;a<17;a++)for(c=0,l[a]=0;c<17;c++)l[a]=l[a]+d[c]*(c<=a?u[a-c]:320*u[a+17-c]|0)|0;for(a=0;a<17;a++)d[a]=l[a];for(c=0,h=0;c<16;c++)h=h+d[c]|0,d[c]=255&h,h>>>=8;for(c=0,h=h+d[16]|0,d[16]=3&h,h=5*(h>>>2)|0;c<16;c++)h=h+d[c]|0,d[c]=255&h,h>>>=8;h=h+d[16]|0,d[16]=h}for(c=0;c<17;c++)p[c]=d[c];for(j(d,I),o=0|-(d[16]>>>7),c=0;c<17;c++)d[c]^=o&(p[c]^d[c]);for(c=0;c<16;c++)f[c]=n[c+16];for(f[16]=0,j(d,f),c=0;c<16;c++)e[t+c]=d[c];return 0}function M(e,t,s,r,i,n){var o=new Uint8Array(16);return N(o,0,s,r,i,n),S(e,t,o,0)}function R(e,t,s,r,i){var n;if(s<32)return -1;for(O(e,0,t,0,s,r,i),N(e,16,e,32,s-32,e),n=0;n<16;n++)e[n]=0;return 0}function T(e,t,s,r,i){var n,o=new Uint8Array(32);if(s<32||(C(o,0,32,r,i),0!==M(t,16,t,32,s-32,o)))return -1;for(O(e,0,t,0,s,r,i),n=0;n<32;n++)e[n]=0;return 0}function $(e,t){var s;for(s=0;s<16;s++)e[s]=0|t[s]}function U(e){var t,s;for(s=0;s<16;s++)e[s]+=65536,t=Math.floor(e[s]/65536),e[(s+1)*(s<15?1:0)]+=t-1+37*(t-1)*(15===s?1:0),e[s]-=65536*t}function q(e,t,s){for(var r,i=~(s-1),n=0;n<16;n++)r=i&(e[n]^t[n]),e[n]^=r,t[n]^=r}function F(e,t){var s,i,n,o=r(),a=r();for(s=0;s<16;s++)a[s]=t[s];for(U(a),U(a),U(a),i=0;i<2;i++){for(s=1,o[0]=a[0]-65517;s<15;s++)o[s]=a[s]-65535-(o[s-1]>>16&1),o[s-1]&=65535;o[15]=a[15]-32767-(o[14]>>16&1),n=o[15]>>16&1,o[14]&=65535,q(a,o,1-n)}for(s=0;s<16;s++)e[2*s]=255&a[s],e[2*s+1]=a[s]>>8}function L(e,t){var s=new Uint8Array(32),r=new Uint8Array(32);return F(s,e),F(r,t),v(s,0,r,0)}function B(e){var t=new Uint8Array(32);return F(t,e),1&t[0]}function D(e,t){var s;for(s=0;s<16;s++)e[s]=t[2*s]+(t[2*s+1]<<8);e[15]&=32767}function H(e,t,s){var r;for(r=0;r<16;r++)e[r]=t[r]+s[r]|0}function J(e,t,s){var r;for(r=0;r<16;r++)e[r]=t[r]-s[r]|0}function z(e,t,s){var r,i,n=new Float64Array(31);for(r=0;r<31;r++)n[r]=0;for(r=0;r<16;r++)for(i=0;i<16;i++)n[r+i]+=t[r]*s[i];for(r=0;r<15;r++)n[r]+=38*n[r+16];for(r=0;r<16;r++)e[r]=n[r];U(e),U(e)}function G(e,t){z(e,t,t)}function K(e,t){var s,i=r();for(s=0;s<16;s++)i[s]=t[s];for(s=253;s>=0;s--)G(i,i),2!==s&&4!==s&&z(i,i,t);for(s=0;s<16;s++)e[s]=i[s]}function V(e,t){var s,i=r();for(s=0;s<16;s++)i[s]=t[s];for(s=250;s>=0;s--)G(i,i),1!==s&&z(i,i,t);for(s=0;s<16;s++)e[s]=i[s]}function W(e,t,s){var i,n,o=new Uint8Array(32),a=new Float64Array(80),c=r(),l=r(),u=r(),d=r(),f=r(),p=r();for(n=0;n<31;n++)o[n]=t[n];for(o[31]=127&t[31]|64,o[0]&=248,D(a,s),n=0;n<16;n++)l[n]=a[n],d[n]=c[n]=u[n]=0;for(n=254,c[0]=d[0]=1;n>=0;--n)q(c,l,i=o[n>>>3]>>>(7&n)&1),q(u,d,i),H(f,c,u),J(c,c,u),H(u,l,d),J(l,l,d),G(d,f),G(p,c),z(c,u,c),z(u,l,f),H(f,c,u),J(c,c,u),G(l,c),J(u,d,p),z(c,u,h),H(c,c,d),z(u,u,c),z(c,d,p),z(d,l,a),G(l,f),q(c,l,i),q(u,d,i);for(n=0;n<16;n++)a[n+16]=c[n],a[n+32]=u[n],a[n+48]=l[n],a[n+64]=d[n];var m=a.subarray(32),g=a.subarray(16);return K(m,m),z(g,g,m),F(e,g),0}function Y(e,t){return W(e,t,o)}function X(e,t){return i(t,32),Y(e,t)}function Q(e,t,s){var r=new Uint8Array(32);return W(r,s,t),x(e,n,r,A)}function Z(){var e,t,r,i=0,n=0,o=0,a=0;for(r=0;r<arguments.length;r++)e=arguments[r].lo,t=arguments[r].hi,i+=65535&e,n+=e>>>16,o+=65535&t,a+=t>>>16;return n+=i>>>16,o+=n>>>16,a+=o>>>16,new s(65535&o|a<<16,65535&i|n<<16)}function ee(e,t){return new s(e.hi>>>t,e.lo>>>t|e.hi<<32-t)}function et(){var e,t=0,r=0;for(e=0;e<arguments.length;e++)t^=arguments[e].lo,r^=arguments[e].hi;return new s(r,t)}function es(e,t){var r,i,n=32-t;return t<32?(r=e.hi>>>t|e.lo<<n,i=e.lo>>>t|e.hi<<n):t<64&&(r=e.lo>>>t|e.hi<<n,i=e.hi>>>t|e.lo<<n),new s(r,i)}var er=[new s(1116352408,3609767458),new s(1899447441,602891725),new s(3049323471,3964484399),new s(3921009573,2173295548),new s(961987163,4081628472),new s(1508970993,3053834265),new s(2453635748,2937671579),new s(2870763221,3664609560),new s(3624381080,2734883394),new s(310598401,1164996542),new s(607225278,1323610764),new s(1426881987,3590304994),new s(1925078388,4068182383),new s(2162078206,991336113),new s(2614888103,633803317),new s(3248222580,3479774868),new s(3835390401,2666613458),new s(4022224774,944711139),new s(264347078,2341262773),new s(604807628,2007800933),new s(770255983,1495990901),new s(1249150122,1856431235),new s(1555081692,3175218132),new s(1996064986,2198950837),new s(2554220882,3999719339),new s(2821834349,766784016),new s(2952996808,2566594879),new s(3210313671,3203337956),new s(3336571891,1034457026),new s(3584528711,2466948901),new s(113926993,3758326383),new s(338241895,168717936),new s(666307205,1188179964),new s(773529912,1546045734),new s(1294757372,1522805485),new s(1396182291,2643833823),new s(1695183700,2343527390),new s(1986661051,1014477480),new s(2177026350,1206759142),new s(2456956037,344077627),new s(2730485921,1290863460),new s(2820302411,3158454273),new s(3259730800,3505952657),new s(3345764771,106217008),new s(3516065817,3606008344),new s(3600352804,1432725776),new s(4094571909,1467031594),new s(275423344,851169720),new s(430227734,3100823752),new s(506948616,1363258195),new s(659060556,3750685593),new s(883997877,3785050280),new s(958139571,3318307427),new s(1322822218,3812723403),new s(1537002063,2003034995),new s(1747873779,3602036899),new s(1955562222,1575990012),new s(2024104815,1125592928),new s(2227730452,2716904306),new s(2361852424,442776044),new s(2428436474,593698344),new s(2756734187,3733110249),new s(3204031479,2999351573),new s(3329325298,3815920427),new s(3391569614,3928383900),new s(3515267271,566280711),new s(3940187606,3454069534),new s(4118630271,4000239992),new s(116418474,1914138554),new s(174292421,2731055270),new s(289380356,3203993006),new s(460393269,320620315),new s(685471733,587496836),new s(852142971,1086792851),new s(1017036298,365543100),new s(1126000580,2618297676),new s(1288033470,3409855158),new s(1501505948,4234509866),new s(1607167915,987167468),new s(1816402316,1246189591)];function ei(e,t,r){var i,n,o,a,c,h,l,u,d,f,p,m,g,_=[],w=[],S=[],v=[];for(m=0;m<8;m++)_[m]=S[m]=b(e,8*m);for(var E=0;r>=128;){for(m=0;m<16;m++)v[m]=b(t,8*m+E);for(m=0;m<80;m++){for(g=0;g<8;g++)w[g]=S[g];for(g=0,p=Z(S[7],et(es(i=S[4],14),es(i,18),es(i,41)),(n=S[4],o=S[5],a=S[6],new s(n.hi&o.hi^~n.hi&a.hi,n.lo&o.lo^~n.lo&a.lo)),er[m],v[m%16]),w[7]=Z(p,et(es(c=S[0],28),es(c,34),es(c,39)),(h=S[0],l=S[1],u=S[2],new s(h.hi&l.hi^h.hi&u.hi^l.hi&u.hi,h.lo&l.lo^h.lo&u.lo^l.lo&u.lo))),w[3]=Z(w[3],p);g<8;g++)S[(g+1)%8]=w[g];if(m%16==15)for(g=0;g<16;g++)v[g]=Z(v[g],v[(g+9)%16],et(es(d=v[(g+1)%16],1),es(d,8),ee(d,7)),et(es(f=v[(g+14)%16],19),es(f,61),ee(f,6)))}for(m=0;m<8;m++)S[m]=Z(S[m],_[m]),_[m]=S[m];E+=128,r-=128}for(m=0;m<8;m++)y(e,8*m,_[m]);return r}var en=new Uint8Array([106,9,230,103,243,188,201,8,187,103,174,133,132,202,167,59,60,110,243,114,254,148,248,43,165,79,245,58,95,29,54,241,81,14,82,127,173,230,130,209,155,5,104,140,43,62,108,31,31,131,217,171,251,65,189,107,91,224,205,25,19,126,33,121]);function eo(e,t,r){var i,n=new Uint8Array(64),o=new Uint8Array(256),a=r;for(i=0;i<64;i++)n[i]=en[i];for(ei(n,t,r),r%=128,i=0;i<256;i++)o[i]=0;for(i=0;i<r;i++)o[i]=t[a-r+i];for(o[r]=128,o[(r=256-128*(r<112?1:0))-9]=0,y(o,r-8,new s(a/536870912|0,a<<3)),ei(n,o,r),i=0;i<64;i++)e[i]=n[i];return 0}function ea(e,t){var s=r(),i=r(),n=r(),o=r(),a=r(),c=r(),h=r(),l=r(),d=r();J(s,e[1],e[0]),J(d,t[1],t[0]),z(s,s,d),H(i,e[0],e[1]),H(d,t[0],t[1]),z(i,i,d),z(n,e[3],t[3]),z(n,n,u),z(o,e[2],t[2]),H(o,o,o),J(a,i,s),J(c,o,n),H(h,o,n),H(l,i,s),z(e[0],a,c),z(e[1],l,h),z(e[2],h,c),z(e[3],a,l)}function ec(e,t,s){var r;for(r=0;r<4;r++)q(e[r],t[r],s)}function eh(e,t){var s=r(),i=r(),n=r();K(n,t[2]),z(s,t[0],n),z(i,t[1],n),F(e,i),e[31]^=B(s)<<7}function el(e,t,s){var r,i;for($(e[0],a),$(e[1],c),$(e[2],c),$(e[3],a),i=255;i>=0;--i)ec(e,t,r=s[i/8|0]>>(7&i)&1),ea(t,e),ea(e,e),ec(e,t,r)}function eu(e,t){var s=[r(),r(),r(),r()];$(s[0],d),$(s[1],f),$(s[2],c),z(s[3],d,f),el(e,s,t)}function ed(e,t,s){var n,o=new Uint8Array(64),a=[r(),r(),r(),r()];for(s||i(t,32),eo(o,t,32),o[0]&=248,o[31]&=127,o[31]|=64,eu(a,o),eh(e,a),n=0;n<32;n++)t[n+32]=e[n];return 0}var ef=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function ep(e,t){var s,r,i,n;for(r=63;r>=32;--r){for(s=0,i=r-32,n=r-12;i<n;++i)t[i]+=s-16*t[r]*ef[i-(r-32)],s=Math.floor((t[i]+128)/256),t[i]-=256*s;t[i]+=s,t[r]=0}for(i=0,s=0;i<32;i++)t[i]+=s-(t[31]>>4)*ef[i],s=t[i]>>8,t[i]&=255;for(i=0;i<32;i++)t[i]-=s*ef[i];for(r=0;r<32;r++)t[r+1]+=t[r]>>8,e[r]=255&t[r]}function em(e){var t,s=new Float64Array(64);for(t=0;t<64;t++)s[t]=e[t];for(t=0;t<64;t++)e[t]=0;ep(e,s)}function eg(e,t,s,i){var n,o,a=new Uint8Array(64),c=new Uint8Array(64),h=new Uint8Array(64),l=new Float64Array(64),u=[r(),r(),r(),r()];for(eo(a,i,32),a[0]&=248,a[31]&=127,a[31]|=64,n=0;n<s;n++)e[64+n]=t[n];for(n=0;n<32;n++)e[32+n]=a[32+n];for(eo(h,e.subarray(32),s+32),em(h),eu(u,h),eh(e,u),n=32;n<64;n++)e[n]=i[n];for(eo(c,e,s+64),em(c),n=0;n<64;n++)l[n]=0;for(n=0;n<32;n++)l[n]=h[n];for(n=0;n<32;n++)for(o=0;o<32;o++)l[n+o]+=c[n]*a[o];return ep(e.subarray(32),l),s+64}function eb(e,t,s,i){var n,o,h,u,d,f,m,g,b=new Uint8Array(32),_=new Uint8Array(64),y=[r(),r(),r(),r()],w=[r(),r(),r(),r()];if(s<64||(n=r(),o=r(),h=r(),u=r(),d=r(),f=r(),m=r(),($(w[2],c),D(w[1],i),G(h,w[1]),z(u,h,l),J(h,h,w[2]),H(u,w[2],u),G(d,u),G(f,d),z(m,f,d),z(n,m,h),z(n,n,u),V(n,n),z(n,n,h),z(n,n,u),z(n,n,u),z(w[0],n,u),G(o,w[0]),z(o,o,u),L(o,h)&&z(w[0],w[0],p),G(o,w[0]),z(o,o,u),L(o,h))?-1:(B(w[0])===i[31]>>7&&J(w[0],a,w[0]),z(w[3],w[0],w[1]),0)))return -1;for(g=0;g<s;g++)e[g]=t[g];for(g=0;g<32;g++)e[g+32]=i[g];if(eo(_,e,s),em(_),el(y,w,_),eu(w,t.subarray(32)),ea(y,w),eh(b,y),s-=64,v(t,0,b,0)){for(g=0;g<s;g++)e[g]=0;return -1}for(g=0;g<s;g++)e[g]=t[g+64];return s}function e_(e,t){if(32!==e.length)throw Error("bad key size");if(24!==t.length)throw Error("bad nonce size")}function ey(){for(var e=0;e<arguments.length;e++)if(!(arguments[e]instanceof Uint8Array))throw TypeError("unexpected type, use Uint8Array")}function ew(e){for(var t=0;t<e.length;t++)e[t]=0}e.lowlevel={crypto_core_hsalsa20:x,crypto_stream_xor:O,crypto_stream:C,crypto_stream_salsa20_xor:P,crypto_stream_salsa20:k,crypto_onetimeauth:N,crypto_onetimeauth_verify:M,crypto_verify_16:S,crypto_verify_32:v,crypto_secretbox:R,crypto_secretbox_open:T,crypto_scalarmult:W,crypto_scalarmult_base:Y,crypto_box_beforenm:Q,crypto_box_afternm:R,crypto_box:function(e,t,s,r,i,n){var o=new Uint8Array(32);return Q(o,i,n),R(e,t,s,r,o)},crypto_box_open:function(e,t,s,r,i,n){var o=new Uint8Array(32);return Q(o,i,n),T(e,t,s,r,o)},crypto_box_keypair:X,crypto_hash:eo,crypto_sign:eg,crypto_sign_keypair:ed,crypto_sign_open:eb,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:16,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:64,crypto_sign_PUBLICKEYBYTES:32,crypto_sign_SECRETKEYBYTES:64,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:r,D:l,L:ef,pack25519:F,unpack25519:D,M:z,A:H,S:G,Z:J,pow2523:V,add:ea,set25519:$,modL:ep,scalarmult:el,scalarbase:eu},e.randomBytes=function(e){var t=new Uint8Array(e);return i(t,e),t},e.secretbox=function(e,t,s){ey(e,t,s),e_(s,t);for(var r=new Uint8Array(32+e.length),i=new Uint8Array(r.length),n=0;n<e.length;n++)r[n+32]=e[n];return R(i,r,r.length,t,s),i.subarray(16)},e.secretbox.open=function(e,t,s){ey(e,t,s),e_(s,t);for(var r=new Uint8Array(16+e.length),i=new Uint8Array(r.length),n=0;n<e.length;n++)r[n+16]=e[n];return r.length<32||0!==T(i,r,r.length,t,s)?null:i.subarray(32)},e.secretbox.keyLength=32,e.secretbox.nonceLength=24,e.secretbox.overheadLength=16,e.scalarMult=function(e,t){if(ey(e,t),32!==e.length)throw Error("bad n size");if(32!==t.length)throw Error("bad p size");var s=new Uint8Array(32);return W(s,e,t),s},e.scalarMult.base=function(e){if(ey(e),32!==e.length)throw Error("bad n size");var t=new Uint8Array(32);return Y(t,e),t},e.scalarMult.scalarLength=32,e.scalarMult.groupElementLength=32,e.box=function(t,s,r,i){var n=e.box.before(r,i);return e.secretbox(t,s,n)},e.box.before=function(e,t){ey(e,t),function(e,t){if(32!==e.length)throw Error("bad public key size");if(32!==t.length)throw Error("bad secret key size")}(e,t);var s=new Uint8Array(32);return Q(s,e,t),s},e.box.after=e.secretbox,e.box.open=function(t,s,r,i){var n=e.box.before(r,i);return e.secretbox.open(t,s,n)},e.box.open.after=e.secretbox.open,e.box.keyPair=function(){var e=new Uint8Array(32),t=new Uint8Array(32);return X(e,t),{publicKey:e,secretKey:t}},e.box.keyPair.fromSecretKey=function(e){if(ey(e),32!==e.length)throw Error("bad secret key size");var t=new Uint8Array(32);return Y(t,e),{publicKey:t,secretKey:new Uint8Array(e)}},e.box.publicKeyLength=32,e.box.secretKeyLength=32,e.box.sharedKeyLength=32,e.box.nonceLength=24,e.box.overheadLength=e.secretbox.overheadLength,e.sign=function(e,t){if(ey(e,t),64!==t.length)throw Error("bad secret key size");var s=new Uint8Array(64+e.length);return eg(s,e,e.length,t),s},e.sign.open=function(e,t){if(ey(e,t),32!==t.length)throw Error("bad public key size");var s=new Uint8Array(e.length),r=eb(s,e,e.length,t);if(r<0)return null;for(var i=new Uint8Array(r),n=0;n<i.length;n++)i[n]=s[n];return i},e.sign.detached=function(t,s){for(var r=e.sign(t,s),i=new Uint8Array(64),n=0;n<i.length;n++)i[n]=r[n];return i},e.sign.detached.verify=function(e,t,s){if(ey(e,t,s),64!==t.length)throw Error("bad signature size");if(32!==s.length)throw Error("bad public key size");var r,i=new Uint8Array(64+e.length),n=new Uint8Array(64+e.length);for(r=0;r<64;r++)i[r]=t[r];for(r=0;r<e.length;r++)i[r+64]=e[r];return eb(n,i,i.length,s)>=0},e.sign.keyPair=function(){var e=new Uint8Array(32),t=new Uint8Array(64);return ed(e,t),{publicKey:e,secretKey:t}},e.sign.keyPair.fromSecretKey=function(e){if(ey(e),64!==e.length)throw Error("bad secret key size");for(var t=new Uint8Array(32),s=0;s<t.length;s++)t[s]=e[32+s];return{publicKey:t,secretKey:new Uint8Array(e)}},e.sign.keyPair.fromSeed=function(e){if(ey(e),32!==e.length)throw Error("bad seed size");for(var t=new Uint8Array(32),s=new Uint8Array(64),r=0;r<32;r++)s[r]=e[r];return ed(t,s,!0),{publicKey:t,secretKey:s}},e.sign.publicKeyLength=32,e.sign.secretKeyLength=64,e.sign.seedLength=32,e.sign.signatureLength=64,e.hash=function(e){ey(e);var t=new Uint8Array(64);return eo(t,e,e.length),t},e.hash.hashLength=64,e.verify=function(e,t){return ey(e,t),0!==e.length&&0!==t.length&&e.length===t.length&&0===w(e,0,t,0,e.length)},e.setPRNG=function(e){i=e},(t="undefined"!=typeof globalThis?globalThis.crypto||globalThis.msCrypto:null)&&t.getRandomValues?e.setPRNG(function(e,s){var r,i=new Uint8Array(s);for(r=0;r<s;r+=65536)t.getRandomValues(i.subarray(r,r+Math.min(s-r,65536)));for(r=0;r<s;r++)e[r]=i[r];ew(i)}):"undefined"!=typeof require&&(t=require("crypto"))&&t.randomBytes&&e.setPRNG(function(e,s){var r,i=t.randomBytes(s);for(r=0;r<s;r++)e[r]=i[r];ew(i)})}("undefined"!=typeof module&&module.exports?module.exports:globalThis.nacl=globalThis.nacl||{});let tU="undefined"!=typeof module&&module.exports?module.exports:globalThis.nacl;tU.sign.keyPair.fromSeed,tU.sign.detached,tU.sign.detached.verify,tU.randomBytes,new Uint16Array([0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920]),(en=C||(C={})).InvalidPrefixByte="nkeys: invalid prefix byte",en.InvalidKey="nkeys: invalid key",en.InvalidPublicKey="nkeys: invalid public key",en.InvalidSeedLen="nkeys: invalid seed length",en.InvalidSeed="nkeys: invalid seed",en.InvalidEncoding="nkeys: invalid encoded key",en.InvalidSignature="nkeys: signature verification failed",en.CannotSign="nkeys: cannot sign, no private key available",en.PublicKeyOnly="nkeys: no seed or private key available",en.InvalidChecksum="nkeys: invalid checksum",en.SerializationError="nkeys: serialization error",en.ApiError="nkeys: api error",en.ClearedPair="nkeys: pair is cleared",(eo=O||(O={}))[eo.Seed=144]="Seed",eo[eo.Private=120]="Private",eo[eo.Operator=112]="Operator",eo[eo.Server=104]="Server",eo[eo.Cluster=16]="Cluster",eo[eo.Account=0]="Account",eo[eo.User=160]="User";let tq=/^INFO\s+([^\r\n]+)\r\n/i,tF=em("PONG\r\n"),tL=em("PING\r\n");class tB{echo;no_responders;protocol;verbose;pedantic;jwt;nkey;sig;user;pass;auth_token;tls_required;name;lang;version;headers;constructor(e,t,s){this.protocol=1,this.version=e.version,this.lang=e.lang,this.echo=!t.noEcho&&void 0,this.verbose=t.verbose,this.pedantic=t.pedantic,this.tls_required=!!t.tls||void 0,this.name=t.name,eC(this,(t&&"function"==typeof t.authenticator?t.authenticator(s):{})||{})}}class tD extends eZ{sid;queue;draining;max;subject;drained;protocol;timer;info;cleanupFn;closed;requestSubject;constructor(e,t,s={}){super(),eC(this,s),this.protocol=e,this.subject=t,this.draining=!1,this.noIterator="function"==typeof s.callback,this.closed=eN();let r=!e.options?.noAsyncTraces;s.timeout&&(this.timer=ej(s.timeout,r),this.timer.then(()=>{this.timer=void 0}).catch(e=>{this.stop(e),this.noIterator&&this.callback(e,{})})),this.noIterator||this.iterClosed.then(()=>{this.closed.resolve(),this.unsubscribe()})}setPrePostHandlers(e){if(this.noIterator){let t=this.callback,s=e.ingestionFilterFn?e.ingestionFilterFn:()=>({ingest:!0,protocol:!1}),r=e.protocolFilterFn?e.protocolFilterFn:()=>!0,i=e.dispatchedFn?e.dispatchedFn:()=>{};this.callback=(e,n)=>{let{ingest:o}=s(n);o&&r(n)&&(t(e,n),i(n))}}else this.protocolFilterFn=e.protocolFilterFn,this.dispatchedFn=e.dispatchedFn}callback(e,t){this.cancelTimeout(),e?this.stop(e):this.push(t)}close(){if(!this.isClosed()){this.cancelTimeout();let e=()=>{if(this.stop(),this.cleanupFn)try{this.cleanupFn(this,this.info)}catch(e){}this.closed.resolve()};this.noIterator?e():this.push(e)}}unsubscribe(e){this.protocol.unsubscribe(this,e)}cancelTimeout(){this.timer&&(this.timer.cancel(),this.timer=void 0)}drain(){return this.protocol.isClosed()?Promise.reject(ev.errorForCode(n.ConnectionClosed)):this.isClosed()?Promise.reject(ev.errorForCode(n.SubClosed)):(this.drained||(this.draining=!0,this.protocol.unsub(this),this.drained=this.protocol.flush(eN()).then(()=>{this.protocol.subscriptions.cancel(this)}).catch(()=>{this.protocol.subscriptions.cancel(this)})),this.drained)}isDraining(){return this.draining}isClosed(){return this.done}getSubject(){return this.subject}getMax(){return this.max}getID(){return this.sid}}class tH{mux;subs;sidCounter;constructor(){this.sidCounter=0,this.mux=null,this.subs=new Map}size(){return this.subs.size}add(e){return this.sidCounter++,e.sid=this.sidCounter,this.subs.set(e.sid,e),e}setMux(e){return this.mux=e,e}getMux(){return this.mux}get(e){return this.subs.get(e)}resub(e){return this.sidCounter++,this.subs.delete(e.sid),e.sid=this.sidCounter,this.subs.set(e.sid,e),e}all(){return Array.from(this.subs.values())}cancel(e){e&&(e.close(),this.subs.delete(e.sid))}handleError(e){if(e&&e.permissionContext){let t;let s=e.permissionContext,r=this.all();if("subscription"===s.operation&&(t=r.find(e=>e.subject===s.subject&&e.queue===s.queue)),"publish"===s.operation&&(t=r.find(e=>e.requestSubject===s.subject)),t)return t.callback(e,{}),t.close(),this.subs.delete(t.sid),t!==this.mux}return!1}close(){this.subs.forEach(e=>{e.close()})}}class tJ{connected;connectedOnce;infoReceived;info;muxSubscriptions;options;outbound;pongs;subscriptions;transport;noMorePublishing;connectError;publisher;_closed;closed;listeners;heartbeats;parser;outMsgs;inMsgs;outBytes;inBytes;pendingLimit;lastError;abortReconnect;whyClosed;servers;server;features;connectPromise;constructor(e,t){this._closed=!1,this.connected=!1,this.connectedOnce=!1,this.infoReceived=!1,this.noMorePublishing=!1,this.abortReconnect=!1,this.listeners=[],this.pendingLimit=32768,this.outMsgs=0,this.inMsgs=0,this.outBytes=0,this.inBytes=0,this.options=e,this.publisher=t,this.subscriptions=new tH,this.muxSubscriptions=new tO,this.outbound=new e6,this.pongs=[],this.whyClosed="",this.pendingLimit=e.pendingLimit||this.pendingLimit,this.features=new tp({major:0,minor:0,micro:0}),this.connectPromise=null;let s="string"==typeof e.servers?[e.servers]:e.servers;this.servers=new tC(s,{randomize:!e.noRandomize}),this.closed=eN(),this.parser=new t$(this),this.heartbeats=new tj(this,this.options.pingInterval||12e4,this.options.maxPingOut||2)}resetOutbound(){this.outbound.reset();let e=this.pongs;this.pongs=[];let t=ev.errorForCode(n.Disconnect);t.stack="",e.forEach(e=>{e.reject(t)}),this.parser=new t$(this),this.infoReceived=!1}dispatchStatus(e){this.listeners.forEach(t=>{t.push(e)})}status(){let e=new eZ;return this.listeners.push(e),e}prepare(){this.transport&&this.transport.discard(),this.info=void 0,this.resetOutbound();let e=eN();return e.catch(()=>{}),this.pongs.unshift(e),this.connectError=t=>{e.reject(t)},this.transport=function(){if(!eu||"function"!=typeof eu.factory)throw Error("transport fn is not set");return eu.factory()}(),this.transport.closed().then(async e=>{if(this.connected=!1,!this.isClosed()){await this.disconnected(this.transport.closeError||this.lastError);return}}),e}disconnect(){this.dispatchStatus({type:i.StaleConnection,data:""}),this.transport.disconnect()}reconnect(){return this.connected&&(this.dispatchStatus({type:i.ClientInitiatedReconnect,data:""}),this.transport.disconnect()),Promise.resolve()}async disconnected(e){this.dispatchStatus({type:r.Disconnect,data:this.servers.getCurrentServer().toString()}),this.options.reconnect?await this.dialLoop().then(()=>{this.dispatchStatus({type:r.Reconnect,data:this.servers.getCurrentServer().toString()}),this.lastError?.code===n.AuthenticationExpired&&(this.lastError=void 0)}).catch(e=>{this._close(e)}):await this._close(e)}async dial(e){let t;let s=this.prepare();try{t=ej(this.options.timeout||2e4);let s=this.transport.connect(e,this.options);await Promise.race([s,t]),(async()=>{try{for await(let e of this.transport)this.parser.parse(e)}catch(e){console.log("reader closed",e)}})().then()}catch(e){s.reject(e)}try{await Promise.race([t,s]),t&&t.cancel(),this.connected=!0,this.connectError=void 0,this.sendSubscriptions(),this.connectedOnce=!0,this.server.didConnect=!0,this.server.reconnects=0,this.flushPending(),this.heartbeats.start()}catch(e){throw t&&t.cancel(),await this.transport.close(e),e}}async _doDial(e){let{resolve:t}=this.options,s=await e.resolve({fn:tw(),debug:this.options.debug,randomize:!this.options.noRandomize,resolve:t}),r=null;for(let e of s)try{r=null,this.dispatchStatus({type:i.Reconnecting,data:e.toString()}),await this.dial(e);return}catch(e){r=e}throw r}dialLoop(){return null===this.connectPromise&&(this.connectPromise=this.dodialLoop(),this.connectPromise.then(()=>{}).catch(()=>{}).finally(()=>{this.connectPromise=null})),this.connectPromise}async dodialLoop(){let e;for(;;){this._closed&&this.servers.clear();let t=this.options.reconnectDelayHandler?this.options.reconnectDelayHandler():2e3,s=t,r=this.selectServer();if(!r||this.abortReconnect){if(e)throw e;if(this.lastError)throw this.lastError;throw ev.errorForCode(n.ConnectionRefused)}let i=Date.now();if(0===r.lastConnect||r.lastConnect+t<=i){r.lastConnect=Date.now();try{await this._doDial(r);break}catch(s){if(e=s,!this.connectedOnce){if(this.options.waitOnFirstConnect)continue;this.servers.removeCurrentServer()}r.reconnects++;let t=this.options.maxReconnectAttempts||0;-1!==t&&r.reconnects>=t&&this.servers.removeCurrentServer()}}else s=Math.min(s,r.lastConnect+t-i),await eI(s)}}static async connect(e,t){let s=new tJ(e,t);return await s.dialLoop(),s}static toError(e){let t=e?e.toLowerCase():"";if(-1!==t.indexOf("permissions violation")){let t=new ev(e,n.PermissionsViolation),s=e.match(/(Publish|Subscription) to "(\S+)"/);if(s){t.permissionContext={operation:s[1].toLowerCase(),subject:s[2],queue:void 0};let r=e.match(/using queue "(\S+)"/);r&&(t.permissionContext.queue=r[1])}return t}return -1!==t.indexOf("authorization violation")?new ev(e,n.AuthorizationViolation):-1!==t.indexOf("user authentication expired")?new ev(e,n.AuthenticationExpired):-1!=t.indexOf("account authentication expired")?new ev(e,n.AccountExpired):-1!==t.indexOf("authentication timeout")?new ev(e,n.AuthenticationTimeout):new ev(e,n.ProtocolError)}processMsg(e,t){if(this.inMsgs++,this.inBytes+=t.length,!this.subscriptions.sidCounter)return;let s=this.subscriptions.get(e.sid);s&&(s.received+=1,s.callback&&s.callback(null,new eJ(e,t,this)),void 0!==s.max&&s.received>=s.max&&s.unsubscribe())}processError(e){let t=eg(e),s=tJ.toError(t),i={type:r.Error,data:s.code};if(s.isPermissionError()){let e=!1;if(s.permissionContext){i.permissionContext=s.permissionContext;let t=this.subscriptions.getMux();e=t?.subject===s.permissionContext.subject}this.subscriptions.handleError(s),this.muxSubscriptions.handleError(e,s),e&&this.subscriptions.setMux(null)}this.dispatchStatus(i),this.handleError(s)}handleError(e){e.isAuthError()?this.handleAuthError(e):e.isProtocolError()?this.lastError=e:e.isAuthTimeout()&&(this.lastError=e),e.isPermissionError()||(this.lastError=e)}handleAuthError(e){this.lastError&&e.code===this.lastError.code&&!1===this.options.ignoreAuthErrorAbort&&(this.abortReconnect=!0),this.connectError?this.connectError(e):this.disconnect()}processPing(){this.transport.send(tF)}processPong(){let e=this.pongs.shift();e&&e.resolve()}processInfo(e){let t=JSON.parse(eg(e));this.info=t;let s=this.options&&this.options.ignoreClusterUpdates?void 0:this.servers.update(t,this.transport.isEncrypted());if(!this.infoReceived){this.features.update(td(t.version)),this.infoReceived=!0,this.transport.isEncrypted()&&this.servers.updateTLSName();let{version:e,lang:s}=this.transport;try{let r=new tB({version:e,lang:s},this.options,t.nonce);t.headers&&(r.headers=!0,r.no_responders=!0);let i=JSON.stringify(r);this.transport.send(em(`CONNECT ${i}\r
`)),this.transport.send(tL)}catch(e){this._close(e)}}s&&this.dispatchStatus({type:r.Update,data:s}),void 0!==t.ldm&&t.ldm&&this.dispatchStatus({type:r.LDM,data:this.servers.getCurrentServer().toString()})}push(e){switch(e.kind){case A.MSG:{let{msg:t,data:s}=e;this.processMsg(t,s);break}case A.OK:break;case A.ERR:this.processError(e.data);break;case A.PING:this.processPing();break;case A.PONG:this.processPong();break;case A.INFO:this.processInfo(e.data)}}sendCommand(e,...t){let s;let r=this.outbound.length();s="string"==typeof e?em(e):e,this.outbound.fill(s,...t),0===r?queueMicrotask(()=>{this.flushPending()}):this.outbound.size()>=this.pendingLimit&&this.flushPending()}publish(e,t=ed,s){let r,i;if(t instanceof Uint8Array)r=t;else if("string"==typeof t)r=ef.encode(t);else throw ev.errorForCode(n.BadPayload);let o=r.length;(s=s||{}).reply=s.reply||"";let a=ed,c=0;if(s.headers){if(this.info&&!this.info.headers)throw new ev("headers",n.ServerOptionNotAvailable);c=(a=s.headers.encode()).length,o=r.length+c}if(this.info&&o>this.info.max_payload)throw ev.errorForCode(n.MaxPayloadExceeded);this.outBytes+=o,this.outMsgs++,s.headers?(i=s.reply?`HPUB ${e} ${s.reply} ${c} ${o}\r
`:`HPUB ${e} ${c} ${o}\r
`,this.sendCommand(i,a,r,tS)):(i=s.reply?`PUB ${e} ${s.reply} ${o}\r
`:`PUB ${e} ${o}\r
`,this.sendCommand(i,r,tS))}request(e){return this.initMux(),this.muxSubscriptions.add(e),e}subscribe(e){return this.subscriptions.add(e),this._subunsub(e),e}_sub(e){e.queue?this.sendCommand(`SUB ${e.subject} ${e.queue} ${e.sid}\r
`):this.sendCommand(`SUB ${e.subject} ${e.sid}\r
`)}_subunsub(e){return this._sub(e),e.max&&this.unsubscribe(e,e.max),e}unsubscribe(e,t){this.unsub(e,t),(void 0===e.max||e.received>=e.max)&&this.subscriptions.cancel(e)}unsub(e,t){!e||this.isClosed()||(t?this.sendCommand(`UNSUB ${e.sid} ${t}\r
`):this.sendCommand(`UNSUB ${e.sid}\r
`),e.max=t)}resub(e,t){!e||this.isClosed()||(this.unsub(e),e.subject=t,this.subscriptions.resub(e),this._sub(e))}flush(e){return e||(e=eN()),this.pongs.push(e),this.outbound.fill(tL),this.flushPending(),e}sendSubscriptions(){let e=[];this.subscriptions.all().forEach(t=>{t.queue?e.push(`SUB ${t.subject} ${t.queue} ${t.sid}\r
`):e.push(`SUB ${t.subject} ${t.sid}\r
`)}),e.length&&this.transport.send(em(e.join("")))}async _close(e){this._closed||(this.whyClosed=Error("close trace").stack||"",this.heartbeats.cancel(),this.connectError&&(this.connectError(e),this.connectError=void 0),this.muxSubscriptions.close(),this.subscriptions.close(),this.listeners.forEach(e=>{e.stop()}),this._closed=!0,await this.transport.close(e),await this.closed.resolve(e))}close(){return this._close()}isClosed(){return this._closed}drain(){let e=this.subscriptions.all(),t=[];return e.forEach(e=>{t.push(e.drain())}),Promise.all(t).then(async()=>(this.noMorePublishing=!0,await this.flush(),this.close())).catch(()=>{})}flushPending(){if(this.infoReceived&&this.connected&&this.outbound.size()){let e=this.outbound.drain();this.transport.send(e)}}initMux(){if(!this.subscriptions.getMux()){let e=this.muxSubscriptions.init(this.options.inboxPrefix),t=new tD(this,`${e}*`);t.callback=this.muxSubscriptions.dispatcher(),this.subscriptions.setMux(t),this.subscribe(t)}}selectServer(){let e=this.servers.selectServer();if(void 0!==e)return this.server=e,this.server}getServer(){return this.server}}class tz{msg;constructor(e){this.msg=e}get data(){return this.msg.data}get sid(){return this.msg.sid}get subject(){return this.msg.subject}get reply(){return this.msg.reply||""}get headers(){return this.msg.headers}respond(e,t){return this.msg.respond(e,t)}respondError(e,t,s,r){return(r=r||{}).headers=r.headers||eq(),r.headers?.set(ex,`${e}`),r.headers?.set(eE,t),this.msg.respond(s,r)}json(e){return this.msg.json(e)}string(){return this.msg.string()}}class tG{subject;queue;srv;constructor(e,t="",s=""){""!==t&&function(e,t){if(-1!==t.indexOf(" "))throw Error(`${e} cannot contain spaces: '${t}'`);t.split(".").forEach(s=>{if(">"===s)throw Error(`${e} name cannot contain internal '>': '${t}'`)})}("service group",t);let r="";if(e instanceof tK)this.srv=e,r="";else if(e instanceof tG)this.srv=e.srv,""===s&&""!==e.queue&&(s=e.queue),r=e.subject;else throw Error("unknown ServiceGroup type");this.subject=this.calcSubject(r,t),this.queue=s}calcSubject(e,t=""){return""===t?e:""!==e?`${e}.${t}`:t}addEndpoint(e="",t){let s="function"==typeof(t=t||{subject:e})?{handler:t,subject:e}:t;eV("endpoint",e);let{subject:r,handler:i,metadata:n,queue:o}=s;r=r||e,o=o||this.queue,function(e,t){if(""===t)throw Error(`${e} cannot be empty`);if(-1!==t.indexOf(" "))throw Error(`${e} cannot contain spaces: '${t}'`);let s=t.split(".");s.forEach((r,i)=>{if(">"===r&&i!==s.length-1)throw Error(`${e} cannot have internal '>': '${t}'`)})}("endpoint subject",r);let a={name:e,subject:r=this.calcSubject(this.subject,r),queue:o,handler:i,metadata:n};return this.srv._addEndpoint(a)}addGroup(e="",t=""){return new tG(this,e,t)}}class tK{nc;_id;config;handlers;internal;_stopped;_done;started;static controlSubject(e,t="",s="",r){let i=r??"$SRV";return""===t&&""===s?`${i}.${e}`:(eV("control subject name",t),""!==s)?(eV("control subject id",s),`${i}.${e}.${t}.${s}`):`${i}.${e}.${t}`}constructor(e,t={name:"",version:""}){this.nc=e,this.config=Object.assign({},t),this.config.queue||(this.config.queue="q"),eV("name",this.config.name),eV("queue",this.config.queue),td(this.config.version),this._id=ey.next(),this.internal=[],this._done=eN(),this._stopped=!1,this.handlers=[],this.started=new Date().toISOString(),this.reset(),this.nc.closed().then(()=>{this.close().catch()}).catch(e=>{this.close(e).catch()})}get subjects(){return this.handlers.filter(e=>!1===e.internal).map(e=>e.subject)}get id(){return this._id}get name(){return this.config.name}get description(){return this.config.description??""}get version(){return this.config.version}get metadata(){return this.config.metadata}errorToHeader(e){let t=eq();return e instanceof eA?(t.set(eE,e.message),t.set(ex,`${e.code}`)):(t.set(eE,e.message),t.set(ex,"500")),t}setupHandler(e,t=!1){let s=t?"":e.queue?e.queue:this.config.queue,{name:r,subject:i,handler:n}=e;e.internal=t,t&&this.internal.push(e),e.stats=new tV(r,i,s),e.queue=s;let o=n?(t,s)=>{if(t){this.close(t);return}let r=Date.now();try{n(t,new tz(s))}catch(t){e.stats.countError(t),s?.respond(ed,{headers:this.errorToHeader(t)})}finally{e.stats.countLatency(r)}}:void 0;return e.sub=this.nc.subscribe(i,{callback:o,queue:s}),e.sub.closed.then(()=>{this._stopped||this.close(Error(`required subscription ${e.subject} stopped`)).catch()}).catch(t=>{if(!this._stopped){let s=Error(`required subscription ${e.subject} errored: ${t.message}`);s.stack=t.stack,this.close(s).catch()}}),e}info(){return{type:c.INFO,name:this.name,id:this.id,version:this.version,description:this.description,metadata:this.metadata,endpoints:this.endpoints()}}endpoints(){return this.handlers.map(e=>{let{subject:t,metadata:s,name:r,queue:i}=e;return{subject:t,metadata:s,name:r,queue_group:i}})}async stats(){let e=[];for(let t of this.handlers){if("function"==typeof this.config.statsHandler)try{t.stats.data=await this.config.statsHandler(t)}catch(e){t.stats.countError(e)}e.push(t.stats.stats(t.qi))}return{type:c.STATS,name:this.name,id:this.id,version:this.version,started:this.started,metadata:this.metadata,endpoints:e}}addInternalHandler(e,t){let s=`${e}`.toUpperCase();this._doAddInternalHandler(`${s}-all`,e,t),this._doAddInternalHandler(`${s}-kind`,e,t,this.name),this._doAddInternalHandler(`${s}`,e,t,this.name,this.id)}_doAddInternalHandler(e,t,s,r="",i=""){let n={};n.name=e,n.subject=tK.controlSubject(t,r,i),n.handler=s,this.setupHandler(n,!0)}start(){let e=eD(),t=e.encode(this.ping());return this.addInternalHandler(h.PING,(e,s)=>e?(this.close(e).then().catch(),Promise.reject(e)):(s.respond(t),Promise.resolve())),this.addInternalHandler(h.STATS,(t,s)=>t?(this.close(t),Promise.reject(t)):this.stats().then(t=>(s?.respond(e.encode(t)),Promise.resolve()))),this.addInternalHandler(h.INFO,(t,s)=>t?(this.close(t),Promise.reject(t)):(s?.respond(e.encode(this.info())),Promise.resolve())),this.handlers.forEach(e=>{let{subject:t}=e;"string"==typeof t&&null!==e.handler&&this.setupHandler(e)}),Promise.resolve(this)}close(e){if(this._stopped)return this._done;this._stopped=!0;let t=[];return this.nc.isClosed()||(t=this.handlers.concat(this.internal).map(e=>e.sub.drain())),Promise.allSettled(t).then(()=>{this._done.resolve(e||null)}),this._done}get stopped(){return this._done}get isStopped(){return this._stopped}stop(e){return this.close(e)}ping(){return{type:c.PING,name:this.name,id:this.id,version:this.version,metadata:this.metadata}}reset(){if(this.started=new Date().toISOString(),this.handlers)for(let e of this.handlers)e.stats.reset(e.qi)}addGroup(e,t){return new tG(this,e,t)}addEndpoint(e,t){return new tG(this).addEndpoint(e,t)}_addEndpoint(e){let t=new eZ;t.noIterator="function"==typeof e.handler,t.noIterator||(e.handler=(e,s)=>{e?this.stop(e).catch():t.push(new tz(s))},t.iterClosed.then(()=>{this.close().catch()}));let s=this.setupHandler(e,!1);return s.qi=t,this.handlers.push(s),t}}class tV{name;subject;average_processing_time;num_requests;processing_time;num_errors;last_error;data;metadata;queue;constructor(e,t,s=""){this.name=e,this.subject=t,this.average_processing_time=0,this.num_errors=0,this.num_requests=0,this.processing_time=0,this.queue=s}reset(e){this.num_requests=0,this.processing_time=0,this.average_processing_time=0,this.num_errors=0,this.last_error=void 0,this.data=void 0,e&&(e.time=0,e.processed=0)}countLatency(e){this.num_requests++,this.processing_time+=eT(Date.now()-e),this.average_processing_time=Math.round(this.processing_time/this.num_requests)}countError(e){this.num_errors++,this.last_error=e.message}_stats(){let{name:e,subject:t,average_processing_time:s,num_errors:r,num_requests:i,processing_time:n,last_error:o,data:a,queue:c}=this;return{name:e,subject:t,average_processing_time:s,num_errors:r,num_requests:i,processing_time:n,last_error:o,data:a,queue_group:c}}stats(e){return e?.noIterator===!1&&(this.processing_time=e.time,this.num_requests=e.processed,this.average_processing_time=this.processing_time>0&&this.num_requests>0?this.processing_time/this.num_requests:0),this._stats()}}class tW{nc;prefix;opts;constructor(e,t={strategy:a.JitterTimer,maxWait:2e3},s){this.nc=e,this.prefix=s,this.opts=t}ping(e="",t=""){return this.q(h.PING,e,t)}stats(e="",t=""){return this.q(h.STATS,e,t)}info(e="",t=""){return this.q(h.INFO,e,t)}async q(e,t="",s=""){let r=new eZ,i=eD(),n=tK.controlSubject(e,t,s,this.prefix),o=await this.nc.requestMany(n,ed,this.opts);return(async()=>{for await(let e of o)try{let t=i.decode(e.data);r.push(t)}catch(e){r.push(()=>{r.stop(e)})}r.push(()=>{r.stop()})})().catch(e=>{r.stop(e)}),r}}function tY(){return{key:{encode:e=>e,decode:e=>e},value:{encode:e=>e,decode:e=>e}}}let tX="KV-Operation",tQ=/^[-/=.\w]+$/,tZ=/^[-/=.>*\w]+$/,t0=/^[-\w]+$/;function t1(e){if(e.startsWith(".")||e.endsWith(".")||!tQ.test(e))throw Error(`invalid key: ${e}`)}function t2(e){if(e.startsWith(".")||e.endsWith(".")||!tZ.test(e))throw Error(`invalid key: ${e}`)}function t3(e){if(e.startsWith(".")||e.endsWith("."))throw Error(`invalid key: ${e}`);let t=e.split("."),s=!1;for(let r=0;r<t.length;r++)switch(t[r]){case"*":s=!0;break;case">":if(r!==t.length-1)throw Error(`invalid key: ${e}`);s=!0}return s}function t4(e){if(!t0.test(e))throw Error(`invalid bucket name: ${e}`)}(ea=j||(j={})).MsgIdHdr="Nats-Msg-Id",ea.ExpectedStreamHdr="Nats-Expected-Stream",ea.ExpectedLastSeqHdr="Nats-Expected-Last-Sequence",ea.ExpectedLastMsgIdHdr="Nats-Expected-Last-Msg-Id",ea.ExpectedLastSubjectSequenceHdr="Nats-Expected-Last-Subject-Sequence";class t5{js;jsm;stream;bucket;direct;codec;prefix;editPrefix;useJsPrefix;_prefixLen;constructor(e,t,s){t4(e),this.js=t,this.jsm=s,this.bucket=e,this.prefix="$KV",this.editPrefix="",this.useJsPrefix=!1,this._prefixLen=0}static async create(e,t,s={}){t4(t);let r=await e.jetstreamManager(),i=new t5(t,e,r);return await i.init(s),i}static async bind(e,t,s={}){let r=await e.jetstreamManager(),i={config:{allow_direct:s.allow_direct}};t4(t);let n=new t5(t,e,r);return i.config.name=s.streamName??n.bucketName(),Object.assign(n,i),n.stream=i.config.name,n.codec=s.codec||tY(),n.direct=i.config.allow_direct??!1,n.initializePrefixes(i),n}async init(e={}){let t;let s=Object.assign({replicas:1,history:1,timeout:2e3,max_bytes:-1,maxValueSize:-1,codec:tY(),storage:f.File},e);this.codec=s.codec;let r={};this.stream=r.name=e.streamName??this.bucketName(),r.retention=u.Limits,r.max_msgs_per_subject=s.history,s.maxBucketSize&&(s.max_bytes=s.maxBucketSize),s.max_bytes&&(r.max_bytes=s.max_bytes),r.max_msg_size=s.maxValueSize,r.storage=s.storage;let i=e.placementCluster??"";if(i&&(e.placement={},e.placement.cluster=i,e.placement.tags=[]),e.placement&&(r.placement=e.placement),e.republish&&(r.republish=e.republish),e.description&&(r.description=e.description),e.mirror){let t=Object.assign({},e.mirror);t.name.startsWith("KV_")||(t.name=`KV_${t.name}`),r.mirror=t,r.mirror_direct=!0}else if(e.sources){let t=e.sources.map(e=>{let t=Object.assign({},e),s=t.name.startsWith("KV_")?t.name.substring(3):t.name;return t.name.startsWith("KV_")||(t.name=`KV_${t.name}`),e.external||s===this.bucket||(t.subject_transforms=[{src:`$KV.${s}.>`,dest:`$KV.${this.bucket}.>`}]),t});r.sources=t,r.subjects=[this.subjectForBucket()]}else r.subjects=[this.subjectForBucket()];e.metadata&&(r.metadata=e.metadata),"boolean"==typeof e.compression&&(r.compression=e.compression?b.S2:b.None);let n=this.js.nc,o=n.getServerVersion(),a=!!o&&tf(o,td("2.7.2"))>=0;r.discard=a?d.New:d.Old;let{ok:c,min:h}=n.features.get(x.JS_ALLOW_DIRECT);if(!c&&!0===e.allow_direct){let e=o?`${o.major}.${o.minor}.${o.micro}`:"unknown";return Promise.reject(Error(`allow_direct is not available on server version ${e} - requires ${h}`))}e.allow_direct="boolean"==typeof e.allow_direct?e.allow_direct:c,r.allow_direct=e.allow_direct,this.direct=r.allow_direct,r.num_replicas=s.replicas,s.ttl&&(r.max_age=eT(s.ttl)),r.allow_rollup_hdrs=!0;try{(t=await this.jsm.streams.info(r.name)).config.allow_direct||!0!==this.direct||(this.direct=!1)}catch(e){if("stream not found"===e.message)t=await this.jsm.streams.add(r);else throw e}this.initializePrefixes(t)}initializePrefixes(e){this._prefixLen=0,this.prefix=`$KV.${this.bucket}`,this.useJsPrefix="$JS.API"!==this.js.apiPrefix;let{mirror:t}=e.config;if(t){let e=t.name;if(e.startsWith("KV_")&&(e=e.substring(3)),t.external&&""!==t.external.api){let s=t.name.substring(3);this.useJsPrefix=!1,this.prefix=`$KV.${s}`,this.editPrefix=`${t.external.api}.$KV.${e}`}else this.editPrefix=this.prefix}}bucketName(){return this.stream??`KV_${this.bucket}`}subjectForBucket(){return`${this.prefix}.${this.bucket}.>`}subjectForKey(e,t=!1){let s=[];return t?(this.useJsPrefix&&s.push(this.js.apiPrefix),""!==this.editPrefix?s.push(this.editPrefix):s.push(this.prefix)):this.prefix&&s.push(this.prefix),s.push(e),s.join(".")}fullKeyName(e){return""!==this.prefix?`${this.prefix}.${e}`:`$KV.${this.bucket}.${e}`}get prefixLen(){return 0===this._prefixLen&&(this._prefixLen=this.prefix.length+1),this._prefixLen}encodeKey(e){let t=[];for(let s of e.split("."))switch(s){case">":case"*":t.push(s);break;default:t.push(this.codec.key.encode(s))}return t.join(".")}decodeKey(e){let t=[];for(let s of e.split("."))switch(s){case">":case"*":t.push(s);break;default:t.push(this.codec.key.decode(s))}return t.join(".")}validateKey=t1;validateSearchKey=t2;hasWildcards=t3;close(){return Promise.resolve()}dataLen(e,t){let s=t&&t.get(w.MessageSizeHdr)||"";return""!==s?parseInt(s,10):e.length}smToEntry(e){return new sk(this.bucket,this.prefixLen,e)}jmToEntry(e){let t=this.decodeKey(e.subject.substring(this.prefixLen));return new sC(this.bucket,t,e)}async create(e,t){let s;try{let s=await this.put(e,t,{previousSeq:0});return Promise.resolve(s)}catch(e){if(s=e,e?.api_error?.err_code!==10071)return Promise.reject(e)}let r=0;try{let i=await this.get(e);if(i?.operation==="DEL"||i?.operation==="PURGE")return r=null!==i?i.revision:0,this.update(e,t,r);return Promise.reject(s)}catch(e){return Promise.reject(e)}}update(e,t,s){if(s<=0)throw Error("version must be greater than 0");return this.put(e,t,{previousSeq:s})}async put(e,t,s={}){let r=this.encodeKey(e);this.validateKey(r);let i={};if(void 0!==s.previousSeq){let e=eq();i.headers=e,e.set(j.ExpectedLastSubjectSequenceHdr,`${s.previousSeq}`)}try{return(await this.js.publish(this.subjectForKey(r,!0),t,i)).seq}catch(e){if(e.isJetStreamError())return e.message=e.api_error?.description,e.code=`${e.api_error?.code}`,Promise.reject(e);return Promise.reject(e)}}async get(e,t){let s;let r=this.encodeKey(e);this.validateKey(r);let i={last_by_subj:this.subjectForKey(r)};t&&t.revision>0&&(i={seq:t.revision});try{if(this.direct){let e=this.jsm.direct;s=await e.getMessage(this.bucketName(),i)}else s=await this.jsm.streams.getMessage(this.bucketName(),i);let e=this.smToEntry(s);if(e.key!==r)return null;return e}catch(e){if(e.code===n.JetStream404NoMessages)return null;throw e}}purge(e,t){return this._deleteOrPurge(e,"PURGE",t)}delete(e,t){return this._deleteOrPurge(e,"DEL",t)}async purgeDeletes(e=18e5){let t=eN(),s=[],r=await this.watch({key:">",initializedFn:()=>{t.resolve()}});(async()=>{for await(let e of r)("DEL"===e.operation||"PURGE"===e.operation)&&s.push(e)})().then(),await t,r.stop();let i=Date.now()-e,n=s.map(e=>{let t=this.subjectForKey(e.key);return e.created.getTime()>=i?this.jsm.streams.purge(this.stream,{filter:t,keep:1}):this.jsm.streams.purge(this.stream,{filter:t,keep:0})}),o=await Promise.all(n);return o.unshift({success:!0,purged:0}),o.reduce((e,t)=>(e.purged+=t.purged,e))}async _deleteOrPurge(e,t,s){if(!this.hasWildcards(e))return this._doDeleteOrPurge(e,t,s);let r=await this.keys(e),i=[];for await(let e of r)i.push(this._doDeleteOrPurge(e,t)),100===i.length&&(await Promise.all(i),i.length=0);i.length>0&&await Promise.all(i)}async _doDeleteOrPurge(e,t,s){let r=this.encodeKey(e);this.validateKey(r);let i=eq();i.set(tX,t),"PURGE"===t&&i.set(w.RollupHdr,w.RollupValueSubject),s?.previousSeq&&i.set(j.ExpectedLastSubjectSequenceHdr,`${s.previousSeq}`),await this.js.publish(this.subjectForKey(r,!0),ed,{headers:i})}_buildCC(e,t,s={}){let r,i=(Array.isArray(e)?e:[e]).map(e=>{let t=this.encodeKey(e);return this.validateSearchKey(e),this.fullKeyName(t)}),n=p.LastPerSubject;return t===S.AllHistory&&(n=p.All),t===S.UpdatesOnly&&(n=p.New),1===i.length&&(r=i[0],i=void 0),Object.assign({deliver_policy:n,ack_policy:m.None,filter_subjects:i,filter_subject:r,flow_control:!0,idle_heartbeat:eT(5e3)},s)}remove(e){return this.purge(e)}async history(e={}){let t;let s=e.key??">",r=new eZ,i={};i.headers_only=e.headers_only||!1,t=()=>{r.stop()};let n=0,o=this._buildCC(s,S.AllHistory,i),a=o.filter_subject,c=e2(o);c.bindStream(this.stream),c.orderedConsumer(),c.callback((e,s)=>{if(e){r.stop(e);return}if(s){let e=this.jmToEntry(s);r.push(e),r.received++,(t&&n>0&&r.received>=n||0===s.info.pending)&&(r.push(t),t=void 0)}});let h=await this.js.subscribe(a,c);if(t){let{info:{last:e}}=h,s=e.num_pending+e.delivered.consumer_seq;if(0===s||r.received>=s)try{t()}catch(e){r.stop(e)}finally{t=void 0}else n=s}return r._data=h,r.iterClosed.then(()=>{h.unsubscribe()}),h.closed.then(()=>{r.stop()}).catch(e=>{r.stop(e)}),r}canSetWatcherName(){let{ok:e}=this.js.nc.features.get(x.JS_NEW_CONSUMER_CREATE_API);return e}async watch(e={}){let t=e.key??">",s=new eZ,r={};r.headers_only=e.headers_only||!1;let i=S.LastValue;e.include===S.AllHistory?i=S.AllHistory:e.include===S.UpdatesOnly&&(i=S.UpdatesOnly);let n=!0===e.ignoreDeletes,o=e.initializedFn,a=0,c=this._buildCC(t,i,r),h=c.filter_subject,l=e2(c);this.canSetWatcherName()&&l.consumerName(ey.next()),l.bindStream(this.stream),e.resumeFromRevision&&e.resumeFromRevision>0&&l.startSequence(e.resumeFromRevision),l.orderedConsumer(),l.callback((e,t)=>{if(e){s.stop(e);return}if(t){let e=this.jmToEntry(t);if(n&&"DEL"===e.operation)return;s.push(e),s.received++,o&&(a>0&&s.received>=a||0===t.info.pending)&&(s.push(o),o=void 0)}});let u=await this.js.subscribe(h,l);if(o){let{info:{last:e}}=u,t=e.num_pending+e.delivered.consumer_seq;if(0===t||s.received>=t)try{o()}catch(e){s.stop(e)}finally{o=void 0}else a=t}return s._data=u,s.iterClosed.then(()=>{u.unsubscribe()}),u.closed.then(()=>{s.stop()}).catch(e=>{s.stop(e)}),s}async keys(e=">"){let t=new eZ,s=this._buildCC(e,S.LastValue,{headers_only:!0}),r=Array.isArray(e)?">":s.filter_subject,i=e2(s);i.bindStream(this.stream),i.orderedConsumer();let n=await this.js.subscribe(r,i);return(async()=>{for await(let e of n){let s=e.headers?.get(tX);if("DEL"!==s&&"PURGE"!==s){let s=this.decodeKey(e.subject.substring(this.prefixLen));t.push(s)}0===e.info.pending&&n.unsubscribe()}})().then(()=>{t.stop()}).catch(e=>{t.stop(e)}),0===n.info.last.num_pending&&n.unsubscribe(),t}purgeBucket(e){return this.jsm.streams.purge(this.bucketName(),e)}destroy(){return this.jsm.streams.delete(this.bucketName())}async status(){let e=this.js.nc,t=e.info?.cluster??"",s=this.bucketName();return new t6(await this.jsm.streams.info(s),t)}}class t6{si;cluster;constructor(e,t=""){this.si=e,this.cluster=t}get bucket(){return this.si.config.name.startsWith("KV_")?this.si.config.name.substring(3):this.si.config.name}get values(){return this.si.state.messages}get history(){return this.si.config.max_msgs_per_subject}get ttl(){return e$(this.si.config.max_age)}get bucket_location(){return this.cluster}get backingStore(){return this.si.config.storage}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get description(){return this.si.config.description??""}get maxBucketSize(){return this.si.config.max_bytes}get maxValueSize(){return this.si.config.max_msg_size}get max_bytes(){return this.si.config.max_bytes}get placement(){return this.si.config.placement||{cluster:"",tags:[]}}get placementCluster(){return this.si.config.placement?.cluster??""}get republish(){return this.si.config.republish??{src:"",dest:""}}get streamInfo(){return this.si}get size(){return this.si.state.bytes}get metadata(){return this.si.config.metadata??{}}get compression(){return!!this.si.config.compression&&this.si.config.compression!==b.None}}let t8="OBJ_",t7="SHA-256=";class t9{si;backingStore;constructor(e){this.si=e,this.backingStore="JetStream"}get bucket(){var e;return(e=this.si.config.name).startsWith(t8)?e.substring(4):e}get description(){return this.si.config.description??""}get ttl(){return this.si.config.max_age}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get sealed(){return this.si.config.sealed}get size(){return this.si.state.bytes}get streamInfo(){return this.si}get metadata(){return this.si.config.metadata}get compression(){return!!this.si.config.compression&&this.si.config.compression!==b.None}}function se(e){if(void 0===e)return;let{domain:t}=e;if(void 0===t)return e;let s=Object.assign({},e);if(delete s.domain,""===t)return s;if(s.external)throw Error("domain and external are both set");return s.external={api:`$JS.${t}.API`},s}(ec=I||(I={}))[ec.Unset=-1]="Unset",ec[ec.Consume=0]="Consume",ec[ec.Fetch=1]="Fetch",(eh=N||(N={})).HeartbeatsMissed="heartbeats_missed",eh.ConsumerNotFound="consumer_not_found",eh.StreamNotFound="stream_not_found",eh.ConsumerDeleted="consumer_deleted",eh.OrderedConsumerRecreated="ordered_consumer_recreated",(el=M||(M={})).DebugEvent="debug",el.Discard="discard",el.Reset="reset",el.Next="next";let st=Uint8Array.of(43,65,67,75),ss=Uint8Array.of(45,78,65,75),sr=Uint8Array.of(43,87,80,73),si=Uint8Array.of(43,78,88,84),sn=Uint8Array.of(43,84,69,82,77),so=Uint8Array.of(32);function sa(e,t=5e3){return new sM(e,t)}class sc extends eZ{consumer;opts;sub;monitor;pending;inbox;refilling;pong;callback;timeout;cleanupHandler;listeners;statusIterator;forOrderedConsumer;resetHandler;abortOnMissingResource;bind;constructor(e,t,s=!1){super(),this.consumer=e,this.opts=this.parseOptions(t,s),this.callback=t.callback||null,this.noIterator="function"==typeof this.callback,this.monitor=null,this.pong=null,this.pending={msgs:0,bytes:0,requests:0},this.refilling=s,this.timeout=null,this.inbox=eP(e.api.nc.options.inboxPrefix),this.listeners=[],this.forOrderedConsumer=!1,this.abortOnMissingResource=!0===t.abort_on_missing_resource,this.bind=!0===t.bind,this.start()}start(){let{max_messages:e,max_bytes:t,idle_heartbeat:s,threshold_bytes:i,threshold_messages:n}=this.opts;this.closed().then(e=>{if(this.cleanupHandler)try{this.cleanupHandler(e)}catch(e){}});let{sub:o}=this;o&&o.unsubscribe(),this.sub=this.consumer.api.nc.subscribe(this.inbox,{callback:(s,r)=>{if(s){this.stop(s);return}if(this.monitor?.work(),r.subject===this.inbox){if(eY(r))return;let e=r.headers?.code,t=r.headers?.description?.toLowerCase()||"unknown",{msgsLeft:s,bytesLeft:i}=this.parseDiscard(r.headers);if(s>0||i>0)this.pending.msgs-=s,this.pending.bytes-=i,this.pending.requests--,this.notify(M.Discard,{msgsLeft:s,bytesLeft:i});else{if(400===e){this.stop(new ev(t,`${e}`));return}if(409===e&&"consumer deleted"===t){if(this.notify(N.ConsumerDeleted,`${e} ${t}`),!this.refilling||this.abortOnMissingResource){let s=new ev(t,`${e}`);this.stop(s);return}}else this.notify(M.DebugEvent,`${e} ${t}`)}}else this._push(sa(r,this.consumer.api.timeout)),this.received++,this.pending.msgs&&this.pending.msgs--,this.pending.bytes&&(this.pending.bytes-=r.size());if(0===this.pending.msgs&&0===this.pending.bytes&&(this.pending.requests=0),this.refilling){if(e&&this.pending.msgs<=n||t&&this.pending.bytes<=i){let e=this.pullOptions();this.pull(e)}}else 0===this.pending.requests&&this._push(()=>{this.stop()})}}),this.sub.closed.then(()=>{this.sub.draining&&this._push(()=>{this.stop()})}),s&&(this.monitor=new e0(s,e=>(this.notify(N.HeartbeatsMissed,e),this.resetPending().then(()=>{}).catch(()=>{}),!1),{maxOut:2})),(async()=>{let e=this.consumer.api.nc.status();for await(let t of(this.statusIterator=e,e))switch(t.type){case r.Disconnect:this.monitor?.cancel();break;case r.Reconnect:this.resetPending().then(e=>{e&&this.monitor?.restart()}).catch(()=>{})}})(),this.pull(this.pullOptions())}_push(e){if(this.callback){let t="function"==typeof e?e:null;try{t?t():this.callback(e)}catch(e){this.stop(e)}}else super.push(e)}notify(e,t){this.listeners.length>0&&(()=>{this.listeners.forEach(s=>{s.done||s.push({type:e,data:t})})})()}resetPending(){return this.bind?this.resetPendingNoInfo():this.resetPendingWithInfo()}resetPendingNoInfo(){return this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),Promise.resolve(!0)}async resetPendingWithInfo(){let e=0,t=0,s=eR(),r=0;for(;;){if(this.done)return!1;if(this.consumer.api.nc.isClosed())return console.error("aborting resetPending - connection is closed"),!1;try{return await this.consumer.info(),e=0,this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),!0}catch(n){if("stream not found"===n.message){if(t++,this.notify(N.StreamNotFound,t),!this.refilling||this.abortOnMissingResource)return this.stop(n),!1}else if("consumer not found"===n.message){if(e++,this.notify(N.ConsumerNotFound,e),this.resetHandler)try{this.resetHandler()}catch(e){}if(!this.refilling||this.abortOnMissingResource)return this.stop(n),!1;if(this.forOrderedConsumer)return!1}else e=0,t=0;let i=eI(s.backoff(r));await Promise.race([i,this.consumer.api.nc.closed()]),i.cancel(),r++}}}pull(e){this.pending.bytes+=e.max_bytes??0,this.pending.msgs+=e.batch??0,this.pending.requests++;let t=this.consumer.api.nc;this._push(()=>{t.publish(`${this.consumer.api.prefix}.CONSUMER.MSG.NEXT.${this.consumer.stream}.${this.consumer.name}`,this.consumer.api.jc.encode(e),{reply:this.inbox}),this.notify(M.Next,e)})}pullOptions(){let e=this.opts.max_messages-this.pending.msgs;return{batch:e,max_bytes:this.opts.max_bytes-this.pending.bytes,idle_heartbeat:eT(this.opts.idle_heartbeat),expires:eT(this.opts.expires)}}parseDiscard(e){let t={msgsLeft:0,bytesLeft:0},s=e?.get(w.PendingMessagesHdr);s&&(t.msgsLeft=parseInt(s));let r=e?.get(w.PendingBytesHdr);return r&&(t.bytesLeft=parseInt(r)),t}trackTimeout(e){this.timeout=e}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}clearTimers(){this.monitor?.cancel(),this.monitor=null,this.timeout?.cancel(),this.timeout=null}setCleanupHandler(e){this.cleanupHandler=e}stop(e){this.done||(this.sub?.unsubscribe(),this.clearTimers(),this.statusIterator?.stop(),this._push(()=>{super.stop(e),this.listeners.forEach(e=>{e.stop()})}))}parseOptions(e,t=!1){let s=e||{};if(s.max_messages=s.max_messages||0,s.max_bytes=s.max_bytes||0,0!==s.max_messages&&0!==s.max_bytes)throw Error("only specify one of max_messages or max_bytes");if(0===s.max_messages&&(s.max_messages=100),s.expires=s.expires||3e4,s.expires<1e3)throw Error("expires should be at least 1000ms");if(s.idle_heartbeat=s.idle_heartbeat||s.expires/2,s.idle_heartbeat=s.idle_heartbeat>3e4?3e4:s.idle_heartbeat,t){let e=Math.round(.75*s.max_messages)||1;s.threshold_messages=s.threshold_messages||e;let t=Math.round(.75*s.max_bytes)||1;s.threshold_bytes=s.threshold_bytes||t}return s}status(){let e=new eZ;return this.listeners.push(e),Promise.resolve(e)}}class sh extends eZ{src;listeners;constructor(){super(),this.listeners=[]}setSource(e){this.src&&(this.src.resetHandler=void 0,this.src.setCleanupHandler(),this.src.stop()),this.src=e,this.src.setCleanupHandler(e=>{this.stop(e||void 0)}),(async()=>{for await(let e of(await this.src.status()))this.notify(e.type,e.data)})().catch(()=>{})}notify(e,t){this.listeners.length>0&&(()=>{this.listeners.forEach(s=>{s.done||s.push({type:e,data:t})})})()}stop(e){this.done||(this.src?.stop(e),super.stop(e),this.listeners.forEach(e=>{e.stop()}))}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}status(){let e=new eZ;return this.listeners.push(e),Promise.resolve(e)}}class sl{api;_info;stream;name;constructor(e,t){this.api=e,this._info=t,this.stream=t.stream_name,this.name=t.name}consume(e={max_messages:100,expires:3e4}){return Promise.resolve(new sc(this,e,!0))}fetch(e={max_messages:100,expires:3e4}){let t=new sc(this,e,!1),s=ej(Math.round(1.05*t.opts.expires));return t.closed().catch(()=>{}).finally(()=>{s.cancel()}),s.catch(()=>{t.close().catch()}),t.trackTimeout(s),Promise.resolve(t)}next(e={expires:3e4}){let t=eN();e.max_messages=1;let s=new sc(this,e,!1),r=Math.round(1.05*s.opts.expires);r>=6e4&&(async()=>{for await(let e of(await s.status()))if(e.type===N.HeartbeatsMissed&&e.data>=2){t.reject(Error("consumer missed heartbeats"));break}})().catch(),(async()=>{for await(let e of s){t.resolve(e);break}})().catch(()=>{});let i=ej(r);return s.closed().then(e=>{e?t.reject(e):t.resolve(null)}).catch(e=>{t.reject(e)}).finally(()=>{i.cancel()}),i.catch(e=>{t.resolve(null),s.close().catch()}),s.trackTimeout(i),t}delete(){let{stream_name:e,name:t}=this._info;return this.api.delete(e,t)}info(e=!1){if(e)return Promise.resolve(this._info);let{stream_name:t,name:s}=this._info;return this.api.info(t,s).then(e=>(this._info=e,this._info))}}class su{api;consumerOpts;consumer;opts;cursor;stream;namePrefix;serial;currentConsumer;userCallback;iter;type;startSeq;constructor(e,t,s={}){this.api=e,this.stream=t,this.cursor={stream_seq:1,deliver_seq:0},this.namePrefix=ey.next(),"string"==typeof s.name_prefix&&(eK("name_prefix",s.name_prefix),this.namePrefix=s.name_prefix+this.namePrefix),this.serial=0,this.currentConsumer=null,this.userCallback=null,this.iter=null,this.type=I.Unset,this.consumerOpts=s,this.startSeq=this.consumerOpts.opt_start_seq||0,this.cursor.stream_seq=this.startSeq>0?this.startSeq-1:0}getConsumerOpts(e){this.serial++;let t=`${this.namePrefix}_${this.serial}`;e=0===e?1:e;let s={name:t,deliver_policy:p.StartSequence,opt_start_seq:e,ack_policy:m.None,inactive_threshold:eT(3e5),num_replicas:1};return!0===this.consumerOpts.headers_only&&(s.headers_only=!0),Array.isArray(this.consumerOpts.filterSubjects)&&(s.filter_subjects=this.consumerOpts.filterSubjects),"string"==typeof this.consumerOpts.filterSubjects&&(s.filter_subject=this.consumerOpts.filterSubjects),this.consumerOpts.replay_policy&&(s.replay_policy=this.consumerOpts.replay_policy),e===this.startSeq+1&&(s.deliver_policy=this.consumerOpts.deliver_policy||p.StartSequence,(this.consumerOpts.deliver_policy===p.LastPerSubject||this.consumerOpts.deliver_policy===p.New||this.consumerOpts.deliver_policy===p.Last)&&(delete s.opt_start_seq,s.deliver_policy=this.consumerOpts.deliver_policy),s.deliver_policy===p.LastPerSubject&&void 0===s.filter_subjects&&void 0===s.filter_subject&&(s.filter_subject=">"),this.consumerOpts.opt_start_time&&(delete s.opt_start_seq,s.deliver_policy=p.StartTime,s.opt_start_time=this.consumerOpts.opt_start_time),this.consumerOpts.inactive_threshold&&(s.inactive_threshold=eT(this.consumerOpts.inactive_threshold))),s}async resetConsumer(e=0){let t;this.consumer?.delete().catch(()=>{}),e=0===e?1:e,this.cursor.deliver_seq=0;let s=this.getConsumerOpts(e);s.max_deliver=1,s.mem_storage=!0;let r=eR();for(let i=0;;i++)try{t=await this.api.add(this.stream,s),this.iter?.notify(N.OrderedConsumerRecreated,t.name);break}catch(t){if("stream not found"===t.message&&(this.iter?.notify(N.StreamNotFound,i),this.type===I.Fetch||!0===this.opts.abort_on_missing_resource))return this.iter?.stop(t),Promise.reject(t);if(0===e&&i>=30)throw t;await eI(r.backoff(i+1))}return t}internalHandler(e){return t=>{if(this.serial!==e)return;let s=t.info.deliverySequence;if(s!==this.cursor.deliver_seq+1){this.notifyOrderedResetAndReset();return}this.cursor.deliver_seq=s,this.cursor.stream_seq=t.info.streamSequence,this.userCallback?this.userCallback(t):this.iter?.push(t)}}async reset(e={max_messages:100,expires:3e4},t){let s=(t=t||{}).fromFetch||!1,r=t.orderedReset||!1;if(this.type===I.Fetch&&r){this.iter?.src.stop(),await this.iter?.closed(),this.currentConsumer=null;return}(null===this.currentConsumer||r)&&(this.currentConsumer=await this.resetConsumer(this.cursor.stream_seq+1)),(null===this.iter||s)&&(this.iter=new sh),this.consumer=new sl(this.api,this.currentConsumer),e.callback=this.internalHandler(this.serial);let i=null;this.type===I.Fetch&&s?i=await this.consumer.fetch(e):this.type===I.Consume&&(i=await this.consumer.consume(e));let n=i;n.forOrderedConsumer=!0,n.resetHandler=()=>{this.notifyOrderedResetAndReset()},this.iter.setSource(n)}notifyOrderedResetAndReset(){this.iter?.notify(M.Reset,""),this.reset(this.opts,{orderedReset:!0})}async consume(e={max_messages:100,expires:3e4}){if(e.bind)return Promise.reject(Error("bind is not supported"));if(this.type===I.Fetch)return Promise.reject(Error("ordered consumer initialized as fetch"));if(this.type===I.Consume)return Promise.reject(Error("ordered consumer doesn't support concurrent consume"));let{callback:t}=e;return t&&(this.userCallback=t),this.type=I.Consume,this.opts=e,await this.reset(e),this.iter}async fetch(e={max_messages:100,expires:3e4}){if(e.bind)return Promise.reject(Error("bind is not supported"));if(this.type===I.Consume)return Promise.reject(Error("ordered consumer already initialized as consume"));if(this.iter?.done===!1)return Promise.reject(Error("ordered consumer doesn't support concurrent fetch"));let{callback:t}=e;return t&&(this.userCallback=t),this.type=I.Fetch,this.opts=e,await this.reset(e,{fromFetch:!0}),this.iter}async next(e={expires:3e4}){if(e.bind)return Promise.reject(Error("bind is not supported"));e.max_messages=1;let t=eN();return e.callback=e=>{this.userCallback=null,t.resolve(e)},(await this.fetch(e)).iterClosed.then(e=>{e&&t.reject(e),t.resolve(null)}).catch(e=>{t.reject(e)}),t}delete(){return this.currentConsumer?this.api.delete(this.stream,this.currentConsumer.name).then(e=>Promise.resolve(e)).catch(e=>Promise.reject(e)).finally(()=>{this.currentConsumer=null}):Promise.resolve(!1)}async info(e){return null==this.currentConsumer?(this.currentConsumer=await this.resetConsumer(this.serial),Promise.resolve(this.currentConsumer)):e&&this.currentConsumer?Promise.resolve(this.currentConsumer):this.api.info(this.stream,this.currentConsumer.name)}}class sd{api;notified;constructor(e){this.api=e,this.notified=!1}checkVersion(){let e=this.api.nc.features.get(x.JS_SIMPLIFICATION);return e.ok?Promise.resolve():Promise.reject(Error(`consumers framework is only supported on servers ${e.min} or better`))}async get(e,t={}){return"object"==typeof t?this.ordered(e,t):(await this.checkVersion(),this.api.info(e,t).then(e=>void 0!==e.config.deliver_subject?Promise.reject(Error("push consumer not supported")):new sl(this.api,e)).catch(e=>Promise.reject(e)))}async ordered(e,t){await this.checkVersion();let s=this.api;return new sp(s.nc,s.opts).info(e).then(s=>Promise.resolve(new su(this.api,e,t))).catch(e=>Promise.reject(e))}}class sf{api;_info;constructor(e,t){this.api=e,this._info=t}get name(){return this._info.config.name}alternates(){return this.info().then(e=>e.alternates?e.alternates:[])}async best(){if(await this.info(),!this._info.alternates)return this;{let e=await this.api.info(this._info.alternates[0].name);return new sf(this.api,e)}}info(e=!1,t){return e?Promise.resolve(this._info):this.api.info(this.name,t).then(e=>(this._info=e,this._info))}getConsumer(e){return new sd(new tm(this.api.nc,this.api.opts)).get(this.name,e)}getMessage(e){return this.api.getMessage(this.name,e)}deleteMessage(e,t){return this.api.deleteMessage(this.name,e,t)}}class sp extends tl{constructor(e,t){super(e,t)}checkStreamConfigVersions(e){let t=this.nc;if(e.metadata){let{min:e,ok:s}=t.features.get(x.JS_STREAM_CONSUMER_METADATA);if(!s)throw Error(`stream 'metadata' requires server ${e}`)}if(e.first_seq){let{min:e,ok:s}=t.features.get(x.JS_STREAM_FIRST_SEQ);if(!s)throw Error(`stream 'first_seq' requires server ${e}`)}if(e.subject_transform){let{min:e,ok:s}=t.features.get(x.JS_STREAM_SUBJECT_TRANSFORM);if(!s)throw Error(`stream 'subject_transform' requires server ${e}`)}if(e.compression){let{min:e,ok:s}=t.features.get(x.JS_STREAM_COMPRESSION);if(!s)throw Error(`stream 'compression' requires server ${e}`)}if(e.consumer_limits){let{min:e,ok:s}=t.features.get(x.JS_DEFAULT_CONSUMER_LIMITS);if(!s)throw Error(`stream 'consumer_limits' requires server ${e}`)}function s(e,s){if((s?.subject_transforms?.length||0)>0){let{min:s,ok:r}=t.features.get(x.JS_STREAM_SOURCE_SUBJECT_TRANSFORM);if(!r)throw Error(`${e} 'subject_transforms' requires server ${s}`)}}e.sources&&e.sources.forEach(e=>{s("stream sources",e)}),e.mirror&&s("stream mirror",e.mirror)}async add(e={}){this.checkStreamConfigVersions(e),eG(e.name),e.mirror=se(e.mirror),e.sources=e.sources?.map(se);let t=await this._request(`${this.prefix}.STREAM.CREATE.${e.name}`,e);return this._fixInfo(t),t}async delete(e){return eG(e),(await this._request(`${this.prefix}.STREAM.DELETE.${e}`)).success}async update(e,t={}){if("object"==typeof e){let s=e;e=s.name,t=s,console.trace(`\u001B[33m >> streams.update(config: StreamConfig) api changed to streams.update(name: string, config: StreamUpdateConfig) - this shim will be removed - update your code.  \u001B[0m`)}this.checkStreamConfigVersions(t),eG(e);let s=Object.assign((await this.info(e)).config,t);s.mirror=se(s.mirror),s.sources=s.sources?.map(se);let r=await this._request(`${this.prefix}.STREAM.UPDATE.${e}`,s);return this._fixInfo(r),r}async info(e,t){eG(e);let s=`${this.prefix}.STREAM.INFO.${e}`,r=await this._request(s,t),{total:i,limit:n}=r,o=r.state.subjects?Object.getOwnPropertyNames(r.state.subjects).length:1;if(i&&i>o){let e=[r],a=t||{},c=0;for(;i>o;){c++,a.offset=n*c;let t=await this._request(s,a);i=t.total,e.push(t);let r=Object.getOwnPropertyNames(t.state.subjects).length;if(o+=r,r<n)break}let h={};for(let t=0;t<e.length;t++)(r=e[t]).state.subjects&&(h=Object.assign(h,r.state.subjects));r.offset=0,r.total=0,r.limit=0,r.state.subjects=h}return this._fixInfo(r),r}list(e=""){let t=e?.length?{subject:e}:{};return new tu(`${this.prefix}.STREAM.LIST`,e=>(e.streams.forEach(e=>{this._fixInfo(e)}),e.streams),this,t)}_fixInfo(e){e.config.sealed=e.config.sealed||!1,e.config.deny_delete=e.config.deny_delete||!1,e.config.deny_purge=e.config.deny_purge||!1,e.config.allow_rollup_hdrs=e.config.allow_rollup_hdrs||!1}async purge(e,t){if(t){let{keep:e,seq:s}=t;if("number"==typeof e&&"number"==typeof s)throw Error("can specify one of keep or seq")}return eG(e),await this._request(`${this.prefix}.STREAM.PURGE.${e}`,t)}async deleteMessage(e,t,s=!0){eG(e);let r={seq:t};return s||(r.no_erase=!0),(await this._request(`${this.prefix}.STREAM.MSG.DELETE.${e}`,r)).success}async getMessage(e,t){return eG(e),new s_(await this._request(`${this.prefix}.STREAM.MSG.GET.${e}`,t))}find(e){return this.findStream(e)}listKvs(){return new tu(`${this.prefix}.STREAM.LIST`,e=>{let t=e.streams.filter(e=>e.config.name.startsWith("KV_"));t.forEach(e=>{this._fixInfo(e)});let s="";return t.length&&(s=this.nc.info?.cluster??""),t.map(e=>new t6(e,s))},this)}listObjectStores(){return new tu(`${this.prefix}.STREAM.LIST`,e=>{let t=e.streams.filter(e=>e.config.name.startsWith(t8));return t.forEach(e=>{this._fixInfo(e)}),t.map(e=>new t9(e))},this)}names(e=""){let t=e?.length?{subject:e}:{};return new tu(`${this.prefix}.STREAM.NAMES`,e=>e.streams,this,t)}async get(e){return Promise.resolve(new sf(this,await this.info(e)))}}class sm extends tl{constructor(e,t){super(e,t)}async getMessage(e,t){eG(e);let s=t,{last_by_subj:r}=s;r&&(s=null);let i=s?this.jc.encode(s):ed,n=this.opts.apiPrefix||"$JS.API",o=r?`${n}.DIRECT.GET.${e}.${r}`:`${n}.DIRECT.GET.${e}`,a=await this.nc.request(o,i),c=eX(a);return c?Promise.reject(c):Promise.resolve(new sg(a))}async getBatch(e,t){eG(e);let s=this.opts.apiPrefix||"$JS.API",r=`${s}.DIRECT.GET.${e}`;if(!Array.isArray(t.multi_last)||0===t.multi_last.length)return Promise.reject("multi_last is required");let i=JSON.stringify(t,(e,t)=>"up_to_time"===e&&t instanceof Date?t.toISOString():t),n=new eZ,o=await this.nc.requestMany(r,i,{strategy:a.SentinelMsg});return(async()=>{let e,t=!1,s=!1;for await(let r of o){if(!t){t=!0;let i=r.headers?.code||0;if(0!==i&&i<200||i>299){e=r.headers?.description.toLowerCase();break}if(""===r.headers?.get("Nats-Num-Pending")){s=!0;break}}if(0===r.data.length)break;n.push(new sg(r))}n.push(()=>{if(s)throw Error("batch direct get not supported by the server");if(e)throw Error(`bad request: ${e}`);n.stop()})})(),Promise.resolve(n)}}class sg{data;header;static jc;constructor(e){if(!e.headers)throw Error("headers expected");this.data=e.data,this.header=e.headers}get subject(){return this.header.last(v.Subject)}get seq(){let e=this.header.last(v.Sequence);return"string"==typeof e?parseInt(e):0}get time(){return new Date(Date.parse(this.timestamp))}get timestamp(){return this.header.last(v.TimeStamp)}get stream(){return this.header.last(v.Stream)}json(e){return eD(e).decode(this.data)}string(){return ep.decode(this.data)}}class sb extends tl{streams;consumers;direct;constructor(e,t){super(e,t),this.streams=new sp(e,t),this.consumers=new tm(e,t),this.direct=new sm(e,t)}async getAccountInfo(){return await this._request(`${this.prefix}.INFO`)}jetstream(){return this.nc.jetstream(this.getOptions())}advisories(){let e=new eZ;return this.nc.subscribe("$JS.EVENT.ADVISORY.>",{callback:(t,s)=>{if(t)throw t;try{let t=this.parseJsResponse(s),r=t.type.split("."),i=r[r.length-1];e.push({kind:i,data:t})}catch(t){e.stop(t)}}}),e}}class s_{_header;smr;static jc;constructor(e){this.smr=e}get subject(){return this.smr.message.subject}get seq(){return this.smr.message.seq}get timestamp(){return this.smr.message.time}get time(){return new Date(Date.parse(this.timestamp))}get data(){return this.smr.message.data?this._parse(this.smr.message.data):ed}get header(){if(!this._header){if(this.smr.message.hdrs){let e=this._parse(this.smr.message.hdrs);this._header=eL.decode(e)}else this._header=eq()}return this._header}_parse(e){let t=atob(e),s=t.length,r=new Uint8Array(s);for(let e=0;e<s;e++)r[e]=t.charCodeAt(e);return r}json(e){return eD(e).decode(this.data)}string(){return ep.decode(this.data)}}class sy{api;constructor(e){this.api=e}get(e){return this.api.info(e).then(e=>new sf(this.api,e))}}class sw{info;hdrs;constructor(e){this.info=e}get name(){return this.info.name}get description(){return this.info.description??""}get headers(){return this.hdrs||(this.hdrs=eL.fromRecord(this.info.headers||{})),this.hdrs}get options(){return this.info.options}get bucket(){return this.info.bucket}get chunks(){return this.info.chunks}get deleted(){return this.info.deleted??!1}get digest(){return this.info.digest}get mtime(){return this.info.mtime}get nuid(){return this.info.nuid}get size(){return this.info.size}get revision(){return this.info.revision}get metadata(){return this.info.metadata||{}}isLink(){return this.info.options?.link!==void 0&&this.info.options?.link!==null}}function sS(e){let t={name:e.name,description:e.description??"",options:e.options,metadata:e.metadata};if(e.headers){let s=e.headers;t.headers=s.toRecord()}return t}class sv{jsm;js;stream;name;constructor(e,t,s){this.name=e,this.jsm=t,this.js=s}_checkNotEmpty(e){return e&&0!==e.length?{name:e}:{name:e,error:Error("name cannot be empty")}}async info(e){let t=await this.rawInfo(e);return t?new sw(t):null}async list(){let e=[];for await(let t of(await this.watch({ignoreDeletes:!0,includeHistory:!0}))){if(null===t)break;e.push(t)}return Promise.resolve(e)}async rawInfo(e){let{name:t,error:s}=this._checkNotEmpty(e);if(s)return Promise.reject(s);let r=this._metaSubject(t);try{let e=await this.jsm.streams.getMessage(this.stream,{last_by_subj:r}),t=eD().decode(e.data);return t.revision=e.seq,t}catch(e){if("404"===e.code)return null;return Promise.reject(e)}}async _si(e){try{return await this.jsm.streams.info(this.stream,e)}catch(e){if("404"===e.code)return null;return Promise.reject(e)}}async seal(){let e=await this._si();return null===e?Promise.reject(Error("object store not found")):(e.config.sealed=!0,Promise.resolve(new t9(e=await this.jsm.streams.update(this.stream,e.config))))}async status(e){let t=await this._si(e);return null===t?Promise.reject(Error("object store not found")):Promise.resolve(new t9(t))}destroy(){return this.jsm.streams.delete(this.stream)}async _put(e,t,s){let r=this.js.getOptions();(s=s||{timeout:r.timeout}).timeout=s.timeout||r.timeout,s.previousRevision=s.previousRevision??void 0;let{timeout:i,previousRevision:n}=s,o=this.js.nc.info,a=o?.max_payload||1024;(e=e||{}).options=e.options||{};let c=e.options?.max_chunk_size||131072;c=c>a?a:c,e.options.max_chunk_size=c;let h=await this.info(e.name),{name:l,error:u}=this._checkNotEmpty(e.name);if(u)return Promise.reject(u);let d=ey.next(),f=this._chunkSubject(d),p=this._metaSubject(l),m=Object.assign({bucket:this.name,nuid:d,size:0,chunks:0},sS(e)),g=eN(),b=[],_=new e6;try{let s=t?t.getReader():null,r=new to;for(;;){let{done:t,value:o}=s?await s.read():{done:!0,value:void 0};if(t){if(_.size()>0){let e=_.drain();r.update(e),m.chunks++,m.size+=e.length,b.push(this.js.publish(f,e,{timeout:i}))}await Promise.all(b),b.length=0,m.mtime=new Date().toISOString();let e=r.digest("base64"),t=e.length%3,s=t>0?"=".repeat(t):"";m.digest=`${t7}${e}${s}`,m.deleted=!1;let o=eq();"number"==typeof n&&o.set(j.ExpectedLastSubjectSequenceHdr,`${n}`),o.set(w.RollupHdr,w.RollupValueSubject);let a=await this.js.publish(p,eD().encode(m),{headers:o,timeout:i});if(m.revision=a.seq,h)try{await this.jsm.streams.purge(this.stream,{filter:`$O.${this.name}.C.${h.nuid}`})}catch(e){}g.resolve(new sw(m));break}if(o)for(_.fill(o);_.size()>c;){m.chunks++,m.size+=c;let t=_.drain(e.options.max_chunk_size);r.update(t),b.push(this.js.publish(f,t,{timeout:i}))}}}catch(e){await this.jsm.streams.purge(this.stream,{filter:f}),g.reject(e)}return g}putBlob(e,t,s){var r;return null===t&&(t=new Uint8Array(0)),this.put(e,(r=t,new ReadableStream({pull(e){e.enqueue(r),e.close()}})),s)}put(e,t,s){return e?.options?.link?Promise.reject(Error("link cannot be set when putting the object in bucket")):this._put(e,t,s)}async getBlob(e){async function t(e){let t=new e6,s=e.getReader();for(;;){let{done:e,value:r}=await s.read();if(e)return t.drain();r&&r.length&&t.fill(r)}}let s=await this.get(e);if(null===s)return Promise.resolve(null);let r=await Promise.all([s.error,t(s.data)]);return r[0]?Promise.reject(r[0]):Promise.resolve(r[1])}async get(e){let t;let s=await this.rawInfo(e);if(null===s||s.deleted)return Promise.resolve(null);if(s.options&&s.options.link){let e=s.options.link.name||"";if(""===e)throw Error("link is a bucket");return(s.options.link.bucket!==this.name?await sv.create(this.js,s.options.link.bucket):this).get(e)}let r=eN(),i={info:new sw(s),error:r};if(0===s.size)return i.data=new ReadableStream({pull(e){e.enqueue(new Uint8Array(0)),e.close()}}),r.resolve(null),Promise.resolve(i);let n=e2();n.orderedConsumer();let o=new to,a=`$O.${this.name}.C.${s.nuid}`,c=await this.js.subscribe(a,n);return(async()=>{for await(let e of c)if(e.data.length>0&&(o.update(e.data),t.enqueue(e.data)),0===e.info.pending){let e=o.digest("base64"),r=e.length%3,i=r>0?"=".repeat(r):"",n=`${t7}${e}${i}`;n!==s.digest?t.error(Error(`received a corrupt object, digests do not match received: ${s.digest} calculated ${n}`)):t.close(),c.unsubscribe()}})().then(()=>{r.resolve()}).catch(e=>{t.error(e),r.reject(e)}),i.data=new ReadableStream({start(e){t=e},cancel(){c.unsubscribe()}}),i}linkStore(e,t){if(!(t instanceof sv))return Promise.reject("bucket required");let{name:s,error:r}=this._checkNotEmpty(e);if(r)return Promise.reject(r);let i={name:s,options:{link:{bucket:t.name}}};return this._put(i,null)}async link(e,t){let{name:s,error:r}=this._checkNotEmpty(e);if(r)return Promise.reject(r);if(t.deleted)return Promise.reject(Error("src object is deleted"));if(t.isLink())return Promise.reject(Error("src object is a link"));let i=await this.rawInfo(e);if(null!==i&&!i.deleted)return Promise.reject(Error("an object already exists with that name"));let n={bucket:t.bucket,name:t.name},o={name:s,bucket:t.bucket,options:{link:n}};return await this.js.publish(this._metaSubject(e),JSON.stringify(o)),Promise.resolve(await this.info(e))}async delete(e){let t=await this.rawInfo(e);if(null===t)return Promise.resolve({purged:0,success:!1});t.deleted=!0,t.size=0,t.chunks=0,t.digest="";let s=eD(),r=eq();return r.set(w.RollupHdr,w.RollupValueSubject),await this.js.publish(this._metaSubject(t.name),s.encode(t),{headers:r}),this.jsm.streams.purge(this.stream,{filter:this._chunkSubject(t.nuid)})}async update(e,t={}){let s=await this.rawInfo(e);if(null===s)return Promise.reject(Error("object not found"));if(s.deleted)return Promise.reject(Error("cannot update meta for a deleted object"));t.name=t.name??s.name;let{name:r,error:i}=this._checkNotEmpty(t.name);if(i)return Promise.reject(i);if(e!==t.name){let e=await this.info(t.name);if(e&&!e.deleted)return Promise.reject(Error("an object already exists with that name"))}t.name=r;let n=Object.assign({},s,sS(t)),o=await this.js.publish(this._metaSubject(n.name),JSON.stringify(n));return e!==t.name&&await this.jsm.streams.purge(this.stream,{filter:this._metaSubject(e)}),Promise.resolve(o)}async watch(e={}){e.includeHistory=e.includeHistory??!1,e.ignoreDeletes=e.ignoreDeletes??!1;let t=!1,s=new eZ,r=this._metaSubjectAll();try{await this.jsm.streams.getMessage(this.stream,{last_by_subj:r})}catch(e){"404"===e.code?(s.push(null),t=!0):s.stop(e)}let i=eD(),n=e2();n.orderedConsumer(),e.includeHistory?n.deliverLastPerSubject():(t=!0,n.deliverNew()),n.callback((r,n)=>{if(r){s.stop(r);return}if(null!==n){let r=i.decode(n.data);r.deleted&&!0===e.ignoreDeletes||s.push(r),n.info?.pending!==0||t||(t=!0,s.push(null))}});let o=await this.js.subscribe(r,n);return s._data=o,s.iterClosed.then(()=>{o.unsubscribe()}),o.closed.then(()=>{s.stop()}).catch(e=>{s.stop(e)}),s}_chunkSubject(e){return`$O.${this.name}.C.${e}`}_metaSubject(e){return`$O.${this.name}.M.${e5.encode(e)}`}_metaSubjectAll(){return`$O.${this.name}.M.>`}async init(e={}){try{var t;this.stream=(t=this.name,t4(t),`${t8}${t}`)}catch(e){return Promise.reject(e)}let s=e?.ttl||0;delete e.ttl;let r=Object.assign({max_age:s},e);r.name=this.stream,r.num_replicas=e.replicas??1,r.allow_direct=!0,r.allow_rollup_hdrs=!0,r.discard=d.New,r.subjects=[`$O.${this.name}.C.>`,`$O.${this.name}.M.>`],e.placement&&(r.placement=e.placement),e.metadata&&(r.metadata=e.metadata),"boolean"==typeof e.compression&&(r.compression=e.compression?b.S2:b.None);try{await this.jsm.streams.info(r.name)}catch(e){"stream not found"===e.message&&await this.jsm.streams.add(r)}}static async create(e,t,s={}){let r=new sv(t,await e.jetstreamManager(),e);return await r.init(s),Promise.resolve(r)}}class sE{js;constructor(e){this.js=e}kv(e,t={}){let{ok:s,min:r}=this.js.nc.features.get(x.JS_KV);return s?t.bindOnly?t5.bind(this.js,e,t):t5.create(this.js,e,t):Promise.reject(Error(`kv is only supported on servers ${r} or better`))}os(e,t={}){if("function"!=typeof crypto?.subtle?.digest)return Promise.reject(Error("objectstore: unable to calculate hashes - crypto.subtle.digest with sha256 support is required"));let{ok:s,min:r}=this.js.nc.features.get(x.JS_OBJECTSTORE);return s?sv.create(this.js,e,t):Promise.reject(Error(`objectstore is only supported on servers ${r} or better`))}}class sx extends tl{consumers;streams;consumerAPI;streamAPI;constructor(e,t){super(e,t),this.consumerAPI=new tm(e,t),this.streamAPI=new sp(e,t),this.consumers=new sd(this.consumerAPI),this.streams=new sy(this.streamAPI)}jetstreamManager(e){void 0===e&&(e=this.opts.checkAPI);let t=Object.assign({},this.opts,{checkAPI:e});return this.nc.jetstreamManager(t)}get apiPrefix(){return this.prefix}get views(){return new sE(this)}async publish(e,t=ed,s){let r;(s=s||{}).expect=s.expect||{};let i=s?.headers||eq();s&&(s.msgID&&i.set(j.MsgIdHdr,s.msgID),s.expect.lastMsgID&&i.set(j.ExpectedLastMsgIdHdr,s.expect.lastMsgID),s.expect.streamName&&i.set(j.ExpectedStreamHdr,s.expect.streamName),"number"==typeof s.expect.lastSequence&&i.set(j.ExpectedLastSeqHdr,`${s.expect.lastSequence}`),"number"==typeof s.expect.lastSubjectSequence&&i.set(j.ExpectedLastSubjectSequenceHdr,`${s.expect.lastSubjectSequence}`));let o=s.timeout||this.timeout,a={};o&&(a.timeout=o),s&&(a.headers=i);let{retries:c,retry_delay:h}=s;c=c||1,h=h||250;for(let s=0;s<c;s++)try{r=await this.nc.request(e,t,a);break}catch(e){if("503"===e.code&&s+1<c)await eI(h);else throw e}let l=this.parseJsResponse(r);if(""===l.stream)throw ev.errorForCode(n.JetStreamInvalidAck);return l.duplicate=!!l.duplicate&&l.duplicate,l}async pull(e,t,s=0){eG(e),ez(t);let r=this.timeout;s>r&&(r=s);let i={batch:1,no_wait:0===(s=s<0?0:eT(s)),expires:s},n=await this.nc.request(`${this.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,this.jc.encode(i),{noMux:!0,timeout:r}),o=eX(n);if(o)throw o;return sa(n,this.timeout)}fetch(e,t,s={}){eG(e),ez(t);let r=null,i=(s.max_bytes??0)>0,o=0,a=i?s.max_bytes:0,c=null,h={};if(h.batch=s.batch||1,a){let e=this.nc.features.get(x.JS_PULL_MAX_BYTES);if(!e.ok)throw Error(`max_bytes is only supported on servers ${e.min} or better`);h.max_bytes=a}h.no_wait=s.no_wait||!1,h.no_wait&&h.expires&&(h.expires=0);let u=s.expires||0;if(u&&(h.expires=eT(u)),0===u&&!1===h.no_wait)throw Error("expires or no_wait is required");let d=s.idle_heartbeat||0;d&&(h.idle_heartbeat=eT(d),!0===s.delay_heartbeat&&(h.idle_heartbeat=eT(4*d)));let f=new eZ,p=h.batch,m=0;f.protocolFilterFn=(e,t=!1)=>!eY(e.msg)||(c?.work(),!1),f.dispatchedFn=e=>{e&&(i&&(o+=e.data.length),m++,(!r||0!==e.info.pending)&&(1===f.getPending()&&0===e.info.pending||p===m||a>0&&o>=a)&&f.stop())};let g=eP(this.nc.options.inboxPrefix),b=this.nc.subscribe(g,{max:s.batch,callback:(e,t)=>{(null===e&&(e=eX(t)),null!==e)?(r&&(r.cancel(),r=null),"string"==typeof e.code)?f.stop(null===sI(e)?void 0:e):f.stop(e):(c?.work(),f.received++,f.push(sa(t,this.timeout)))}});return u&&(r=ej(u)).catch(()=>{b.isClosed()||(b.drain().catch(()=>{}),r=null),c&&c.cancel()}),(async()=>{try{d&&(c=new e0(d,e=>(f.push(()=>{f.err=new ev(`${l.IdleHeartbeatMissed}: ${e}`,n.JetStreamIdleHeartBeat)}),!0)))}catch(e){}await b.closed,null!==r&&(r.cancel(),r=null),c&&c.cancel(),f.stop()})().catch(),this.nc.publish(`${this.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,this.jc.encode(h),{reply:g}),f}async pullSubscribe(e,t=e2()){let s=await this._processOptions(e,t);if(s.ordered)throw Error("pull subscribers cannot be be ordered");if(s.config.deliver_subject)throw Error("consumer info specifies deliver_subject - pull consumers cannot have deliver_subject set");let r=s.config.ack_policy;if(r===m.None||r===m.All)throw Error("ack policy for pull consumers must be explicit");let i=this._buildTypedSubscriptionOpts(s),n=new sj(this,s.deliver,i);n.info=s;try{await this._maybeCreateConsumer(s)}catch(e){throw n.unsubscribe(),e}return n}async subscribe(e,t=e2()){let s=await this._processOptions(e,t);if(!s.isBind&&!s.config.deliver_subject)throw Error("push consumer requires deliver_subject");let r=this._buildTypedSubscriptionOpts(s),i=new sO(this,s.deliver,r);i.info=s;try{await this._maybeCreateConsumer(s)}catch(e){throw i.unsubscribe(),e}return i._maybeSetupHbMonitoring(),i}async _processOptions(e,t=e2()){let s=e3(t)?t.getOpts():t;if(s.isBind=!!e3(t)&&t.isBind,s.flow_control={heartbeat_count:0,fc_count:0,consumer_restarts:0},s.ordered){if(s.ordered_consumer_sequence={stream_seq:0,delivery_seq:0},s.config.ack_policy!==m.NotSet&&s.config.ack_policy!==m.None)throw new ev("ordered consumer: ack_policy can only be set to 'none'",n.ApiError);if(s.config.durable_name&&s.config.durable_name.length>0)throw new ev("ordered consumer: durable_name cannot be set",n.ApiError);if(s.config.deliver_subject&&s.config.deliver_subject.length>0)throw new ev("ordered consumer: deliver_subject cannot be set",n.ApiError);if(void 0!==s.config.max_deliver&&s.config.max_deliver>1)throw new ev("ordered consumer: max_deliver cannot be set",n.ApiError);if(s.config.deliver_group&&s.config.deliver_group.length>0)throw new ev("ordered consumer: deliver_group cannot be set",n.ApiError);s.config.deliver_subject=eP(this.nc.options.inboxPrefix),s.config.ack_policy=m.None,s.config.max_deliver=1,s.config.flow_control=!0,s.config.idle_heartbeat=s.config.idle_heartbeat||eT(5e3),s.config.ack_wait=eT(792e5),s.config.mem_storage=!0,s.config.num_replicas=1}if(s.config.ack_policy===m.NotSet&&(s.config.ack_policy=m.All),s.api=this,s.config=s.config||{},s.stream=s.stream?s.stream:await this.findStream(e),s.attached=!1,s.config.durable_name)try{let t=await this.consumerAPI.info(s.stream,s.config.durable_name);if(t){if(t.config.filter_subject&&t.config.filter_subject!==e)throw Error("subject does not match consumer");let r=s.config.deliver_group??"";if(""===r&&!0===t.push_bound)throw Error("duplicate subscription");let i=t.config.deliver_group??"";if(r!==i){if(""===i)throw Error("durable requires no queue group");throw Error(`durable requires queue group '${i}'`)}s.last=t,s.config=t.config,s.attached=!0,s.config.durable_name||(s.name=t.name)}}catch(e){if("404"!==e.code)throw e}return s.attached||void 0!==s.config.filter_subject||void 0!==s.config.filter_subjects||(s.config.filter_subject=e),s.deliver=s.config.deliver_subject||eP(this.nc.options.inboxPrefix),s}_buildTypedSubscriptionOpts(e){var t,s;let r={};return r.adapter=(t=void 0===e.callbackFn,s=this.timeout,t?(e,t)=>{if(e)return[e,null];let r=eX(t);return null!==r?[sI(r),null]:[null,sa(t,s)]}:(e,t)=>e||(e=eX(t))?[e,null]:[null,sa(t,s)]),r.ingestionFilterFn=sx.ingestionFn(e.ordered),r.protocolFilterFn=(e,t=!1)=>!eW(e.msg)||(t||e.msg.respond(),!1),e.mack||e.config.ack_policy===m.None||(r.dispatchedFn=sN),e.callbackFn&&(r.callback=e.callbackFn),r.max=e.max||0,r.queue=e.queue,r}async _maybeCreateConsumer(e){if(e.attached)return;if(e.isBind)throw Error(`unable to bind - durable consumer ${e.config.durable_name} doesn't exist in ${e.stream}`);e.config=Object.assign({deliver_policy:p.All,ack_policy:m.Explicit,ack_wait:eT(3e4),replay_policy:g.Instant},e.config);let t=await this.consumerAPI.add(e.stream,e.config);if(Array.isArray(e.config.filter_subjects&&!Array.isArray(t.config.filter_subjects)))throw Error("jetstream server doesn't support consumers with multiple filter subjects");e.name=t.name,e.config=t.config,e.last=t}static ingestionFn(e){return(t,s)=>{if(!t)return{ingest:!1,protocol:!1};if(eX(t.msg)||s.monitor?.work(),eY(t.msg)){let r=!e||s._checkHbOrderConsumer(t.msg);return!e&&s.info.flow_control.heartbeat_count++,{ingest:r,protocol:!0}}return eW(t.msg)?(s.info.flow_control.fc_count++,{ingest:!0,protocol:!0}):{ingest:!e||s._checkOrderedConsumer(t),protocol:!1}}}}class sA{options;protocol;draining;listeners;_services;constructor(e){this.draining=!1,this.options=function(e){let t=`${ek}:${t_()}`;if((e=e||{servers:[t]}).servers=e.servers||[],"string"==typeof e.servers&&(e.servers=[e.servers]),e.servers.length>0&&e.port)throw new ev("port and servers options are mutually exclusive",n.InvalidOption);0===e.servers.length&&e.port&&(e.servers=[`${ek}:${e.port}`]),e.servers&&0===e.servers.length&&(e.servers=[t]);let s=eC({maxPingOut:2,maxReconnectAttempts:10,noRandomize:!1,pedantic:!1,pingInterval:12e4,reconnect:!0,reconnectJitter:100,reconnectJitterTLS:1e3,reconnectTimeWait:2e3,tls:void 0,verbose:!1,waitOnFirstConnect:!1,ignoreAuthErrorAbort:!1},e);if(s.authenticator=function(e){var t,s,r;let i=[];return"function"==typeof e.authenticator&&i.push(e.authenticator),Array.isArray(e.authenticator)&&i.push(...e.authenticator),e.token&&i.push((t=e.token,()=>({auth_token:"function"==typeof t?t():t}))),e.user&&i.push((s=e.user,r=e.pass,()=>({user:"function"==typeof s?s():s,pass:"function"==typeof r?r():r}))),0===i.length?()=>{}:e=>{let t={};return i.forEach(s=>{let r=s(e)||{};t=Object.assign(t,r)}),t}}(s),["reconnectDelayHandler","authenticator"].forEach(e=>{if(s[e]&&"function"!=typeof s[e])throw new ev(`${e} option should be a function`,n.NotFunction)}),s.reconnectDelayHandler||(s.reconnectDelayHandler=()=>{let e=s.tls?s.reconnectJitterTLS:s.reconnectJitter;return e&&(e=Math.floor(Math.random()*++e)),s.reconnectTimeWait+e}),s.inboxPrefix)try{eP(s.inboxPrefix)}catch(e){throw new ev(e.message,n.ApiError)}if(void 0===s.resolve&&(s.resolve="function"==typeof tw()),s.resolve&&"function"!=typeof tw())throw new ev("'resolve' is not supported on this client",n.InvalidOption);return s}(e),this.listeners=[]}static connect(e={}){return new Promise((t,s)=>{let r=new sA(e);tJ.connect(r.options,r).then(e=>{r.protocol=e,async function(){for await(let t of e.status())r.listeners.forEach(e=>{e.push(t)})}(),t(r)}).catch(e=>{s(e)})})}closed(){return this.protocol.closed}async close(){await this.protocol.close()}_check(e,t,s){if(this.isClosed())throw ev.errorForCode(n.ConnectionClosed);if(t&&this.isDraining()||s&&this.protocol.noMorePublishing)throw ev.errorForCode(n.ConnectionDraining);if(0===(e=e||"").length)throw ev.errorForCode(n.BadSubject)}publish(e,t,s){this._check(e,!1,!0),this.protocol.publish(e,t,s)}publishMessage(e){return this.publish(e.subject,e.data,{reply:e.reply,headers:e.headers})}respondMessage(e){return!!e.reply&&(this.publish(e.reply,e.data,{reply:e.reply,headers:e.headers}),!0)}subscribe(e,t={}){this._check(e,!0,!1);let s=new tD(this.protocol,e,t);return this.protocol.subscribe(s),s}_resub(e,t,s){this._check(t,!0,!1),e.max=s,s&&(e.max=s+e.received),this.protocol.resub(e,t)}requestMany(e,t=ed,s={maxWait:1e3,maxMessages:-1}){let r=!this.protocol.options.noAsyncTraces;try{this._check(e,!0,!0)}catch(e){return Promise.reject(e)}if(s.strategy=s.strategy||a.Timer,s.maxWait=s.maxWait||1e3,s.maxWait<1)return Promise.reject(new ev("timeout",n.InvalidOption));let i=new eZ;function o(e){i.push(()=>{i.stop(e)})}function c(e,t){e||null===t?o(null===e?void 0:e):i.push(t)}if(s.noMux){let h=r?Error().stack:null,l="number"==typeof s.maxMessages&&s.maxMessages>0?s.maxMessages:-1,u=this.subscribe(eP(this.options.inboxPrefix),{callback:(e,t)=>{if(t?.data?.length===0&&t?.headers?.status===n.NoResponders&&(e=ev.errorForCode(n.NoResponders)),e){h&&(e.stack+=`

${h}`),d(e);return}c(null,t),s.strategy===a.Count&&0==--l&&d(),s.strategy===a.JitterTimer&&(p(),f=setTimeout(()=>{d()},300)),s.strategy===a.SentinelMsg&&t&&0===t.data.length&&d()}});u.requestSubject=e,u.closed.then(()=>{o()}).catch(e=>{i.stop(e)});let d=e=>{e&&i.push(()=>{throw e}),p(),u.drain().then(()=>{o()}).catch(e=>{o()})};i.iterClosed.then(()=>{p(),u?.unsubscribe()}).catch(e=>{p(),u?.unsubscribe()});try{this.publish(e,t,{reply:u.getSubject()})}catch(e){d(e)}let f=setTimeout(()=>{d()},s.maxWait),p=()=>{f&&clearTimeout(f)}}else{s.callback=c,i.iterClosed.then(()=>{r.cancel()}).catch(e=>{r.cancel(e)});let r=new tc(this.protocol.muxSubscriptions,e,s);this.protocol.request(r);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${r.token}`,headers:s.headers})}catch(e){r.cancel(e)}}return Promise.resolve(i)}request(e,t,s={timeout:1e3,noMux:!1}){try{this._check(e,!0,!0)}catch(e){return Promise.reject(e)}let r=!this.protocol.options.noAsyncTraces;if(s.timeout=s.timeout||1e3,s.timeout<1)return Promise.reject(new ev("timeout",n.InvalidOption));if(!s.noMux&&s.reply)return Promise.reject(new ev("reply can only be used with noMux",n.InvalidOption));if(s.noMux){let i=s.reply?s.reply:eP(this.options.inboxPrefix),o=eN(),a=r?Error():null,c=this.subscribe(i,{max:1,timeout:s.timeout,callback:(e,t)=>{e?(a&&e.code!==n.Timeout&&(e.stack+=`

${a.stack}`),c.unsubscribe(),o.reject(e)):(e=eH(t))?(a&&(e.stack+=`

${a.stack}`),o.reject(e)):o.resolve(t)}});return c.requestSubject=e,this.protocol.publish(e,t,{reply:i,headers:s.headers}),o}{let i=new th(this.protocol.muxSubscriptions,e,s,r);this.protocol.request(i);try{this.publish(e,t,{reply:`${this.protocol.muxSubscriptions.baseInbox}${i.token}`,headers:s.headers})}catch(e){i.cancel(e)}let n=Promise.race([i.timer,i.deferred]);return n.catch(()=>{i.cancel()}),n}}flush(){return this.isClosed()?Promise.reject(ev.errorForCode(n.ConnectionClosed)):this.protocol.flush()}drain(){return this.isClosed()?Promise.reject(ev.errorForCode(n.ConnectionClosed)):this.isDraining()?Promise.reject(ev.errorForCode(n.ConnectionDraining)):(this.draining=!0,this.protocol.drain())}isClosed(){return this.protocol.isClosed()}isDraining(){return this.draining}getServer(){let e=this.protocol.getServer();return e?e.listen:""}status(){let e=new eZ;return e.iterClosed.then(()=>{let t=this.listeners.indexOf(e);this.listeners.splice(t,1)}),this.listeners.push(e),e}get info(){return this.protocol.isClosed()?void 0:this.protocol.info}async context(){return(await this.request("$SYS.REQ.USER.INFO")).json((e,t)=>"time"===e?new Date(Date.parse(t)):t)}stats(){return{inBytes:this.protocol.inBytes,outBytes:this.protocol.outBytes,inMsgs:this.protocol.inMsgs,outMsgs:this.protocol.outMsgs}}async jetstreamManager(e={}){let t=new sb(this,e);if(!1!==e.checkAPI)try{await t.getAccountInfo()}catch(e){throw e.code===n.NoResponders&&(e.code=n.JetStreamNotEnabled),e}return t}jetstream(e={}){return new sx(this,e)}getServerVersion(){let e=this.info;return e?td(e.version):void 0}async rtt(){if(!this.protocol._closed&&!this.protocol.connected)throw ev.errorForCode(n.Disconnect);let e=Date.now();return await this.flush(),Date.now()-e}get features(){return this.protocol.features}get services(){return this._services||(this._services=new sP(this)),this._services}reconnect(){return this.isClosed()?Promise.reject(ev.errorForCode(n.ConnectionClosed)):this.isDraining()?Promise.reject(ev.errorForCode(n.ConnectionDraining)):this.protocol.reconnect()}}class sP{nc;constructor(e){this.nc=e}add(e){try{return new tK(this.nc,e).start()}catch(e){return Promise.reject(e)}}client(e,t){return new tW(this.nc,e,t)}}class sk{bucket;sm;prefixLen;constructor(e,t,s){this.bucket=e,this.prefixLen=t,this.sm=s}get key(){return this.sm.subject.substring(this.prefixLen)}get value(){return this.sm.data}get delta(){return 0}get created(){return this.sm.time}get revision(){return this.sm.seq}get operation(){return this.sm.header.get(tX)||"PUT"}get length(){let e=this.sm.header.get(w.MessageSizeHdr)||"";return""!==e?parseInt(e,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class sC{bucket;key;sm;constructor(e,t,s){this.bucket=e,this.key=t,this.sm=s}get value(){return this.sm.data}get created(){return new Date(e$(this.sm.info.timestampNanos))}get revision(){return this.sm.seq}get operation(){return this.sm.headers?.get(tX)||"PUT"}get delta(){return this.sm.info.pending}get length(){let e=this.sm.headers?.get(w.MessageSizeHdr)||"";return""!==e?parseInt(e,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class sO extends tb{js;monitor;constructor(e,t,s){super(e.nc,t,s),this.js=e,this.monitor=null,this.sub.closed.then(()=>{this.monitor&&this.monitor.cancel()})}set info(e){this.sub.info=e}get info(){return this.sub.info}_resetOrderedConsumer(e){if(null===this.info||this.sub.isClosed())return;let t=eP(this.js.nc.options.inboxPrefix);this.js.nc._resub(this.sub,t);let s=this.info;s.config.name=ey.next(),s.ordered_consumer_sequence.delivery_seq=0,s.flow_control.heartbeat_count=0,s.flow_control.fc_count=0,s.flow_control.consumer_restarts++,s.deliver=t,s.config.deliver_subject=t,s.config.deliver_policy=p.StartSequence,s.config.opt_start_seq=e;let r={};r.stream_name=this.info.stream,r.config=s.config;let i=`${s.api.prefix}.CONSUMER.CREATE.${s.stream}`;this.js._request(i,r,{retries:-1}).then(e=>{this.sub.info.last=e,this.info.config=e.config,this.info.name=e.name}).catch(t=>{let r=new ev(`unable to recreate ordered consumer ${s.stream} at seq ${e}`,n.RequestError,t);this.sub.callback(r,{})})}_maybeSetupHbMonitoring(){let e=this.info?.config?.idle_heartbeat||0;e&&this._setupHbMonitoring(e$(e))}_setupHbMonitoring(e,t=0){let s={cancelAfter:0,maxOut:2};t&&(s.cancelAfter=t);let r=this.sub;this.monitor=new e0(e,e=>{let t=function(e,t,s){let r=eq(409,t),i=new eJ({hdr:1,sid:0,size:0},ed,{});return i._headers=r,i._subject=s,i}(0,`${l.IdleHeartbeatMissed}: ${e}`,this.sub.subject);if(this.info?.ordered){if(!this.js.nc.protocol.connected)return!1;let e=this.info?.ordered_consumer_sequence?.stream_seq||0;return this._resetOrderedConsumer(e+1),this.monitor?.restart(),!1}return this.sub.callback(null,t),!r.noIterator},s)}_checkHbOrderConsumer(e){let t=e.headers.get(w.ConsumerStalledHdr);""!==t&&this.js.nc.publish(t);let s=parseInt(e.headers.get(w.LastConsumerSeqHdr),10),r=this.info.ordered_consumer_sequence;return this.info.flow_control.heartbeat_count++,s!==r.delivery_seq&&this._resetOrderedConsumer(r.stream_seq+1),!1}_checkOrderedConsumer(e){let t=this.info.ordered_consumer_sequence,s=e.info.streamSequence,r=e.info.deliverySequence;return r!=t.delivery_seq+1?(this._resetOrderedConsumer(t.stream_seq+1),!1):(t.delivery_seq=r,t.stream_seq=s,!0)}async destroy(){this.isClosed()||await this.drain();let e=this.sub.info,t=e.config.durable_name||e.name,s=`${e.api.prefix}.CONSUMER.DELETE.${e.stream}.${t}`;await e.api._request(s)}async consumerInfo(){let e=this.sub.info,t=e.config.durable_name||e.name,s=`${e.api.prefix}.CONSUMER.INFO.${e.stream}.${t}`,r=await e.api._request(s);return e.last=r,r}}class sj extends sO{constructor(e,t,s){super(e,t,s)}pull(e={batch:1}){let{stream:t,config:s,name:r}=this.sub.info,i=s.durable_name??r,n={};if(n.batch=e.batch||1,n.no_wait=e.no_wait||!1,(e.max_bytes??0)>0){let t=this.js.nc.features.get(x.JS_PULL_MAX_BYTES);if(!t.ok)throw Error(`max_bytes is only supported on servers ${t.min} or better`);n.max_bytes=e.max_bytes}let o=0;e.expires&&e.expires>0&&(o=e.expires,n.expires=eT(o));let a=0;if(e.idle_heartbeat&&e.idle_heartbeat>0&&(a=e.idle_heartbeat,n.idle_heartbeat=eT(a)),a&&0===o)throw Error("idle_heartbeat requires expires");if(a>o)throw Error("expires must be greater than idle_heartbeat");if(this.info){this.monitor&&this.monitor.cancel(),o&&a&&(this.monitor?this.monitor._change(a,o):this._setupHbMonitoring(a,o));let e=this.info.api,s=`${e.prefix}.CONSUMER.MSG.NEXT.${t}.${i}`,r=this.sub.subject;e.nc.publish(s,e.jc.encode(n),{reply:r})}}}function sI(e){if(null!==e)switch(e.code){case n.JetStream404NoMessages:case n.JetStream408RequestTimeout:break;case n.JetStream409:if(e.code===n.JetStream409&&void 0!==[l.MaxBatchExceeded,l.MaxExpiresExceeded,l.MaxBytesExceeded,l.MaxMessageSizeExceeded,l.PushConsumer,l.IdleHeartbeatMissed,l.ConsumerDeleted].find(t=>-1!==e.message.indexOf(t)))return e;break;default:return e}return null}function sN(e){e&&e.ack()}class sM{msg;di;didAck;timeout;constructor(e,t){this.msg=e,this.didAck=!1,this.timeout=t}get subject(){return this.msg.subject}get sid(){return this.msg.sid}get data(){return this.msg.data}get headers(){return this.msg.headers}get info(){return this.di||(this.di=function(e){let t=e.split(".");if(9===t.length&&t.splice(2,0,"_",""),t.length<11||"$JS"!==t[0]||"ACK"!==t[1])throw Error("not js message");let s={};return s.domain="_"===t[2]?"":t[2],s.account_hash=t[3],s.stream=t[4],s.consumer=t[5],s.redeliveryCount=parseInt(t[6],10),s.redelivered=s.redeliveryCount>1,s.streamSequence=parseInt(t[7],10),s.deliverySequence=parseInt(t[8],10),s.timestampNanos=parseInt(t[9],10),s.pending=parseInt(t[10],10),s}(this.reply)),this.di}get redelivered(){return this.info.redeliveryCount>1}get reply(){return this.msg.reply||""}get seq(){return this.info.streamSequence}doAck(e){this.didAck||(this.didAck=!this.isWIP(e),this.msg.respond(e))}isWIP(e){return 4===e.length&&e[0]===sr[0]&&e[1]===sr[1]&&e[2]===sr[2]&&e[3]===sr[3]}async ackAck(e){(e=e||{}).timeout=e.timeout||this.timeout;let t=eN();if(this.didAck)t.resolve(!1);else if(this.didAck=!0,this.msg.reply){let s=this.msg.publisher,r=!s.options?.noAsyncTraces,i=new th(s.muxSubscriptions,this.msg.reply,{timeout:e.timeout},r);s.request(i);try{s.publish(this.msg.reply,st,{reply:`${s.muxSubscriptions.baseInbox}${i.token}`})}catch(e){i.cancel(e)}try{await Promise.race([i.timer,i.deferred]),t.resolve(!0)}catch(e){i.cancel(e),t.reject(e)}}else t.resolve(!1);return t}ack(){this.doAck(st)}nak(e){let t=ss;e&&(t=eB().encode(`-NAK ${JSON.stringify({delay:eT(e)})}`)),this.doAck(t)}working(){this.doAck(sr)}next(e,t={batch:1}){let s={};s.batch=t.batch||1,s.no_wait=t.no_wait||!1,t.expires&&t.expires>0&&(s.expires=eT(t.expires));let r=eD().encode(s),i=e6.concat(si,so,r);this.msg.respond(i,e?{reply:e}:void 0)}term(e=""){let t=sn;e?.length>0&&(t=eB().encode(`+TERM ${e}`)),this.doAck(t)}json(){return this.msg.json()}string(){return this.msg.string()}}class sR{version;lang;closeError;connected;done;socket;options;socketClosed;encrypted;peeked;yields;signal;closedNotification;constructor(){this.version="1.29.2",this.lang="nats.ws",this.connected=!1,this.done=!1,this.socketClosed=!1,this.encrypted=!1,this.peeked=!1,this.yields=[],this.signal=eN(),this.closedNotification=eN()}async connect(e,t){let s=eN();if(t.tls)return s.reject(new ev("tls",n.InvalidOption)),s;this.options=t;let r=e.src;if(t.wsFactory){let{socket:s,encrypted:r}=await t.wsFactory(e.src,t);this.socket=s,this.encrypted=r}else this.encrypted=0===r.indexOf("wss://"),this.socket=new WebSocket(r);return this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{if(this.isDiscarded())return},this.socket.onmessage=e=>{if(this.isDiscarded())return;if(this.yields.push(new Uint8Array(e.data)),this.peeked){this.signal.resolve();return}let r=e6.concat(...this.yields),i=function(e){let t=function(e){for(let t=0;t<e.length;t++){let s=t+1;if(e.byteLength>s&&e[t]===tv&&e[s]===tE)return s+1}return 0}(e);if(t>0){let s=new Uint8Array(e).slice(0,t);return ep.decode(s)}return""}(r);if(""!==i){let e=tq.exec(i);if(!e){t.debug&&console.error("!!!",eO(r)),s.reject(Error("unexpected response from server"));return}try{let t=JSON.parse(e[1]);(function(e,t){let{proto:s,tls_required:r,tls_available:i}=e;if((void 0===s||s<1)&&t.noEcho)throw new ev("noEcho",n.ServerOptionNotAvailable);if(t.tls&&!(r||i))throw new ev("tls",n.ServerOptionNotAvailable)})(t,this.options),this.peeked=!0,this.connected=!0,this.signal.resolve(),s.resolve()}catch(e){s.reject(e);return}}},this.socket.onclose=e=>{let t;!this.isDiscarded()&&(this.socketClosed=!0,this.done||(e.wasClean||(t=Error(e.reason)),this._closed(t)))},this.socket.onerror=e=>{if(this.isDiscarded())return;let t=new ev(e.message,n.Unknown,Error(e.error));s.reject(t)},s}disconnect(){this._closed(void 0,!0)}async _closed(e,t=!0){if(!this.isDiscarded()&&this.connected&&!this.done){if(this.closeError=e,!e)for(;!this.socketClosed&&this.socket.bufferedAmount>0;)await eI(100);this.done=!0;try{this.socket.close(e?1002:1e3,e?e.message:void 0)}catch(e){}t&&this.closedNotification.resolve(e)}}get isClosed(){return this.done}[Symbol.asyncIterator](){return this.iterate()}async *iterate(){for(;;){if(this.isDiscarded())return;0===this.yields.length&&await this.signal;let e=this.yields;this.yields=[];for(let t=0;t<e.length;t++)this.options.debug&&console.info(`> ${eO(e[t])}`),yield e[t];if(this.done)break;0===this.yields.length&&(e.length=0,this.yields=e,this.signal=eN())}}isEncrypted(){return this.connected&&this.encrypted}send(e){if(!this.isDiscarded())try{this.socket.send(e.buffer),this.options.debug&&console.info(`< ${eO(e)}`);return}catch(t){this.options.debug&&console.error(`!!! ${eO(e)}: ${t}`)}}close(e){return this._closed(e,!1)}closed(){return this.closedNotification}isDiscarded(){return!!this.done&&(this.discard(),!0)}discard(){this.done=!0;try{this.socket?.close()}catch(e){}}}function sT(e,t){let s,r;/^(.*:\/\/)(.*)/.test(e)||(e="boolean"==typeof t?`${!0===t?"https":"http"}://${e}`:`https://${e}`);let i=new URL(e),n=i.protocol.toLowerCase();"ws:"===n&&(t=!1),"wss:"===n&&(t=!0),"https:"!==n&&"http"!==n&&(e=e.replace(/^(.*:\/\/)(.*)/gm,"$2"),i=new URL(`http://${e}`));let o=i.hostname,a=i.pathname,c=i.search||"";switch(n){case"http:":case"ws:":case"nats:":r=i.port||"80",s="ws:";break;case"https:":case"wss:":case"tls:":r=i.port||"443",s="wss:";break;default:r=i.port||!0===t?"443":"80",s=!0===t?"wss:":"ws:"}return`${s}//${o}:${r}${a}${c}`}function s$(e={}){return eu={defaultPort:443,urlParseFn:sT,factory:()=>new sR},sA.connect(e)}}}]);